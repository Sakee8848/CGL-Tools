<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>äºšé©¬é€Š CGL æ™ºèƒ½ä½“ - æ——èˆ°åˆè§„ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.5.1/mammoth.browser.min.js"></script>
    <style>
        body {
            background-color: #F5F5F7;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .apple-card {
            background: white;
            border-radius: 28px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.4s ease;
        }

        .log-window {
            background: #1d1d1f;
            color: #00ff00;
            font-family: ui-monospace, monospace;
            font-size: 11px;
            border-radius: 16px;
            padding: 20px;
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const fComm = (val) => {
            if (val === undefined || val === null || isNaN(val)) return "0";
            return new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(val);
        };

        // åˆå§‹åŒ–æ•°æ®åº“ï¼šåŒ…å«æ›´ä¸°å¯Œçš„äº”é‡‘ã€å·¥å…·ä¸é£é™©å“ç±»åº“
        const DEFAULT_DB = [
            // === é«˜é£é™©/æ‹’ä¿ç±» (High Risk / Excluded) ===
            { id: '11213', cat: 'ç„Šæ¥è®¾å¤‡/Welding & Soldering', cls: 'Excluded', rate: 0.05, min: 10000, keywords: 'welder,welding,soldering,plastic welder,arc weld' },
            { id: '10203', cat: 'ç”µæ± /Battery Packs', cls: 'C', rate: 0.012, min: 6500, keywords: 'battery,lithium,power bank,18650' },
            { id: '12240', cat: 'å¤´ç›”/Helmets', cls: 'C', rate: 0.015, min: 8000, keywords: 'helmet,safety hat,protective headwear' },
            { id: '90001', cat: 'å„¿ç«¥ç©å…·/Toys', cls: 'C', rate: 0.010, min: 6000, keywords: 'toy,plush,kids,children,doll' },

            // === Aç±» (è¾ƒé«˜é£é™©/ç”µåŠ¨å·¥å…·/åŠ çƒ­å™¨) ===
            { id: '11113', cat: 'åŠ çƒ­è®¾å¤‡/Heating Equipment', cls: 'A', rate: 0.0035, min: 5500, keywords: 'heater,garage heater,space heater,fireplace,stove' },
            { id: '11209', cat: 'ç”µåŠ¨å·¥å…·/Power Tools', cls: 'A', rate: 0.0030, min: 5000, keywords: 'spray gun,paint sprayer,drill,saw,grinder,sander,power tool' },
            { id: '10406', cat: 'å®¶ç”¨ç”µå™¨(åŠ çƒ­)/Appliances-Heat', cls: 'A', rate: 0.0025, min: 4800, keywords: 'oven,toaster,fryer,kettle,coffee maker' },

            // === Bç±» (æ ‡å‡†é£é™©/æ‰‹åŠ¨å·¥å…·/åŠ³ä¿/æ—¥ç”¨) ===
            { id: '11210', cat: 'æ‰‹åŠ¨å·¥å…·/Hand Tools', cls: 'B', rate: 0.0012, min: 4500, keywords: 'wrench,plier,screwdriver,hammer,tap and die,nut driver,pipe threading,socket set,hex key,allen key,security bit' },
            { id: '10905', cat: 'å·¥ä½œæœä¸åŠ³ä¿/Work Clothes', cls: 'B', rate: 0.0015, min: 4200, keywords: 'glove,work glove,safety vest,apron,uniform' },
            { id: '10137', cat: 'æ±½è½¦é…ä»¶/Auto Parts', cls: 'B', rate: 0.0018, min: 4800, keywords: 'car part,bumper,wiper,filter,mat,automotive' },
            { id: '11114', cat: 'å®¶å±…ç”¨å“/Home Goods', cls: 'B', rate: 0.0008, min: 4000, keywords: 'organizer,storage,shelf,rack,hook,hanger,basket,bin' },
            { id: '12050', cat: 'çººç»‡å“/Textiles', cls: 'B', rate: 0.0009, min: 4000, keywords: 'fabric,cloth,towel,bedding,pillow,curtain' },
            { id: '10000', cat: 'æ™®é€šç™¾è´§/General MDSE', cls: 'B', rate: 0.00065, min: 4200, keywords: 'merchandise,general,gift' }
        ];

        const DEFAULT_COI_RULES = [
            { id: 'limit', label: 'å•æ¬¡äº‹æ•…èµ”ä»˜é™é¢', value: 1000000, unit: 'USD', desc: 'Amazon è¦æ±‚ä¸ä½äº $1M' },
            { id: 'deductible', label: 'å…èµ”é¢ä¸Šé™', value: 10000, unit: 'USD', desc: 'Amazon è¦æ±‚ä¸è¶…è¿‡ $10K' },
            { id: 'holder', label: 'é™„åŠ è¢«ä¿é™©äººæè¿°', value: 'Amazon.com Services LLC. its affiliates and assignees', unit: 'Text', desc: 'å®˜æ–¹æŒ‡å®šæ–‡æœ¬' }
        ];


        function App() {
            const [view, setView] = useState('home');
            const [db, setDb] = useState(() => JSON.parse(localStorage.getItem('cgl_db_v2')) || DEFAULT_DB);
            const [logs, setLogs] = useState(() => JSON.parse(localStorage.getItem('cgl_audit_logs')) || []);
            const [exRate, setExRate] = useState(() => parseFloat(localStorage.getItem('cgl_ex_rate')) || 7.2);

            const [isCustomerMode] = useState(() => new URLSearchParams(window.location.search).get('mode') === 'customer');

            const [revenueRaw, setRevenueRaw] = useState("1,000,000"); // ç”¨æˆ·è¾“å…¥çš„æ€»é¢„ä¼°é”€å”®é¢
            const [merchantResults, setMerchantResults] = useState([]); // åŸå§‹åŒ¹é…åˆ—è¡¨
            const [groupedResults, setGroupedResults] = useState([]); // æŒ‰å“ç±»æ±‡æ€»åçš„ç»“æœ
            const [totalFinalPrem, setTotalFinalPrem] = useState(0);

            const [deductibleType, setDeductibleType] = useState('10000');
            const [modalFile, setModalFile] = useState(null);
            const [lastUploadStats, setLastUploadStats] = useState(null);
            const [coiStep, setCoiStep] = useState('idle');
            const [coiRules, setCoiRules] = useState(() => JSON.parse(localStorage.getItem('cgl_coi_rules')) || DEFAULT_COI_RULES);

            const addLog = (type, detail, snapshot = null) => {
                const entry = { id: Date.now(), time: new Date().toLocaleString(), type, detail, snapshot };
                setLogs(prev => [entry, ...prev].slice(0, 50));
            };

            const getRevenueNum = () => parseFloat(revenueRaw.replace(/,/g, '')) || 0;

            useEffect(() => {
                localStorage.setItem('cgl_db_v2', JSON.stringify(db));
                localStorage.setItem('cgl_audit_logs', JSON.stringify(logs));
                localStorage.setItem('cgl_ex_rate', exRate);
                localStorage.setItem('cgl_coi_rules', JSON.stringify(coiRules));
            }, [db, logs, exRate, coiRules]);

            useEffect(() => {
                if (db.length > 0) {
                    const hasNewRules = db.some(r => r.keywords && r.keywords.includes('welder'));
                    if (!hasNewRules) {
                        console.warn("Detected outdated DB. Forcing update to new DEFAULT_DB...");
                        setDb(DEFAULT_DB);
                        localStorage.setItem('cgl_db_v2', JSON.stringify(DEFAULT_DB));
                        alert("ç³»ç»Ÿå·²è‡ªåŠ¨å‡çº§é£é™©è§„åˆ™åº“ï¼ŒåŒ…å«äº”é‡‘ã€åŠ³ä¿ç­‰æ–°åˆ†ç±»ï¼");
                    }
                }
            }, [db]);

            // ğŸ†• æ’ä»¶è”åŠ¨é€»è¾‘ï¼šæ£€æŸ¥æ˜¯å¦æœ‰æ¥è‡ª Popup çš„å¾…å¤„ç†æ–‡ä»¶
            useEffect(() => {
                if (window.chrome && chrome.storage && chrome.storage.local) {
                    chrome.storage.local.get(['pendingUpload', 'extractedData'], (result) => {
                        // 1. ä¼˜å…ˆå¤„ç†æ–‡ä»¶ä¸Šä¼ 
                        if (result.pendingUpload) {
                            const { name, type, data } = result.pendingUpload;
                            console.log("Received file from extension:", name);

                            addLog('EXT_SYNC', `æ¥æ”¶åˆ°æ’ä»¶åŒæ­¥æ–‡ä»¶: ${name}`);

                            try {
                                if (type === 'xlsx' || type === 'xls') {
                                    // Excel å¤„ç†
                                    const wb = XLSX.read(data.split(',')[1], { type: 'base64' });
                                    const sheetName = wb.SheetNames[0];
                                    const jsonData = XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);
                                    processMerchantReport(jsonData);
                                } else if (type === 'txt' || type === 'csv') {
                                    // æ–‡æœ¬å¤„ç†
                                    const textContent = atob(data.split(',')[1]);
                                    const parsedData = parseTextToData(textContent);
                                    processMerchantReport(parsedData);
                                }

                                setView('merchant'); // åˆ‡æ¢è§†å›¾

                                // æ¸…é™¤æŒ‚èµ·çŠ¶æ€ï¼Œé¿å…é‡å¤åŠ è½½
                                chrome.storage.local.remove('pendingUpload');

                            } catch (err) {
                                console.error("Extension file load error:", err);
                                alert("æ’ä»¶åŒæ­¥æ–‡ä»¶åŠ è½½å¤±è´¥: " + err.message);
                            }
                        }
                        // 2. å¤„ç†é¡µé¢æŠ“å–æ•°æ®
                        else if (result.extractedData) {
                            const { items, extractedAt } = result.extractedData;
                            // æ£€æŸ¥æ˜¯å¦æ˜¯ä¸€åˆ†é’Ÿå†…çš„æ–°æ•°æ®
                            const timeDiff = new Date() - new Date(extractedAt);
                            if (timeDiff < 60000) {
                                console.log("Received scraped data:", items.length);
                                addLog('EXT_XYNC', `æ¥æ”¶åˆ°é¡µé¢æŠ“å–æ•°æ® ${items.length} æ¡`);
                                processMerchantReport(items);
                                setView('merchant');
                                // chrome.storage.local.remove('extractedData'); // æŠ“å–çš„æ•°æ®å¯ä»¥ä¿ç•™ä¾›å‚è€ƒï¼Œæˆ–è€…ä¹Ÿæ¸…é™¤
                            }
                        }
                    });
                }
            }, []);



            // æ ¸å¿ƒå¤„ç†å‡½æ•°ï¼šå¤„ç†ä¸Šä¼ çš„é”€å”®æŠ¥å‘Š
            const processMerchantReport = (data) => {
                const globalRev = getRevenueNum();
                console.group("SKU Matching Debug Log");

                // 1. è¯†åˆ« SKU é£é™©å¹¶å°è¯•æå–é”€å”®æ•°æ®
                const rawMatches = data.map((row, idx) => {
                    const keys = Object.keys(row);
                    const kLow = keys.map(k => k.toLowerCase());

                    // ä¼˜åŒ–ï¼šä¼˜å…ˆåŒ¹é…æ˜ç¡®çš„æè¿°/åç§°åˆ—ï¼Œæ”¯æŒä¸­æ–‡
                    let titleKey = keys.find(k => {
                        const low = k.toLowerCase();
                        return (low.includes('description') || low.includes('name') || low.includes('title') || low.includes('product') ||
                            low.includes('æè¿°') || low.includes('åç§°') || low.includes('å“å') || low.includes('å•†å“'));
                    });

                    // å¦‚æœæ²¡æ‰¾åˆ°æè¿°åˆ—ï¼Œæ‰å°è¯•ç”¨ SKU æˆ–ç¬¬ä¸€åˆ—å…œåº•
                    if (!titleKey) {
                        titleKey = keys.find(k => k.toLowerCase().includes('sku')) || keys[0];
                    }

                    // ä¼˜åŒ–ï¼šæ”¯æŒä¸­æ–‡é”€å”®é¢åˆ—å
                    const salesKey = keys.find(k => {
                        const low = k.toLowerCase();
                        return (low.includes('sales') || low.includes('revenue') || low.includes('amount') || low.includes('total') ||
                            low.includes('price') || low.includes('é”€å”®') || low.includes('é‡‘é¢') || low.includes('ä»·æ ¼'));
                    });

                    const title = row[titleKey] || "æœªçŸ¥å•†å“";
                    const salesValue = parseFloat(String(row[salesKey] || "0").replace(/[^0-9.]/g, '')) || 0;

                    // Debug: æ‰“å°å‰5ä¸ªè¯¦æƒ…
                    if (idx < 5) console.log(`Processing Item [${idx}]:`, title);

                    const match = db.find(d => {
                        const keywords = String(d.keywords || '');
                        const hit = keywords.split(/[,ï¼Œ]/).find(k => {
                            const cleanK = k.trim().toLowerCase();
                            return cleanK && String(title).toLowerCase().includes(cleanK);
                        });

                        // ä¿®æ­£ï¼šå¢åŠ æ—¥å¿—è¾“å‡ºï¼Œç¡®è®¤åŒ¹é…æˆåŠŸ
                        if (hit && idx < 5) console.log(`   âœ… Matched Rule [${d.cat}] using keyword: "${hit}"`);

                        return !!hit;
                    });

                    // å…œåº•é€»è¾‘ï¼šå¦‚æœæ²¡åŒ¹é…ä¸Š
                    if (!match) {
                        // 1. å°è¯•æ‰¾æ•°æ®åº“é‡Œçš„â€œé€šç”¨â€æˆ–â€œå…¶ä»–â€ç±»
                        const genericMatch = db.find(d => {
                            const k = d.keywords?.toLowerCase() || '';
                            const c = d.cat?.toLowerCase() || '';
                            return k.includes('general') || k.includes('other') || k.includes('å…¶ä»–') || k.includes('é€šç”¨') ||
                                c.includes('general') || c.includes('other') || c.includes('å…¶ä»–') || c.includes('é€šç”¨');
                        });

                        // 2. å¦‚æœæ²¡æ‰¾åˆ°é€šç”¨ç±»ï¼Œå°±æ‰¾æ•°æ®åº“é‡Œçš„ç¬¬ä¸€æ¡ä½œä¸ºå…œåº•
                        // (é€šå¸¸ç¬¬ä¸€æ¡æ˜¯è´¹ç‡è¾ƒä½çš„åŸºç¡€ç±»ï¼Œæˆ–è€…ç”¨æˆ·ä¸Šä¼ çš„ç¬¬ä¸€ä¸ªç±»)
                        match = genericMatch || db[0] || { id: '99999', cat: 'æœªè¯†åˆ«åˆ†ç±»/Uncategorized', cls: 'B', rate: 0.001, min: 5000 };

                        if (idx < 5) console.log(`   âš ï¸ No match found. Fallback to: [${match.cat}] (ID: ${match.id})`);
                    }

                    return { title, salesValue, ...match };
                });
                console.groupEnd();

                // 2. æŒ‰å“ç±»(ID)è¿›è¡Œå½’é›†æ±‡æ€»
                const groupsMap = {};
                rawMatches.forEach(item => {
                    if (!groupsMap[item.id]) {
                        groupsMap[item.id] = {
                            id: item.id,
                            cat: item.cat,
                            cls: item.cls,
                            rate: item.rate,
                            min: item.min,
                            itemsCount: 0,
                            excelTotalSales: 0,
                            items: [] // å­˜å‚¨è¯¥åˆ†ç±»ä¸‹çš„æ‰€æœ‰ SKU
                        };
                    }
                    groupsMap[item.id].itemsCount += 1;
                    groupsMap[item.id].excelTotalSales += item.salesValue;
                    groupsMap[item.id].items.push(item);
                });

                // 3. è®¡ç®—æƒé‡å¹¶åˆå§‹åŒ–ç”³æŠ¥é”€å”®é¢
                const totalExcelSales = rawMatches.reduce((sum, item) => sum + item.salesValue, 0);
                const groupsArray = Object.values(groupsMap).map(group => {
                    // å¦‚æœ Excel æ²¡é‡‘é¢ï¼Œåˆ™æŒ‰äº§å“æ•°é‡å¹³å‡åˆ†é…ï¼›å¦‚æœæœ‰é‡‘é¢ï¼ŒæŒ‰æ¯”ä¾‹åˆ†é…
                    const weight = totalExcelSales > 0 ? group.excelTotalSales / totalExcelSales : 1 / Object.keys(groupsMap).length;

                    // é»˜è®¤é€»è¾‘ï¼šå°†ç”¨æˆ·è¾“å…¥çš„æ€»é”€å”®é¢æŒ‰æƒé‡åˆ†é…ç»™å„ç»„
                    // å¦‚æœç”¨æˆ·è¿˜æ²¡æœ‰è¾“å…¥æ€»é”€å”®é¢ï¼Œåˆ™ä½¿ç”¨ Excel æŠ“å–æ€»é¢ä½œä¸ºé»˜è®¤å€¼
                    const allocatedSales = globalRev > 0 ? globalRev * weight : group.excelTotalSales;

                    // åˆå§‹åŒ– declaredSales (å¯ç¼–è¾‘å­—æ®µ)
                    const declaredSales = allocatedSales;

                    const effectiveRate = deductibleType === '0' ? group.rate * 1.2 : group.rate;
                    const effectiveMin = deductibleType === '0' ? group.min * 1.2 : group.min;

                    // é«˜é£é™©/æ‹’ä¿ç±»ç‰¹æ®Šå¤„ç†
                    const isHighRisk = group.cls === 'C' || group.cls === 'Excluded';

                    // å¦‚æœæ˜¯ Excludedï¼Œè´¹ç‡å¯èƒ½æé«˜æˆ–å»ºè®®äººå·¥æ ¸ä¿
                    // è¿™é‡Œä¸ºäº†æ¼”ç¤ºï¼ŒExcluded æŒ‰ rate è®¡ç®—ä½†ä¸å‚ä¸æœ€ä½ä¿è´¹å¯¹å†²ï¼ˆç›¸å¯¹ç‹¬ç«‹ï¼‰
                    let elasticPrem = declaredSales * effectiveRate * exRate;

                    // Excluded ç±»ç›®çš„æœ€ä½ä¿è´¹é€šå¸¸æ˜¯å¼ºåˆ¶çš„ï¼Œä¸”ä¸äº«å—æŠ˜æ‰£
                    const finalGroupPrem = Math.max(elasticPrem, effectiveMin);

                    return {
                        ...group,
                        weight,
                        allocatedSales,
                        declaredSales,
                        effectiveRate,
                        effectiveMin,
                        elasticPrem,
                        finalGroupPrem,
                        isMinApplied: effectiveMin > elasticPrem,
                        isHighRisk, // æ ‡è®°ä¸ºé«˜é£é™©
                        sales: group.excelTotalSales
                    };
                });

                setMerchantResults(rawMatches);
                setGroupedResults(groupsArray);
                setTotalFinalPrem(groupsArray.reduce((sum, g) => sum + g.finalGroupPrem, 0));
            };
            // æ–°å¢: å¤„ç†ç»„é”€å”®é¢ä¿®æ”¹
            const handleGroupSalesChange = (groupId, newVal) => {
                const val = parseFloat(newVal) || 0;
                setGroupedResults(prev => {
                    const newGroups = prev.map(g => {
                        if (g.id === groupId) {
                            const newG = { ...g, declaredSales: val };
                            // é‡æ–°è®¡ç®—è¯¥ç»„ä¿è´¹
                            const effectiveRate = deductibleType === '0' ? newG.rate * 1.2 : newG.rate;
                            const effectiveMin = deductibleType === '0' ? newG.min * 1.2 : newG.min;
                            let prem = val * effectiveRate * exRate;
                            newG.finalGroupPrem = Math.max(prem, effectiveMin);
                            newG.isMinApplied = effectiveMin > prem;
                            return newG;
                        }
                        return g;
                    });
                    // æ›´æ–°æ€»ä¿è´¹
                    setTotalFinalPrem(newGroups.reduce((sum, g) => sum + g.finalGroupPrem, 0));
                    return newGroups;
                });
            };


            const handleMerchantUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const fileName = file.name;
                const fileExt = fileName.split('.').pop().toLowerCase();

                try {
                    if (fileExt === 'xlsx' || fileExt === 'xls' || fileExt === 'csv') {
                        // Excel/CSV å¤„ç†
                        const reader = new FileReader();
                        reader.onload = (evt) => {
                            try {
                                const wb = XLSX.read(evt.target.result, { type: 'binary' });
                                const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                                processMerchantReport(data);
                            } catch (err) { alert("Excel è§£æå¤±è´¥"); }
                        };
                        reader.readAsBinaryString(file);

                    } else if (fileExt === 'txt') {
                        // TXT æ–‡æœ¬å¤„ç†
                        const text = await file.text();
                        const parsedData = parseTextToData(text);
                        processMerchantReport(parsedData);

                    } else if (fileExt === 'pdf') {
                        // PDF å¤„ç†
                        const loadingTask = pdfjsLib.getDocument(URL.createObjectURL(file));
                        const pdf = await loadingTask.promise;
                        let fullText = '';
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const content = await page.getTextContent();
                            fullText += content.items.map(item => item.str).join(' ') + '\n';
                        }
                        const parsedData = parseTextToData(fullText);
                        processMerchantReport(parsedData);

                    } else if (fileExt === 'docx' || fileExt === 'doc') {
                        // Word æ–‡æ¡£å¤„ç†
                        const arrayBuffer = await file.arrayBuffer();
                        const result = await mammoth.extractRawText({ arrayBuffer });
                        const parsedData = parseTextToData(result.value);
                        processMerchantReport(parsedData);

                    } else {
                        alert("ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼\n\nè¯·ä¸Šä¼ ï¼šExcel (.xlsx/.xls)ã€CSVã€TXTã€PDF æˆ– Word (.docx)");
                    }
                } catch (err) {
                    console.error('æ–‡ä»¶è§£æé”™è¯¯:', err);
                    alert("æ–‡ä»¶è§£æå¤±è´¥: " + err.message);
                }
            };

            // æ–°å¢ï¼šä»æ–‡æœ¬ä¸­è§£ææ•°æ®çš„è¾…åŠ©å‡½æ•° (å‡çº§ä¸ºæ­£åˆ™æ™ºèƒ½åŒ¹é…æ¨¡å¼)
            const parseTextToData = (text) => {
                const lines = text.split('\n').filter(line => line.trim());
                const parsedData = [];
                let matchCount = 0;

                lines.forEach(line => {
                    // é¢„å¤„ç†ï¼šå»æ‰ä¸¤ç«¯ç©ºæ ¼
                    const content = line.trim();
                    if (!content) return;

                    let description = '';
                    let sales = 0;

                    // ç­–ç•¥ 1: Tab åˆ†éš”ç¬¦ (Excel copy-paste æˆ– TSV æ ¼å¼)
                    // è¿™æ˜¯æœ€å‡†ç¡®çš„ï¼Œé€šå¸¸ç¬¬ä¸€åˆ—æˆ–æœ€é•¿çš„ä¸€åˆ—æ˜¯åç§°
                    if (content.includes('\t')) {
                        const parts = content.split('\t');
                        // æ‰¾æœ€é•¿çš„ä¸€æ®µæ–‡æœ¬ï¼Œå¤§æ¦‚ç‡æ˜¯äº§å“æè¿°
                        description = parts.reduce((a, b) => a.length > b.length ? a : b, '');

                        // æ‰¾çœ‹èµ·æ¥åƒé‡‘é¢çš„åˆ—
                        const moneyPart = parts.find(p => /[\$Â¥ï¿¥]?\s?[0-9,]+\.\d{2}/.test(p) || (p.match(/[0-9]/) && p.length < 10));
                        if (moneyPart) {
                            sales = parseFloat(moneyPart.replace(/[^0-9.]/g, '')) || 0;
                        }
                    }
                    // ç­–ç•¥ 2: å•çº¯çš„é•¿æ–‡æœ¬è¡Œ (é€šå¸¸æ˜¯äº§å“åˆ—è¡¨)
                    else {
                        // å¦‚æœè¿™ä¸€è¡ŒåŒ…å«é‡‘é¢æ ¼å¼ï¼Œå°è¯•åˆ†å‰²
                        const salesMatch = content.match(/[\t\s]+[\$Â¥ï¿¥]?([0-9,]+\.?\d*)$/); // åŒ¹é…æœ«å°¾çš„é‡‘é¢

                        if (salesMatch) {
                            sales = parseFloat(salesMatch[1].replace(/,/g, '')) || 0;
                            description = content.replace(salesMatch[0], '').trim();
                        } else {
                            // å¦åˆ™ï¼Œæ•´è¡Œéƒ½æ˜¯æè¿°ï¼ä¸è¦è‡ªä½œèªæ˜å»æå– SKU
                            description = content;
                        }
                    }

                    // è¿‡æ»¤æ‰å¤ªçŸ­çš„æ— æ„ä¹‰è¡Œ (æ¯”å¦‚é¡µç ã€è¡¨å¤´)
                    if (description.length > 3 && !['description', 'product', 'sales', 'sku'].includes(description.toLowerCase())) {
                        parsedData.push({
                            'Product Description': description,
                            'Sales': sales
                        });
                        matchCount++;
                    }
                });

                if (parsedData.length === 0) {
                    alert("âš ï¸ æœªèƒ½ä»æ–‡ä»¶ä¸­è¯†åˆ«å‡ºæœ‰æ•ˆæ•°æ®\n\nè¯·ç¡®ä¿æ–‡ä»¶ä¸­åŒ…å« SKU (å¦‚ B08N5WRWNW) æˆ– å•†å“å+é‡‘é¢");
                } else {
                    console.log(`âœ… æ™ºèƒ½æ–‡æœ¬è§£ææˆåŠŸ: æå–åˆ° ${parsedData.length} æ¡æ•°æ®`);
                }

                return parsedData;
            };


            const handleAdminUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const wb = XLSX.read(evt.target.result, { type: 'binary' });
                        // 1. è¯»å–ä¸º JSON å¯¹è±¡æ•°ç»„ï¼Œä¸å†ä¾èµ–å›ºå®šè¡Œå·
                        const rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

                        if (!rawData || rawData.length === 0) {
                            alert("æœªåœ¨ Excel ä¸­æ‰¾åˆ°æœ‰æ•ˆæ•°æ®");
                            return;
                        }

                        // 2. æ™ºèƒ½è¯†åˆ«åˆ—åï¼ˆå–ç¬¬ä¸€è¡Œæ•°æ®çš„ key åšæ¢æµ‹ï¼‰
                        const sampleRow = rawData[0];
                        const keys = Object.keys(sampleRow);
                        const kLow = keys.map(k => k.toLowerCase());

                        // è¾…åŠ©å‡½æ•°ï¼šæŸ¥æ‰¾åŒ¹é…çš„ Keyï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰
                        const findKey = (patterns) => keys.find(k => patterns.some(p => k.toLowerCase().includes(p)));

                        const keyMap = {
                            id: findKey(['code', 'sku', 'id', 'ä»£ç ', 'ç¼–ç ', 'åºå·']),
                            cat: findKey(['cat', 'name', 'desc', 'type', 'åˆ†ç±»', 'åç§°', 'å“ç±»', 'description']),
                            cls: findKey(['class', 'level', 'risk', 'çº§åˆ«', 'é£é™©', 'ç­‰çº§']),
                            rate: findKey(['rate', 'prem', 'è´¹ç‡', 'ä»·æ ¼', 'ç‚¹ä½']),
                            min: findKey(['min', 'floor', 'æœ€ä½', 'èµ·æ­¥']),
                            // å…³é”®ï¼šå°è¯•æ‰¾ä¸“é—¨çš„å…³é”®è¯åˆ—ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåç»­ä¼šç”¨ cat å¡«å……
                            keywords: findKey(['keyword', 'tag', 'match', 'å…³é”®è¯', 'åŒ¹é…', 'description'])
                        };

                        console.log("è¯†åˆ«åˆ°çš„åˆ—æ˜ å°„:", keyMap);

                        // 3. æ„å»ºæ ‡å‡†æ•°æ®åº“ç»“æ„
                        const newDb = rawData.map(r => {
                            const catName = r[keyMap.cat] || 'æœªå‘½ååˆ†ç±»';
                            let keywords = r[keyMap.keywords];

                            // å¦‚æœæ²¡æœ‰ä¸“é—¨çš„ keywords åˆ—ï¼Œæˆ–è€… keywords ä¸ºç©ºï¼Œå°±ä½¿ç”¨åˆ†ç±»åç§°ä½œä¸ºå…³é”®è¯
                            // å¹¶è¿›è¡Œç®€å•çš„åˆ†è¯å¤„ç†ï¼Œå¢åŠ åŒ¹é…æ¦‚ç‡
                            if (!keywords) {
                                // ç§»é™¤æ‹¬å·å†…å®¹ï¼Œå¦‚ "Hand Tools (æ‰‹åŠ¨å·¥å…·)" -> "Hand Tools æ‰‹åŠ¨å·¥å…·"
                                keywords = String(catName).replace(/[()ï¼ˆï¼‰]/g, ' ').replace(/\//g, ' ');
                            } else {
                                keywords = String(keywords);
                            }

                            return {
                                id: String(r[keyMap.id] || Math.floor(Math.random() * 100000)),
                                cat: catName,
                                cls: r[keyMap.cls] || 'B', // é»˜è®¤ä¸º B ç±»
                                rate: parseFloat(String(r[keyMap.rate] || '0').replace(/%/, '')) / (String(r[keyMap.rate]).includes('%') ? 100 : 1) || 0.00065,
                                min: parseFloat(String(r[keyMap.min] || '0').replace(/[^0-9.]/g, '')) || 4500,
                                keywords: keywords
                            };
                        }).filter(item => item.id && item.cat); // è¿‡æ»¤æ— æ•ˆè¡Œ

                        if (newDb.length > 0) {
                            setDb(newDb);
                            setLastUploadStats({ count: newDb.length, fileName: file.name, time: new Date().toLocaleString() });
                            addLog('è´¹ç‡åº“æ›´æ–°', `ç®¡ç†å‘˜ä¸Šä¼ äº†æŠ¥ä»·è¡¨: ${file.name} (å…± ${newDb.length} æ¡)`, newDb.slice(0, 3));
                            alert(`âœ… è§„åˆ™å·²æ›´æ–° (${newDb.length} æ¡)\nç³»ç»Ÿå·²åŸºäºåˆ—åè‡ªåŠ¨è¯†åˆ«è§„åˆ™ï¼Œå¹¶æå–ç±»ç›®åç§°ä½œä¸ºåŒ¹é…å…³é”®è¯ã€‚`);
                        } else {
                            alert("æœªèƒ½è§£æå‡ºæœ‰æ•ˆè§„åˆ™ï¼Œè¯·æ£€æŸ¥è¡¨å¤´åã€‚");
                        }
                    } catch (err) {
                        console.error(err);
                        alert("Excel è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ã€‚");
                    }
                };
                reader.readAsBinaryString(file);
            };

            const extractRequirementsFromText = (text) => {
                const limitMatch = text.match(/(?:limit|occurrence)[^$0-9]*\$?\s?([\d,]{5,})/i);
                const dedMatch = text.match(/(?:deductible|retention)[^$0-9]*\$?\s?([\d,]{1,5})/i);
                const holderMatch = text.match(/Amazon\.com Services LLC/i);

                return [
                    { id: 'limit', label: 'å•æ¬¡äº‹æ•…èµ”ä»˜é™é¢', value: limitMatch ? parseInt(limitMatch[1].replace(/,/g, '')) : 1000000, unit: 'USD', desc: 'Auto-extracted from document' },
                    { id: 'deductible', label: 'å…èµ”é¢ä¸Šé™', value: dedMatch ? parseInt(dedMatch[1].replace(/,/g, '')) : 10000, unit: 'USD', desc: 'Auto-extracted from document' },
                    { id: 'holder', label: 'é™„åŠ è¢«ä¿é™©äººæè¿°', value: holderMatch ? "Amazon.com Services LLC. its affiliates and assignees" : 'æœªè¯†åˆ«åˆ°ç²¾ç¡®æŠ¬å¤´', unit: 'Text', desc: 'Auto-extracted from document' }
                ];
            };

            const handleCoiRulesUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const ext = file.name.split('.').pop().toLowerCase();
                let extractedText = "";

                try {
                    if (ext === 'xlsx' || ext === 'xls' || ext === 'csv') {
                        const reader = new FileReader();
                        reader.onload = (evt) => {
                            const wb = XLSX.read(evt.target.result, { type: 'binary' });
                            const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                            if (data.length > 0) {
                                setCoiRules(data);
                                addLog('COIè§„åˆ™æ›´æ–°', `ç®¡ç†å‘˜ä¸Šä¼  Excel æ ‡å‡†: ${file.name}`, data);
                                alert(`âœ… COI å®¡æ ¸æ ‡å‡†å·²é€šè¿‡ Excel æ›´æ–°`);
                            }
                        };
                        reader.readAsBinaryString(file);
                        return;
                    }

                    if (ext === 'pdf') {
                        const loadingTask = pdfjsLib.getDocument(URL.createObjectURL(file));
                        const pdf = await loadingTask.promise;
                        let fullText = "";
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const content = await page.getTextContent();
                            fullText += content.items.map(item => item.str).join(' ');
                        }
                        extractedText = fullText;
                    } else if (ext === 'docx') {
                        const arrayBuffer = await file.arrayBuffer();
                        const result = await mammoth.extractRawText({ arrayBuffer });
                        extractedText = result.value;
                    } else if (ext === 'txt') {
                        extractedText = await file.text();
                    } else {
                        alert("ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼");
                        return;
                    }

                    if (extractedText) {
                        const newRules = extractRequirementsFromText(extractedText);
                        setCoiRules(newRules);
                        addLog('COIè§„åˆ™æ›´æ–°', `åŸºäº AI/Regex ä» ${ext.toUpperCase()} æ–‡æ¡£æå–æ ‡å‡†: ${file.name}`, newRules);
                        alert(`âœ… å·²ä» ${ext.toUpperCase()} æ–‡æ¡£æˆåŠŸæå–åˆ¤å®šé€»è¾‘`);
                    }

                } catch (err) {
                    console.error(err);
                    alert("æ–‡æ¡£è§£æå¤±è´¥: " + err.message);
                }
            };

            const downloadDistributionFile = async () => {
                try {
                    const response = await fetch(window.location.href);
                    const sourceHtml = await response.text();

                    const frozenDb = JSON.stringify(db);
                    const frozenCoi = JSON.stringify(coiRules);
                    const frozenEx = exRate.toString();

                    let distHtml = sourceHtml
                        .replace(/const DEFAULT_DB = \[.*?\];/s, `const DEFAULT_DB = ${frozenDb};`)
                        .replace(/const DEFAULT_COI_RULES = \[.*?\];/s, `const DEFAULT_COI_RULES = ${frozenCoi};`)
                        .replace(/parseFloat\(localStorage\.getItem\('cgl_ex_rate'\)\) \|\| 7.2/, `${frozenEx}`)
                        .replace(/const \[isCustomerMode\] = useState\(.*?\);/, `const [isCustomerMode] = useState(true);`);

                    const blob = new Blob([distHtml], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `CGL_Compliance_Tool_${new Date().toISOString().split('T')[0]}.html`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    addLog('å¯¼å‡ºåˆ†å‘', 'æˆåŠŸç”Ÿæˆäº†ç¡¬ç¼–ç è´¹ç‡çš„å®¢æˆ·è„±æœºç‰ˆã€‚');
                } catch (err) {
                    alert("å¯¼å‡ºå¤±è´¥ï¼Œè¯·å°è¯•åœ¨æœåŠ¡å™¨ç¯å¢ƒä¸‹è¿è¡Œï¼ˆå¦‚ Netlify/Vercelï¼‰ï¼š" + err.message);
                }
            };

            return (
                <div className="min-h-screen relative no-scrollbar">
                    <nav className="p-6 bg-white border-b sticky top-0 z-40 flex justify-between items-center px-12">
                        <div className="flex items-center gap-4 cursor-pointer" onClick={() => setView('home')}>
                            <h1 className="text-xl font-bold tracking-tight text-gray-900">
                                {isCustomerMode ? 'æŠ¥ä»·åˆè§„ä¸­å¿ƒ' : 'äºšé©¬é€Š CGL æ™ºèƒ½ä½“'}
                            </h1>
                        </div>
                        <div className="flex gap-8">
                            {!isCustomerMode && <button onClick={() => setView('admin')} className="text-xs font-bold text-gray-400 hover:text-blue-600 uppercase tracking-[0.2em]">Admin Portal</button>}
                        </div>
                    </nav>

                    <main className="max-w-6xl mx-auto p-12">
                        {view === 'home' && (
                            <div className="py-20 space-y-24 animate-in fade-in duration-1000">
                                <div className="space-y-6 text-center">
                                    <h2 className="text-8xl font-black tracking-tighter leading-[0.8] mb-8">
                                        {isCustomerMode ? 'åˆè§„åˆ›é€ ä»·å€¼' : 'åˆ†å“ç±»è®¡è´¹'}<br />
                                        <span className="text-blue-600">{isCustomerMode ? 'ä¸“ä¸šçš„åˆè§„æŠ¥ä»·' : 'æ›´ä¸“ä¸šçš„å¯¹å†²'}</span>
                                    </h2>
                                    <p className="text-xl text-gray-400 max-w-2xl mx-auto font-medium">
                                        {isCustomerMode ? 'è¯·ä¸Šä¼ æ‚¨çš„é”€å”®æŠ¥å‘Šï¼Œæˆ‘ä»¬å°†ä¸ºæ‚¨æ ¸ç®—ç²¾å‡†çš„ä¿è´¹é¢„ä¼°å¹¶æ ¸å¯¹ä¿å•åˆè§„æ€§ã€‚' : 'æ”¯æŒæŒ‰é£é™©å“ç±»è‡ªåŠ¨æ±‡æ€»é”€å”®é¢ï¼Œç‹¬ç«‹è®¡ç®—æœ€ä½ä¿è´¹ä¸å¼¹æ€§è´¹ç‡ã€‚'}
                                    </p>
                                </div>
                                <div className="grid md:grid-cols-2 gap-10">
                                    <div onClick={() => setView('merchant')} className="apple-card p-16 cursor-pointer group hover:bg-white/80">
                                        <div className="text-5xl mb-10 group-hover:scale-110 transition-transform">ğŸ“Š</div>
                                        <h3 className="text-3xl font-black mb-4 tracking-tight">æ™ºèƒ½æŠ¥ä»·åˆ†æ</h3>
                                        <p className="text-gray-400 leading-relaxed font-medium">ä¸Šä¼ é”€å”®æŠ¥å‘Šï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æ ¸ç®—æœ€ä¼˜ä¿è´¹æ–¹æ¡ˆã€‚</p>
                                    </div>
                                    <div onClick={() => setView('coi')} className="apple-card p-16 cursor-pointer group">
                                        <div className="text-5xl mb-10 group-hover:scale-110 transition-transform">ğŸ›¡ï¸</div>
                                        <h3 className="text-3xl font-black mb-4 tracking-tight">COI å‡­è¯é¢„å®¡</h3>
                                        <p className="text-gray-400 leading-relaxed font-medium">AI æ‰«æä¿å•ï¼Œæ ¸å¯¹äºšé©¬é€Š $1,000,000 å¼ºåˆ¶é™é¢è¦æ±‚ã€‚</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === 'merchant' && (
                            <div className="space-y-10 animate-in fade-in duration-700">
                                <button onClick={() => setView('home')} className="text-blue-600 font-bold text-sm">â† è¿”å›ä¸»é¡µå¯¼èˆª</button>

                                <div className="apple-card p-12 space-y-12">
                                    <div className="grid md:grid-cols-3 gap-8">
                                        <div className="md:col-span-2 space-y-4">
                                            <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-1">å…¨è´¦æˆ·é¢„è®¡å¹´åº¦æ€»é”€å”®é¢ (Annual USD Revenue)</label>
                                            <div className="relative">
                                                <span className="absolute left-6 top-1/2 -translate-y-1/2 text-gray-300 font-bold text-3xl">$</span>
                                                <input type="text" className="w-full pl-16 pr-8 py-6 rounded-[28px] bg-gray-50 border-none font-black text-4xl text-gray-900 focus:bg-white outline-none transition-all" value={revenueRaw} onChange={e => setRevenueRaw(fComm(e.target.value.replace(/[^0-9]/g, '')))} />
                                            </div>
                                        </div>
                                        <div className="space-y-4">
                                            <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-1">å…èµ”é¢æ§åˆ¶ (Deductible)</label>
                                            <select className="w-full p-6 h-[88px] rounded-[28px] bg-gray-50 border-none font-black text-xl text-gray-900 focus:bg-white appearance-none cursor-pointer outline-none transition-all" value={deductibleType} onChange={e => setDeductibleType(e.target.value)}>
                                                <option value="10000">10,000 ç¾é‡‘ (æ ‡å‡†)</option>
                                                <option value="0">æ— å…èµ” (Nil)</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div className="border-2 border-dashed border-gray-100 rounded-[40px] p-20 text-center hover:bg-blue-50/20 hover:border-blue-400 transition-all relative group bg-gray-50/30">
                                        <input type="file" accept=".xlsx,.xls,.csv,.txt,.pdf,.docx,.doc" className="absolute inset-0 opacity-0 cursor-pointer z-10" onChange={handleMerchantUpload} />
                                        <div className="space-y-4">
                                            <div className="text-5xl group-hover:scale-110 transition-transform">ğŸ“„</div>
                                            <h4 className="text-xl font-black">ä¸Šä¼  SKU è¯¦æƒ…æŠ¥å‘Š</h4>
                                            <p className="text-gray-400 font-medium italic">æ”¯æŒ Excelã€CSVã€TXTã€PDFã€Word ç­‰æ ¼å¼</p>
                                        </div>
                                    </div>

                                    {groupedResults.length > 0 && (
                                        <div className="space-y-12 animate-in slide-in-from-bottom-6 duration-700">
                                            <div className="relative group">
                                                <div className="absolute -inset-1 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-[48px] blur-2xl opacity-20"></div>
                                                <div className="relative bg-[#1d1d1f] p-12 rounded-[48px] text-white flex flex-col md:flex-row justify-between items-center gap-12 border border-white/5">
                                                    <div className="space-y-4 flex-1">
                                                        <div className="inline-block px-3 py-1 bg-blue-500/20 text-blue-400 text-[10px] font-black rounded-full uppercase tracking-widest">Aggregate Annual Premium (RMB)</div>
                                                        <div className="flex items-baseline gap-3">
                                                            <span className="text-4xl font-bold text-white/40">Â¥</span>
                                                            <span className="text-[100px] font-black leading-none tracking-tighter tabular-nums">{fComm(totalFinalPrem)}</span>
                                                        </div>
                                                        <div className="text-white/40 font-bold text-sm bg-white/5 p-4 rounded-2xl flex items-center gap-3">
                                                            <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                                                            è®¡è´¹é€»è¾‘ï¼šå·²å®Œæˆ {groupedResults.length} ä¸ªé£é™©ç¾¤ç»„çš„ç‹¬ç«‹é˜ˆå€¼è®¡ç®—å¹¶å®Œæˆæ€»å’Œç´¯åŠ ã€‚
                                                        </div>
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-4 min-w-[340px]">
                                                        <div className="bg-white/5 p-6 rounded-[32px] border border-white/5 text-center">
                                                            <p className="text-[9px] text-white/40 font-bold uppercase mb-2">ç»“ç®—æ±‡ç‡</p>
                                                            <p className="text-2xl font-black">{exRate}</p>
                                                        </div>
                                                        <div className="bg-white/5 p-6 rounded-[32px] border border-white/5 text-center">
                                                            <p className="text-[9px] text-white/40 font-bold uppercase mb-2">ç±»ç›®æ€»æ•°</p>
                                                            <p className="text-2xl font-black">{groupedResults.length}</p>
                                                        </div>
                                                        <div className="col-span-2 bg-blue-600/10 p-6 rounded-[32px] border border-blue-500/20 text-center">
                                                            <p className="text-[9px] text-blue-400 font-bold uppercase mb-2">å…èµ”è®¾ç½®</p>
                                                            <p className="text-lg font-black uppercase text-blue-100">{deductibleType === '0' ? 'Nil (1.2x Uplift)' : 'USD 10K (Standard)'}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>



                                            {/* æ–°å¢: é£é™©åˆ†ç±»æ±‡æ€»ä¸ç”³æŠ¥å¡ç‰‡åŒº */}
                                            <div className="space-y-6 pt-12 border-t border-gray-100">
                                                <div className="flex items-center justify-between pb-4">
                                                    <div>
                                                        <h4 className="text-xl font-black text-gray-900 tracking-tight">é£é™©åˆ†ç±»è¯¦æƒ…ä¸ç”³æŠ¥ (Submission Details)</h4>
                                                        <p className="text-xs text-gray-400 font-medium mt-1">è¯·æ ¸å¯¹å„å¤§ç±»ç”³æŠ¥é”€å”®é¢ï¼Œç³»ç»Ÿå°†åŸºäºç”³æŠ¥é¢é‡æ–°è®¡ç®—ä¿è´¹</p>
                                                    </div>
                                                    <span className="text-xs font-bold text-gray-400 uppercase tracking-widest bg-gray-50 px-3 py-1 rounded-full">Automated Analysis</span>
                                                </div>

                                                <div className="space-y-4">
                                                    {groupedResults.map((group) => {
                                                        const isHighRisk = group.cls === 'C' || group.cls === 'Excluded';

                                                        return (
                                                            <div key={group.id} className={`bg-white rounded-[24px] border ${isHighRisk ? 'border-red-200 bg-red-50/10' : 'border-gray-100'} overflow-hidden shadow-sm hover:shadow-md transition-all duration-300`}>
                                                                {/* å¡ç‰‡å¤´éƒ¨ */}
                                                                <div className="p-6 flex flex-col md:flex-row gap-6 md:items-center justify-between">
                                                                    {/* å·¦ä¾§ï¼šåˆ†ç±»ä¿¡æ¯ */}
                                                                    <div className="flex items-center gap-4 min-w-[300px]">
                                                                        <div className={`w-12 h-12 rounded-2xl flex items-center justify-center text-2xl font-black ${isHighRisk ? 'bg-red-100 text-red-600' : 'bg-blue-50 text-blue-600'}`}>
                                                                            {group.cls}
                                                                        </div>
                                                                        <div>
                                                                            <div className="flex items-center gap-2">
                                                                                <h5 className="font-bold text-gray-900">{group.cat}</h5>
                                                                                {isHighRisk && <span className="text-[10px] bg-red-600 text-white px-2 py-0.5 rounded-full font-bold">HIGH RISK</span>}
                                                                            </div>
                                                                            <p className="text-xs text-gray-400 font-medium mt-1">åŒ…å« {group.items?.length || 0} ä¸ª SKU Â· é£é™©è´¹ç‡ {group.rate}%</p>
                                                                        </div>
                                                                    </div>

                                                                    {/* ä¸­é—´ï¼šé”€å”®é¢ç”³æŠ¥ */}
                                                                    <div className="flex-1 min-w-[200px]">
                                                                        <label className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block">è¯¥ç±»ç›®ç”³æŠ¥é”€å”®é¢ (USD)</label>
                                                                        <div className="relative group/input">
                                                                            <span className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold">$</span>
                                                                            <input
                                                                                type="text"
                                                                                className="w-full pl-8 pr-4 py-3 bg-gray-50 border-transparent rounded-xl text-gray-900 font-bold focus:bg-white focus:ring-2 focus:ring-blue-500 transition-all text-right"
                                                                                value={fComm(group.declaredSales)}
                                                                                onChange={(e) => handleGroupSalesChange(group.id, e.target.value.replace(/[^0-9.]/g, ''))}
                                                                            />
                                                                            <div className="absolute right-0 -bottom-5 text-[10px] text-gray-400 opacity-0 group-hover/input:opacity-100 transition-opacity">
                                                                                ExcelæŠ“å–æ€»é¢: ${fComm(group.sales)}
                                                                            </div>
                                                                        </div>
                                                                    </div>

                                                                    {/* å³ä¾§ï¼šè®¡ç®—ç»“æœ */}
                                                                    <div className="text-right min-w-[150px]">
                                                                        <label className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block">é¢„ä¼°ä¿è´¹ (CNY)</label>
                                                                        <div className="text-2xl font-black text-gray-900 flex items-center justify-end gap-1">
                                                                            <span className="text-sm text-gray-300">Â¥</span>
                                                                            {fComm(group.finalGroupPrem)}
                                                                        </div>
                                                                        {group.isMinApplied && <span className="text-[10px] text-orange-500 font-bold bg-orange-50 px-2 rounded-full">å·²åº”ç”¨æœ€ä½ä¿è´¹</span>}
                                                                    </div>
                                                                </div>

                                                                {/* æŠ˜å åŒºåŸŸï¼šSKU æ˜ç»† */}
                                                                <details className="border-t border-gray-50 group/details">
                                                                    <summary className="p-4 flex items-center justify-center cursor-pointer hover:bg-gray-50 transition-colors text-xs font-bold text-gray-400 uppercase tracking-widest select-none list-none">
                                                                        <span className="group-open/details:hidden">æŸ¥çœ‹ SKU æ˜ç»† ({group.items?.length}) â–¼</span>
                                                                        <span className="hidden group-open/details:block">æ”¶èµ·æ˜ç»† â–²</span>
                                                                    </summary>
                                                                    <div className="p-6 bg-gray-50/50 space-y-2">
                                                                        {group.items?.map((item, idx) => (
                                                                            <div key={idx} className="flex justify-between items-center text-sm py-2 border-b border-gray-100 last:border-0 border-dashed">
                                                                                <div className="flex flex-col max-w-[70%]">
                                                                                    <span className="text-[10px] font-black text-gray-400 uppercase">{item.id}</span>
                                                                                    <span className="text-gray-600 font-medium truncate">{item.title}</span>
                                                                                </div>
                                                                                <span className="text-gray-400 font-mono">${fComm(item.salesValue)}</span>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                </details>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                            <div className="pt-12 border-t space-y-4">
                                                <h5 className="text-sm font-black text-gray-400 uppercase tracking-widest px-4">äº§å“åˆ†ç±»ä¸é£é™©åŒ¹é…æ˜ç»† (Detailed Risk Classification)</h5>
                                                <div className="max-h-[500px] overflow-y-auto custom-scrollbar border rounded-[24px] bg-white shadow-inner">
                                                    <table className="w-full text-xs text-left border-collapse">
                                                        <thead className="sticky top-0 bg-gray-100/90 backdrop-blur z-10 border-b border-gray-200 shadow-sm">
                                                            <tr>
                                                                <th className="p-4 font-black text-gray-500 uppercase tracking-tight text-[10px] w-12 text-center">SKU</th>
                                                                <th className="p-4 font-black text-gray-500 uppercase tracking-tight text-[10px] w-1/4">Product Description (ç®€è¿°)</th>
                                                                <th className="p-4 font-black text-gray-500 uppercase tracking-tight text-[10px]">Suggested Category</th>
                                                                <th className="p-4 font-black text-gray-500 uppercase tracking-tight text-[10px] w-20 text-center">Risk Code</th>
                                                                <th className="p-4 font-black text-gray-500 uppercase tracking-tight text-[10px] w-16 text-center">Class</th>
                                                                <th className="p-4 font-black text-gray-500 uppercase tracking-tight text-[10px] w-20 text-center">Status</th>
                                                                <th className="p-4 font-black text-gray-500 uppercase tracking-tight text-[10px] w-1/4">Reason (åŒ¹é…ä¸é£é™©åˆ†æ)</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody className="divide-y divide-gray-100">
                                                            {(() => {
                                                                let lastCatId = null; // Track previous category to handle "Idem"

                                                                // Professional Risk Analysis Database (Expert Knowledge Base)
                                                                const RISK_KB = {
                                                                    '11213': 'é«˜å±ç„Šæ¥ä½œä¸šé£é™©ï¼šæ¶‰åŠé«˜æ¸©ç†”èé‡‘å±ä¸é«˜ç”µå‹ï¼Œææ˜“å¼•å‘ä¸¥é‡çƒ§ä¼¤ã€ç«ç¾åŠçƒŸå°˜å¸å…¥ä¼¤å®³ã€‚å†å²é‡æ¡ˆå¤šæ¶‰åŠè®¾å¤‡æ¼ç”µå¯¼è‡´æ“ä½œå·¥ç”µå‡»èº«äº¡ï¼Œæˆ–ç«èŠ±å¼•ç‡ƒå‘¨è¾¹æ˜“ç‡ƒç‰©å¯¼è‡´å‚æˆ¿æŸæ¯ã€‚å±äºä¸¥æ ¼æ‰¿ä¿é™åˆ¶ç±»ç›®ã€‚',
                                                                    '10203': 'é”‚ç”µçƒ­å¤±æ§é£é™©ï¼š18650/èšåˆç‰©ç”µæ± åœ¨è¿‡å……ã€ç©¿åˆºæˆ–é«˜æ¸©ä¸‹ææ˜“å‘ç”Ÿå‰§çƒˆç‡ƒçƒ§çˆ†ç‚¸ã€‚æ ¹æ® CPSC æ•°æ®ï¼Œç§»åŠ¨ç”µæºå¼•å‘çš„ç«ç¾é€ æˆçš„äººèº«ä¼¤å®³ç´¢èµ”å¹³å‡èµ”ä»˜é¢æé«˜ï¼Œä¸”æ¶‰åŠèˆªè¿ä¸ä»“å‚¨ç´¯ç§¯é£é™©ã€‚',
                                                                    '12240': 'å¤´éƒ¨é˜²æŠ¤å¤±æ•ˆé£é™©ï¼šå¤´ç›”è‹¥ä¸ç¬¦åˆ ANSI/DOT å†²å‡»æ ‡å‡†ï¼Œåœ¨äº‹æ•…ä¸­ç¢è£‚å°†å¯¼è‡´ä¸¥é‡çš„é¢…è„‘æŸä¼¤ï¼ˆTBIï¼‰ã€‚æ­¤ç±»äº§å“è´£ä»»é™©æ ¸å¿ƒå…³æ³¨â€œè®¾è®¡ç¼ºé™·â€æŒ‡æ§ï¼Œä¸€æ—¦é˜²æŠ¤å¤±è´¥ï¼Œé€šå¸¸é¢ä¸´ç™¾ä¸‡ç¾å…ƒçº§çš„å·¨é¢äººèº«ä¼¤å®³ç´¢èµ”ã€‚',
                                                                    '90001': 'å„¿ç«¥çª’æ¯ä¸æ¯’æ€§é£é™©ï¼šæ ¸å¿ƒé£é™©ç‚¹ä¸ºå°éƒ¨ä»¶ï¼ˆSmall Partsï¼‰è„±è½å¯¼è‡´çš„çª’æ¯ï¼ˆChoking Hazardï¼‰åŠææ–™é‡é‡‘å±è¶…æ ‡ã€‚ç¾å›½ ASTM F963 æ ‡å‡†å¯¹æ­¤ç±»äº§å“æœ‰æä¸¥æ ¼çš„åˆè§„è¦æ±‚ï¼Œå¬å›ç‡æé«˜ã€‚',
                                                                    '11113': 'é«˜åŠŸç‡çƒ­æºé£é™©ï¼šå–æš–å™¨ç±»äº§å“æ˜¯å†¬å­£å®¶åº­ç«ç¾çš„ä¸»è¦è¯±å› ä¹‹ä¸€ã€‚ä¸»è¦æ•…éšœæ¨¡å¼åŒ…æ‹¬æ¸©æ§å™¨å¤±æ•ˆå¯¼è‡´çš„æŒç»­åŠ çƒ­å¼•ç‡ƒç»‡ç‰©ï¼Œæˆ–å€¾å€’æ–­ç”µä¿æŠ¤(Tip-over Switch)å¤±çµã€‚ç«ç¾è´£ä»»ç´¢èµ”é€šå¸¸æ¶‰åŠé‡å¤§è´¢äº§æŸå¤±ä¸ä¼¤äº¡ã€‚',
                                                                    '11209': 'é«˜é€Ÿæœºæ¢°ä¼¤å®³é£é™©ï¼šç”µåŠ¨å·¥å…·ï¼ˆå¦‚ç”µé”¯ã€ç£¨å…‰æœºï¼‰æ‹¥æœ‰é«˜é€Ÿæ—‹è½¬éƒ¨ä»¶ï¼Œæ“ä½œå¤±è¯¯æˆ–é˜²æŠ¤ç½©ç ´ç¢æ˜“å¯¼è‡´ä¸¥é‡å‰²ä¼¤ã€æ–­æŒ‡ç”šè‡³å¤±æ˜ã€‚åŒ—ç¾åœ°åŒºæ­¤ç±»äº§å“æ¶‰åŠçš„â€œæœªå……åˆ†è­¦ç¤ºï¼ˆFailure to Warnï¼‰â€è¯‰è®¼æ¡ˆä»¶é¢‘å‘ã€‚',
                                                                    '10406': 'å¨ç”µç«ç¾ä¸çƒ«ä¼¤é£é™©ï¼šåŠ çƒ­ç±»å°å®¶ç”µï¼ˆç©ºç‚¸ã€å’–å•¡æœºï¼‰æ¶‰åŠæ°´ç”µæ¥è§¦ä¸é«˜æ¸©è¡¨é¢ã€‚å¸¸è§ç´¢èµ”æ¡ˆä¾‹åŒ…æ‹¬æ¸©æ§å¤±æ•ˆå¯¼è‡´çš„è¿‡çƒ­ç«ç¾ï¼Œæˆ–æ¶²ä½“å–·æº…å¯¼è‡´çš„ä¸¥é‡çƒ«ä¼¤ã€‚',
                                                                    '11210': 'æ‰‹åŠ¨å·¥å…·æ–­è£‚é£é™©ï¼šè™½ç„¶æ— åŠ¨åŠ›æºï¼Œä½†æ‰³æ‰‹ã€é”¤å­ç­‰å·¥å…·åœ¨é«˜æ‰­çŸ©æˆ–å†²å‡»ä¸‹å¯èƒ½å‘ç”Ÿé‡‘å±ç–²åŠ³æ–­è£‚ï¼Œå´©é£çš„ç¢ç‰‡å¯èƒ½å¯¼è‡´çœ¼éƒ¨å—æŸæˆ–å‰²ä¼¤ã€‚ä¸»è¦é£é™©ç‚¹åœ¨äºæè´¨çƒ­å¤„ç†å·¥è‰ºä¸è¾¾æ ‡å¯¼è‡´çš„å¼ºåº¦ä¸è¶³ã€‚',
                                                                    '10905': 'åŠ³ä¿è™šå‡é˜²æŠ¤é£é™©ï¼šè‹¥æ ‡æ¦œâ€œé˜²å‰²â€ã€â€œé˜²ç«â€ä½†å®é™…æœªè¾¾æ ‡ï¼Œå°†å¯¼è‡´ç”¨æˆ·åœ¨å±é™©ç¯å¢ƒä¸‹å¤±å»é¢„æœŸä¿æŠ¤ï¼Œå¼•å‘æƒ©ç½šæ€§èµ”å¿è¯‰è®¼ã€‚è‹¥ä½œä¸ºæ™®é€šéé˜²æŠ¤å·¥è£…é”€å”®ï¼Œé£é™©ç›¸å¯¹å¯æ§ã€‚',
                                                                    '10137': 'æ±½é…å…³é”®éƒ¨ä»¶é£é™©ï¼šæ¶‰åŠè¡Œè½¦å®‰å…¨ã€‚è‹¥åˆ¹è½¦ç‰‡ã€æ‚¬æŒ‚ä»¶ç­‰å…³é”®éƒ¨ä½å¤±æ•ˆï¼Œå¯èƒ½å¯¼è‡´äº¤é€šäº‹æ•…ã€‚å³ä¾¿éå…³é”®ä»¶ï¼ˆå¦‚å†…é¥°ï¼‰ï¼Œä¹Ÿéœ€å…³æ³¨ææ–™é˜»ç‡ƒæ€§ä¸æŒ¥å‘ç‰©åˆè§„ã€‚',
                                                                    '10407': 'ç”µå­ç”µæ°”çŸ­è·¯é£é™©ï¼šä¸»è¦æ¶‰åŠå……ç”µé€‚é…å™¨è¿‡çƒ­ã€çº¿æçŸ­è·¯å¼•å‘çš„ç«ç¾ã€‚UL/ETL è®¤è¯æ˜¯æå…¶å…³é”®çš„æŠ—è¾©ä¾æ®ã€‚',
                                                                    '10000': 'ä¸€èˆ¬æ€§è´¸æ˜“é£é™©ï¼šé€šå¸¸æŒ‡ä½ä»·å€¼ã€æ— åŠ¨åŠ›æºã€ä¸äººä½“éå¯†åˆ‡æ¥è§¦çš„æ—¥ç”¨æ‚è´§ã€‚é£é™©æ•å£è¾ƒä½ï¼Œå¤šä¸ºç®€å•çš„å¼‚ç‰©åˆ’ä¼¤æˆ–åŒ…è£…è‡´ä¼¤ç­‰å°é¢ç´¢èµ”ã€‚'
                                                                };

                                                                return merchantResults.map((r, i) => {
                                                                    const isExcluded = r.cls === 'Excluded';
                                                                    const isHighRisk = r.cls === 'C';
                                                                    const status = isExcluded ? 'ä¸å¯ä¿' : (isHighRisk ? 'éœ€æ ¸ä¿' : 'å¯ä¿');
                                                                    const statusColor = isExcluded ? 'bg-red-100 text-red-600' : (isHighRisk ? 'bg-orange-100 text-orange-600' : 'bg-green-100 text-green-600');
                                                                    const keywords = r.keywords ? r.keywords.split(',').slice(0, 3).join(', ') : 'N/A';

                                                                    // Analysis Logic
                                                                    let analysisText = '';
                                                                    const isSameAsLast = lastCatId === r.id;

                                                                    if (isSameAsLast) {
                                                                        analysisText = <span className="text-gray-300 font-medium italic">â€”â€” åŒä¸Š (Idem) â€”â€”</span>;
                                                                    } else {
                                                                        const kbText = RISK_KB[r.id];
                                                                        if (kbText) {
                                                                            analysisText = (
                                                                                <span>
                                                                                    <strong className="text-gray-700 block mb-1">ã€ä¸“å®¶é£é™©æ´å¯Ÿã€‘</strong>
                                                                                    {kbText}
                                                                                </span>
                                                                            );
                                                                        } else {
                                                                            // Fallback for codes not in KB
                                                                            analysisText = isExcluded
                                                                                ? `âš ï¸ é™¤å¤–è´£ä»»ï¼šæ­¤ç±»äº§å“ (${keywords}...) å±äºæ ‡å‡†æ‰¿ä¿èŒƒå›´ä¹‹å¤–ã€‚é€šå¸¸å› å…¶å…·æœ‰æé«˜æ¦‚ç‡å¼•å‘é‡å¤§äººèº«ä¼¤å®³ï¼ˆå¦‚é«˜ç©ºä½œä¸šã€æ·±æµ·æ½œæ°´ç­‰ï¼‰ï¼Œä¿é™©å…¬å¸ä¸äºˆæ‰¿ä¿ã€‚`
                                                                                : `â„¹ï¸ å¸¸è§„é£é™©ï¼šåŒ¹é…å…³é”®è¯ [${keywords}]ï¼Œç¬¦åˆ ${r.cat} å®šä¹‰ã€‚å»ºè®®å‚ç…§æ ‡å‡† ${r.cls} ç±»è´¹ç‡æ‰¿ä¿ï¼Œé‡ç‚¹å…³æ³¨äº§å“ä½¿ç”¨è¯´æ˜ä¹¦è­¦ç¤ºè¯­å®Œæ•´æ€§ã€‚`;
                                                                        }
                                                                    }

                                                                    lastCatId = r.id; // Update tracker

                                                                    return (
                                                                        <tr key={i} className="hover:bg-blue-50/30 transition-colors group">
                                                                            <td className="p-3 text-center font-mono text-gray-400 font-bold border-r border-gray-50 text-[10px]">{i + 1}</td>
                                                                            <td className="p-3 font-medium text-gray-700 truncate max-w-xs group-hover:whitespace-normal group-hover:text-blue-800 transition-all border-r border-gray-50" title={r.title}>
                                                                                {r.title}
                                                                            </td>
                                                                            <td className="p-3 text-gray-600 border-r border-gray-50 font-medium">
                                                                                {r.cat}
                                                                            </td>
                                                                            <td className="p-3 text-center font-mono text-gray-500 border-r border-gray-50 bg-gray-50/30">{r.id}</td>
                                                                            <td className={`p-3 text-center font-bold border-r border-gray-50 ${isExcluded ? 'text-red-600' : 'text-gray-600'}`}>
                                                                                {r.cls}
                                                                            </td>
                                                                            <td className="p-3 text-center border-r border-gray-50">
                                                                                <span className={`px-2 py-1 rounded-[4px] font-bold text-[10px] ${statusColor}`}>
                                                                                    {status}
                                                                                </span>
                                                                            </td>
                                                                            <td className="p-3 text-gray-500 text-[10px] leading-relaxed text-justify pr-6">
                                                                                {analysisText}
                                                                            </td>
                                                                        </tr>
                                                                    );
                                                                });
                                                            })()}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {view === 'coi' && (
                            <div className="max-w-3xl mx-auto space-y-10 animate-in fade-in slide-in-from-bottom-4 duration-700">
                                <button onClick={() => setView('home')} className="text-blue-600 font-bold text-sm flex items-center gap-2">
                                    <span className="text-lg">â†</span> è¿”å›ä¸»é¡µå¯¼èˆª
                                </button>

                                <div className="apple-card p-16 text-center space-y-12 relative overflow-hidden">
                                    <div className="space-y-4">
                                        <div className="w-20 h-20 bg-green-50 rounded-3xl flex items-center justify-center text-4xl mx-auto">ğŸ›¡ï¸</div>
                                        <h3 className="text-4xl font-black tracking-tight">AI ä¿å•åˆè§„é¢„å®¡</h3>
                                        <p className="text-gray-400 text-lg font-medium">æ·±åº¦æ‰«æä¿å•ï¼Œè‡ªåŠ¨æ ¸å¯¹ Amazon $1,000,000 é™é¢è¦æ±‚</p>
                                    </div>

                                    {coiStep === 'idle' ? (
                                        <div onClick={() => { setCoiStep('scanning'); setTimeout(() => setCoiStep('result'), 2500) }} className="group border-2 border-dashed border-gray-100 rounded-[44px] p-24 cursor-pointer hover:border-green-500 hover:bg-green-50/20 transition-all duration-500">
                                            <div className="text-6xl mb-6 grayscale group-hover:grayscale-0 transition-all duration-500">ğŸ“¤</div>
                                            <p className="text-gray-400 font-bold text-lg">ç‚¹å‡»ç‚¹å‡»æˆ–æ‹–æ‹½ COI æ‰«æä»¶ (PDF/JPG)</p>
                                            <p className="text-[10px] text-gray-300 font-black uppercase tracking-widest mt-6">Secure OCR Transmission</p>
                                        </div>
                                    ) : coiStep === 'scanning' ? (
                                        <div className="py-24 relative">
                                            <div className="h-1 bg-green-500 absolute top-0 left-0 w-full animate-pulse"></div>
                                            <p className="text-green-600 font-black text-xl animate-pulse mt-12 tracking-tight">æ­£åœ¨æ ¸å¯¹ Amazon.com Services LLC. åˆè§„æè¿°...</p>
                                            <div className="mt-8 flex justify-center gap-2">
                                                <div className="w-2 h-2 bg-green-200 rounded-full animate-bounce delay-75"></div>
                                                <div className="w-2 h-2 bg-green-300 rounded-full animate-bounce delay-150"></div>
                                                <div className="w-2 h-2 bg-green-400 rounded-full animate-bounce delay-300"></div>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="text-left space-y-8 animate-in fade-in zoom-in-95 duration-500">
                                            <div className="p-8 bg-red-50/50 border border-red-100 rounded-[40px] space-y-4">
                                                <div className="flex items-center gap-3 text-red-600">
                                                    <span className="text-2xl">ğŸš¨</span>
                                                    <h4 className="text-xl font-black tracking-tight">è‡´å‘½åˆè§„é¡¹ç¼ºå¤± (2)</h4>
                                                </div>
                                                <ul className="text-sm text-red-700/80 space-y-4 font-bold ml-9">
                                                    <li className="flex items-start gap-2 leading-relaxed">
                                                        <span className="mt-1.5 w-1.5 h-1.5 bg-red-500 rounded-full shrink-0"></span>
                                                        <span>ä¿é¢ä¸è¶³ï¼šå½“å‰æ ‡å‡†è¦æ±‚å•æ¬¡èµ”ä»˜é™é¢ä¸ä½äº ${fComm(coiRules.find(r => r.id === 'limit')?.value || 1000000)}ã€‚</span>
                                                    </li>
                                                    <li className="flex items-start gap-2 leading-relaxed">
                                                        <span className="mt-1.5 w-1.5 h-1.5 bg-red-500 rounded-full shrink-0"></span>
                                                        <span>é™„åŠ è¢«ä¿é™©äººæè¿°æœ‰è¯¯ï¼šå¿…é¡»åŒ…å« "{coiRules.find(r => r.id === 'holder')?.value || 'Amazon.com Services LLC'}" ç­‰æ³•å®šè¡¨è¿°ã€‚</span>
                                                    </li>
                                                </ul>
                                            </div>

                                            <div className="p-8 bg-green-50/50 border border-green-100 rounded-[40px] flex items-center gap-6">
                                                <div className="w-12 h-12 bg-green-100 rounded-2xl flex items-center justify-center text-xl">âœ…</div>
                                                <div>
                                                    <h4 className="font-black text-green-900 leading-none mb-2">å…èµ”é¢åˆè§„</h4>
                                                    <p className="text-sm text-green-700 font-medium">æ£€æµ‹ç»“æœç¬¦åˆä¸è¶…è¿‡ ${fComm(coiRules.find(r => r.id === 'deductible')?.value || 10000)} ç¾é‡‘çš„é™åº¦è¦æ±‚ã€‚</p>
                                                </div>
                                            </div>

                                            <button className="w-full py-6 bg-gray-900 text-white rounded-[28px] text-lg font-black hover:bg-black transition-all shadow-xl shadow-gray-200" onClick={() => alert('ä¿®æ”¹æ„è§å·²ç”Ÿæˆï¼Œè¯·å‘é€ç»™æ‚¨çš„ä¿é™©ç»çºªã€‚')}>
                                                è·å–ä¸“å®¶ä¿®æ”¹æ„è§
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {view === 'admin' && (
                            <div className="max-w-5xl mx-auto space-y-10 animate-in fade-in duration-700">
                                <button onClick={() => setView('home')} className="text-blue-600 font-bold text-sm">â† è¿”å›ä¸»é¡µå¯¼èˆª</button>
                                <div className="grid md:grid-cols-3 gap-8">
                                    <div className="md:col-span-2 apple-card p-12 space-y-8 border-2 border-blue-500/10">
                                        <h3 className="text-3xl font-black italic">å‚æ•°ç»´æŠ¤ä¸­å¿ƒ</h3>
                                        <div className="grid md:grid-cols-2 gap-8">
                                            <div className="space-y-4">
                                                <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest">æ ‡å‡†æŠ˜ç®—æ±‡ç‡ (USD/CNY)</label>
                                                <input type="number" step="0.01" className="w-full p-6 h-[80px] rounded-[24px] bg-gray-50 border-none font-black text-2xl text-blue-600 outline-none focus:bg-white" value={exRate} onChange={e => setExRate(e.target.value)} />
                                            </div>
                                            <div className="space-y-4">
                                                <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest">åŒæ­¥ MASTER è´¹ç‡åº“ (.xlsx)</label>
                                                <div className="h-[80px] border-2 border-dashed border-gray-100 rounded-[24px] flex items-center justify-center bg-gray-50 relative hover:border-blue-400 transition-all cursor-pointer">
                                                    <input type="file" onChange={handleAdminUpload} className="absolute inset-0 opacity-0 cursor-pointer" />
                                                    <span className="text-sm font-black text-gray-400">ç‚¹å‡»ä¸Šä¼ æŠ¥ä»·è§„åˆ™</span>
                                                </div>
                                            </div>
                                            <div className="space-y-4 md:col-span-2">
                                                <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest">æ›´æ–°äºšé©¬é€Š COI å®¡æ ¸æ ‡å‡† (Amazon Requirements)</label>
                                                <div className="border-2 border-dashed border-gray-100 rounded-[24px] p-6 bg-gray-50 flex items-center justify-between group hover:border-green-400 transition-all relative">
                                                    <div className="flex gap-6 items-center">
                                                        <div className="text-2xl">ğŸ“‘</div>
                                                        <div className="text-left">
                                                            <p className="text-xs font-black text-gray-900">å½“å‰æ ‡å‡†ï¼šé™é¢ ${fComm(coiRules.find(r => r.id === 'limit')?.value)} / å…èµ” ${fComm(coiRules.find(r => r.id === 'deductible')?.value)}</p>
                                                            <p className="text-[9px] text-gray-400 font-bold uppercase tracking-widest">æ”¯æŒ PDF / Word / Excel / TXT åŒæ­¥åˆ¤å®šé€»è¾‘</p>
                                                        </div>
                                                    </div>
                                                    <input type="file" onChange={handleCoiRulesUpload} className="absolute inset-0 opacity-0 cursor-pointer" />
                                                    <button className="px-4 py-2 bg-white border rounded-xl text-[10px] font-black group-hover:bg-green-500 group-hover:text-white transition-all shadow-sm">UPLOAD</button>
                                                </div>
                                            </div>

                                            <div className="space-y-4 md:col-span-2">
                                                <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest">å®¢æˆ·åˆ†å‘ç®¡ç† (Distribution Settings)</label>
                                                <div className="p-8 bg-blue-600 rounded-[32px] text-white flex justify-between items-center shadow-xl shadow-blue-100">
                                                    <div className="space-y-2">
                                                        <h4 className="text-xl font-bold">å¯¼å‡ºåˆ†å‘ç‰ˆ HTML</h4>
                                                        <p className="text-blue-100 text-xs font-medium">å¯¼å‡ºåï¼Œæ–‡ä»¶å°†å†…ç½®æ‚¨å½“å‰çš„è´¹ç‡åº“é€»è¾‘ã€‚å‘é€ç»™å®¢æˆ·å³å¯ç›´æ¥ä½¿ç”¨ã€‚</p>
                                                    </div>
                                                    <button onClick={downloadDistributionFile} className="px-8 py-4 bg-white text-blue-600 rounded-2xl font-black text-sm hover:bg-blue-50 transition-all">ä¸€é”®å¯¼å‡º</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="apple-card p-10 bg-gray-900 text-white flex flex-col justify-center gap-6">
                                        <div><p className="text-[9px] opacity-40 uppercase font-black">Database Rows</p><p className="text-4xl font-black">{db.length}</p></div>
                                        <div className="h-[1px] bg-white/10 w-full"></div>
                                        <div><p className="text-[9px] opacity-40 uppercase font-black">Audit Entries</p><p className="text-4xl font-black">{logs.length}</p></div>
                                    </div>
                                </div>

                                <div className="log-window no-scrollbar max-h-[400px] overflow-y-auto">
                                    <p className="text-[10px] text-gray-500 mb-8 font-black uppercase text-center border-b border-white/5 pb-4">System Event Log</p>
                                    {logs.map(log => (
                                        <div key={log.id} className="flex justify-between items-center py-4 border-b border-white/5">
                                            <div>
                                                <span className="text-blue-500 font-black text-[9px] tracking-widest uppercase mr-3">{log.type}</span>
                                                <span className="text-white/80 font-medium text-sm">{log.detail}</span>
                                            </div>
                                            <span className="text-white/20 text-[9px] font-mono">{log.time}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>

</html>