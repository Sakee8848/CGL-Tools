<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>äºšé©¬é€Š CGL æ™ºèƒ½ä½“ - æ——èˆ°åˆè§„ç‰ˆ</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.5.1/mammoth.browser.min.js"></script>
    <style>
        body {
            background-color: #F5F5F7;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .apple-card {
            background: white;
            border-radius: 28px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.4s ease;
        }

        .log-window {
            background: #1d1d1f;
            color: #00ff00;
            font-family: ui-monospace, monospace;
            font-size: 11px;
            border-radius: 16px;
            padding: 20px;
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const fComm = (val) => {
            if (val === undefined || val === null || isNaN(val)) return "0";
            return new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(val);
        };

        const DEFAULT_DB = [
            { id: '11210', cat: 'æ‰‹åŠ¨å·¥å…·', cls: 'B', rate: 0.00065, min: 4500, keywords: 'tap,die,wrench,drill,bit' },
            { id: '10905', cat: 'éé˜²æŠ¤å‹å·¥ä½œæœ', cls: 'B', rate: 0.00065, min: 4500, keywords: 'glove,thermal,work clothes' }
        ];

        const DEFAULT_COI_RULES = [
            { id: 'limit', label: 'å•æ¬¡äº‹æ•…èµ”ä»˜é™é¢', value: 1000000, unit: 'USD', desc: 'Amazon è¦æ±‚ä¸ä½äº $1M' },
            { id: 'deductible', label: 'å…èµ”é¢ä¸Šé™', value: 10000, unit: 'USD', desc: 'Amazon è¦æ±‚ä¸è¶…è¿‡ $10K' },
            { id: 'holder', label: 'é™„åŠ è¢«ä¿é™©äººæè¿°', value: 'Amazon.com Services LLC. its affiliates and assignees', unit: 'Text', desc: 'å®˜æ–¹æŒ‡å®šæ–‡æœ¬' }
        ];


        function App() {
            const [view, setView] = useState('home');
            const [db, setDb] = useState(() => JSON.parse(localStorage.getItem('cgl_db')) || DEFAULT_DB);
            const [logs, setLogs] = useState(() => JSON.parse(localStorage.getItem('cgl_audit_logs')) || []);
            const [exRate, setExRate] = useState(() => parseFloat(localStorage.getItem('cgl_ex_rate')) || 7.2);

            const [isCustomerMode] = useState(() => new URLSearchParams(window.location.search).get('mode') === 'customer');

            const [revenueRaw, setRevenueRaw] = useState("1,000,000"); // ç”¨æˆ·è¾“å…¥çš„æ€»é¢„ä¼°é”€å”®é¢
            const [merchantResults, setMerchantResults] = useState([]); // åŸå§‹åŒ¹é…åˆ—è¡¨
            const [groupedResults, setGroupedResults] = useState([]); // æŒ‰å“ç±»æ±‡æ€»åçš„ç»“æœ
            const [totalFinalPrem, setTotalFinalPrem] = useState(0);

            const [deductibleType, setDeductibleType] = useState('10000');
            const [modalFile, setModalFile] = useState(null);
            const [lastUploadStats, setLastUploadStats] = useState(null);
            const [coiStep, setCoiStep] = useState('idle');
            const [coiRules, setCoiRules] = useState(() => JSON.parse(localStorage.getItem('cgl_coi_rules')) || DEFAULT_COI_RULES);

            const addLog = (type, detail, snapshot = null) => {
                const entry = { id: Date.now(), time: new Date().toLocaleString(), type, detail, snapshot };
                setLogs(prev => [entry, ...prev].slice(0, 50));
            };

            const getRevenueNum = () => parseFloat(revenueRaw.replace(/,/g, '')) || 0;

            useEffect(() => {
                localStorage.setItem('cgl_db', JSON.stringify(db));
                localStorage.setItem('cgl_audit_logs', JSON.stringify(logs));
                localStorage.setItem('cgl_ex_rate', exRate);
                localStorage.setItem('cgl_coi_rules', JSON.stringify(coiRules));
            }, [db, logs, exRate, coiRules]);

            const processMerchantReport = (data) => {
                const globalRev = getRevenueNum();

                // 1. è¯†åˆ« SKU é£é™©å¹¶å°è¯•æå–é”€å”®æ•°æ®
                const rawMatches = data.map(row => {
                    const keys = Object.keys(row);
                    const titleKey = keys.find(k => k.toLowerCase().includes('description') || k.toLowerCase().includes('name') || k.toLowerCase().includes('sku')) || keys[0];
                    const salesKey = keys.find(k => k.toLowerCase().includes('sales') || k.toLowerCase().includes('revenue') || k.toLowerCase().includes('amount') || k.toLowerCase().includes('total'));

                    const title = row[titleKey] || "æœªçŸ¥å•†å“";
                    const salesValue = parseFloat(String(row[salesKey] || "0").replace(/[^0-9.]/g, '')) || 0;

                    const match = db.find(d => d.keywords.split(',').some(k =>
                        String(title).toLowerCase().includes(k.trim().toLowerCase())
                    )) || { id: '10000', cat: 'æ™®é€šç™¾è´§/General MDSE', cls: 'B', rate: 0.00065, min: 4500 };

                    return { title, salesValue, ...match };
                });

                // 2. æŒ‰å“ç±»(ID)è¿›è¡Œæ±‡æ€»
                const groupsMap = {};
                rawMatches.forEach(item => {
                    if (!groupsMap[item.id]) {
                        groupsMap[item.id] = {
                            id: item.id,
                            cat: item.cat,
                            cls: item.cls,
                            rate: item.rate,
                            min: item.min,
                            itemsCount: 0,
                            excelTotalSales: 0
                        };
                    }
                    groupsMap[item.id].itemsCount += 1;
                    groupsMap[item.id].excelTotalSales += item.salesValue;
                });

                // 3. è®¡ç®—æƒé‡å¹¶åˆ†é…ç”¨æˆ·è¾“å…¥çš„æ€»é”€å”®é¢
                const totalExcelSales = rawMatches.reduce((sum, item) => sum + item.salesValue, 0);
                const groupsArray = Object.values(groupsMap).map(group => {
                    // å¦‚æœ Excel æ²¡é‡‘é¢ï¼Œåˆ™æŒ‰äº§å“æ•°é‡å¹³å‡åˆ†é…ï¼›å¦‚æœæœ‰é‡‘é¢ï¼ŒæŒ‰æ¯”ä¾‹åˆ†é…
                    const weight = totalExcelSales > 0 ? group.excelTotalSales / totalExcelSales : 1 / Object.keys(groupsMap).length;
                    const allocatedSales = globalRev * weight;

                    const effectiveRate = deductibleType === '0' ? group.rate * 1.2 : group.rate;
                    const effectiveMin = deductibleType === '0' ? group.min * 1.2 : group.min;

                    const elasticPrem = allocatedSales * effectiveRate * exRate;
                    const finalGroupPrem = Math.max(elasticPrem, effectiveMin);

                    return {
                        ...group,
                        weight,
                        allocatedSales,
                        effectiveRate,
                        effectiveMin,
                        elasticPrem,
                        finalGroupPrem,
                        isMinApplied: effectiveMin > elasticPrem
                    };
                });

                setMerchantResults(rawMatches);
                setGroupedResults(groupsArray);
                setTotalFinalPrem(groupsArray.reduce((sum, g) => sum + g.finalGroupPrem, 0));
            };

            const handleMerchantUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const wb = XLSX.read(evt.target.result, { type: 'binary' });
                        const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                        processMerchantReport(data);
                    } catch (err) { alert("è§£æå¤±è´¥"); }
                };
                reader.readAsBinaryString(file);
            };

            const handleAdminUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const wb = XLSX.read(evt.target.result, { type: 'binary' });
                        const raw = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
                        const headerRow = raw.find(r => r.some(c => String(c).includes('Code') || String(c).includes('è´¹ç‡')));
                        const col = {
                            code: headerRow.indexOf('Main Sub Category Code') !== -1 ? headerRow.indexOf('Main Sub Category Code') : 2,
                            name: headerRow.indexOf('Main Sub Category') !== -1 ? headerRow.indexOf('Main Sub Category') : 3,
                            rate: headerRow.indexOf('è´¹ç‡') !== -1 ? headerRow.indexOf('è´¹ç‡') : 6,
                            min: headerRow.indexOf('æœ€ä½ä¿è´¹') !== -1 ? headerRow.indexOf('æœ€ä½ä¿è´¹') : 5
                        };
                        const newDb = raw.slice(raw.indexOf(headerRow) + 1).filter(r => r[col.code]).map(r => ({
                            id: String(r[col.code]), cat: r[col.name] || 'æœªå‘½å', cls: 'B', rate: parseFloat(r[col.rate]) || 0.00065, min: parseFloat(r[col.min]) || 4500, keywords: r[col.name] || ''
                        }));
                        if (newDb.length > 0) {
                            setDb(newDb);
                            setLastUploadStats({ count: newDb.length, fileName: file.name, time: new Date().toLocaleString() });
                            addLog('è´¹ç‡åº“æ›´æ–°', `ç®¡ç†å‘˜ä¸Šä¼ äº†æŠ¥ä»·è¡¨: ${file.name} (å…± ${newDb.length} æ¡)`, newDb.slice(0, 5));
                            alert(`âœ… è§„åˆ™å·²æ›´æ–° (${newDb.length} æ¡)`);
                        }
                    } catch (err) { alert("åŒæ­¥å¤±è´¥"); }
                };
                reader.readAsBinaryString(file);
            };

            const extractRequirementsFromText = (text) => {
                const limitMatch = text.match(/(?:limit|occurrence)[^$0-9]*\$?\s?([\d,]{5,})/i);
                const dedMatch = text.match(/(?:deductible|retention)[^$0-9]*\$?\s?([\d,]{1,5})/i);
                const holderMatch = text.match(/Amazon\.com Services LLC/i);

                return [
                    { id: 'limit', label: 'å•æ¬¡äº‹æ•…èµ”ä»˜é™é¢', value: limitMatch ? parseInt(limitMatch[1].replace(/,/g, '')) : 1000000, unit: 'USD', desc: 'Auto-extracted from document' },
                    { id: 'deductible', label: 'å…èµ”é¢ä¸Šé™', value: dedMatch ? parseInt(dedMatch[1].replace(/,/g, '')) : 10000, unit: 'USD', desc: 'Auto-extracted from document' },
                    { id: 'holder', label: 'é™„åŠ è¢«ä¿é™©äººæè¿°', value: holderMatch ? "Amazon.com Services LLC. its affiliates and assignees" : 'æœªè¯†åˆ«åˆ°ç²¾ç¡®æŠ¬å¤´', unit: 'Text', desc: 'Auto-extracted from document' }
                ];
            };

            const handleCoiRulesUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const ext = file.name.split('.').pop().toLowerCase();
                let extractedText = "";

                try {
                    if (ext === 'xlsx' || ext === 'xls' || ext === 'csv') {
                        const reader = new FileReader();
                        reader.onload = (evt) => {
                            const wb = XLSX.read(evt.target.result, { type: 'binary' });
                            const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                            if (data.length > 0) {
                                setCoiRules(data);
                                addLog('COIè§„åˆ™æ›´æ–°', `ç®¡ç†å‘˜ä¸Šä¼  Excel æ ‡å‡†: ${file.name}`, data);
                                alert(`âœ… COI å®¡æ ¸æ ‡å‡†å·²é€šè¿‡ Excel æ›´æ–°`);
                            }
                        };
                        reader.readAsBinaryString(file);
                        return;
                    }

                    if (ext === 'pdf') {
                        const loadingTask = pdfjsLib.getDocument(URL.createObjectURL(file));
                        const pdf = await loadingTask.promise;
                        let fullText = "";
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const content = await page.getTextContent();
                            fullText += content.items.map(item => item.str).join(' ');
                        }
                        extractedText = fullText;
                    } else if (ext === 'docx') {
                        const arrayBuffer = await file.arrayBuffer();
                        const result = await mammoth.extractRawText({ arrayBuffer });
                        extractedText = result.value;
                    } else if (ext === 'txt') {
                        extractedText = await file.text();
                    } else {
                        alert("ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼");
                        return;
                    }

                    if (extractedText) {
                        const newRules = extractRequirementsFromText(extractedText);
                        setCoiRules(newRules);
                        addLog('COIè§„åˆ™æ›´æ–°', `åŸºäº AI/Regex ä» ${ext.toUpperCase()} æ–‡æ¡£æå–æ ‡å‡†: ${file.name}`, newRules);
                        alert(`âœ… å·²ä» ${ext.toUpperCase()} æ–‡æ¡£æˆåŠŸæå–åˆ¤å®šé€»è¾‘`);
                    }

                } catch (err) {
                    console.error(err);
                    alert("æ–‡æ¡£è§£æå¤±è´¥: " + err.message);
                }
            };

            const downloadDistributionFile = async () => {
                try {
                    const response = await fetch(window.location.href);
                    const sourceHtml = await response.text();

                    const frozenDb = JSON.stringify(db);
                    const frozenCoi = JSON.stringify(coiRules);
                    const frozenEx = exRate.toString();

                    let distHtml = sourceHtml
                        .replace(/const DEFAULT_DB = \[.*?\];/s, `const DEFAULT_DB = ${frozenDb};`)
                        .replace(/const DEFAULT_COI_RULES = \[.*?\];/s, `const DEFAULT_COI_RULES = ${frozenCoi};`)
                        .replace(/parseFloat\(localStorage\.getItem\('cgl_ex_rate'\)\) \|\| 7.2/, `${frozenEx}`)
                        .replace(/const \[isCustomerMode\] = useState\(.*?\);/, `const [isCustomerMode] = useState(true);`);

                    const blob = new Blob([distHtml], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `CGL_Compliance_Tool_${new Date().toISOString().split('T')[0]}.html`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    addLog('å¯¼å‡ºåˆ†å‘', 'æˆåŠŸç”Ÿæˆäº†ç¡¬ç¼–ç è´¹ç‡çš„å®¢æˆ·è„±æœºç‰ˆã€‚');
                } catch (err) {
                    alert("å¯¼å‡ºå¤±è´¥ï¼Œè¯·å°è¯•åœ¨æœåŠ¡å™¨ç¯å¢ƒä¸‹è¿è¡Œï¼ˆå¦‚ Netlify/Vercelï¼‰ï¼š" + err.message);
                }
            };

            return (
                <div className="min-h-screen relative no-scrollbar">
                    <nav className="p-6 bg-white border-b sticky top-0 z-40 flex justify-between items-center px-12">
                        <div className="flex items-center gap-4 cursor-pointer" onClick={() => setView('home')}>
                            <h1 className="text-xl font-bold tracking-tight text-gray-900">
                                {isCustomerMode ? 'æŠ¥ä»·åˆè§„ä¸­å¿ƒ' : 'äºšé©¬é€Š CGL æ™ºèƒ½ä½“'}
                            </h1>
                        </div>
                        <div className="flex gap-8">
                            {!isCustomerMode && <button onClick={() => setView('admin')} className="text-xs font-bold text-gray-400 hover:text-blue-600 uppercase tracking-[0.2em]">Admin Portal</button>}
                        </div>
                    </nav>

                    <main className="max-w-6xl mx-auto p-12">
                        {view === 'home' && (
                            <div className="py-20 space-y-24 animate-in fade-in duration-1000">
                                <div className="space-y-6 text-center">
                                    <h2 className="text-8xl font-black tracking-tighter leading-[0.8] mb-8">
                                        {isCustomerMode ? 'åˆè§„åˆ›é€ ä»·å€¼' : 'åˆ†å“ç±»è®¡è´¹'}<br />
                                        <span className="text-blue-600">{isCustomerMode ? 'ä¸“ä¸šçš„åˆè§„æŠ¥ä»·' : 'æ›´ä¸“ä¸šçš„å¯¹å†²'}</span>
                                    </h2>
                                    <p className="text-xl text-gray-400 max-w-2xl mx-auto font-medium">
                                        {isCustomerMode ? 'è¯·ä¸Šä¼ æ‚¨çš„é”€å”®æŠ¥å‘Šï¼Œæˆ‘ä»¬å°†ä¸ºæ‚¨æ ¸ç®—ç²¾å‡†çš„ä¿è´¹é¢„ä¼°å¹¶æ ¸å¯¹ä¿å•åˆè§„æ€§ã€‚' : 'æ”¯æŒæŒ‰é£é™©å“ç±»è‡ªåŠ¨æ±‡æ€»é”€å”®é¢ï¼Œç‹¬ç«‹è®¡ç®—æœ€ä½ä¿è´¹ä¸å¼¹æ€§è´¹ç‡ã€‚'}
                                    </p>
                                </div>
                                <div className="grid md:grid-cols-2 gap-10">
                                    <div onClick={() => setView('merchant')} className="apple-card p-16 cursor-pointer group hover:bg-white/80">
                                        <div className="text-5xl mb-10 group-hover:scale-110 transition-transform">ğŸ“Š</div>
                                        <h3 className="text-3xl font-black mb-4 tracking-tight">æ™ºèƒ½æŠ¥ä»·åˆ†æ</h3>
                                        <p className="text-gray-400 leading-relaxed font-medium">ä¸Šä¼ é”€å”®æŠ¥å‘Šï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æ ¸ç®—æœ€ä¼˜ä¿è´¹æ–¹æ¡ˆã€‚</p>
                                    </div>
                                    <div onClick={() => setView('coi')} className="apple-card p-16 cursor-pointer group">
                                        <div className="text-5xl mb-10 group-hover:scale-110 transition-transform">ğŸ›¡ï¸</div>
                                        <h3 className="text-3xl font-black mb-4 tracking-tight">COI å‡­è¯é¢„å®¡</h3>
                                        <p className="text-gray-400 leading-relaxed font-medium">AI æ‰«æä¿å•ï¼Œæ ¸å¯¹äºšé©¬é€Š $1,000,000 å¼ºåˆ¶é™é¢è¦æ±‚ã€‚</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === 'merchant' && (
                            <div className="space-y-10 animate-in fade-in duration-700">
                                <button onClick={() => setView('home')} className="text-blue-600 font-bold text-sm">â† è¿”å›ä¸»é¡µå¯¼èˆª</button>

                                <div className="apple-card p-12 space-y-12">
                                    <div className="grid md:grid-cols-3 gap-8">
                                        <div className="md:col-span-2 space-y-4">
                                            <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-1">å…¨è´¦æˆ·é¢„è®¡å¹´åº¦æ€»é”€å”®é¢ (Annual USD Revenue)</label>
                                            <div className="relative">
                                                <span className="absolute left-6 top-1/2 -translate-y-1/2 text-gray-300 font-bold text-3xl">$</span>
                                                <input type="text" className="w-full pl-16 pr-8 py-6 rounded-[28px] bg-gray-50 border-none font-black text-4xl text-gray-900 focus:bg-white outline-none transition-all" value={revenueRaw} onChange={e => setRevenueRaw(fComm(e.target.value.replace(/[^0-9]/g, '')))} />
                                            </div>
                                        </div>
                                        <div className="space-y-4">
                                            <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-1">å…èµ”é¢æ§åˆ¶ (Deductible)</label>
                                            <select className="w-full p-6 h-[88px] rounded-[28px] bg-gray-50 border-none font-black text-xl text-gray-900 focus:bg-white appearance-none cursor-pointer outline-none transition-all" value={deductibleType} onChange={e => setDeductibleType(e.target.value)}>
                                                <option value="10000">10,000 ç¾é‡‘ (æ ‡å‡†)</option>
                                                <option value="0">æ— å…èµ” (Nil)</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div className="border-2 border-dashed border-gray-100 rounded-[40px] p-20 text-center hover:bg-blue-50/20 hover:border-blue-400 transition-all relative group bg-gray-50/30">
                                        <input type="file" className="absolute inset-0 opacity-0 cursor-pointer z-10" onChange={handleMerchantUpload} />
                                        <div className="space-y-4">
                                            <div className="text-5xl group-hover:scale-110 transition-transform">ğŸ“„</div>
                                            <h4 className="text-xl font-black">ä¸Šä¼  SKU è¯¦æƒ…æŠ¥å‘Š</h4>
                                            <p className="text-gray-400 font-medium italic">ç³»ç»Ÿå°†æ ¹æ®é£é™©ç±»ç›®è‡ªåŠ¨å¯¹å†²é”€å”®é¢ï¼Œæ™ºèƒ½è®¡ç®—åˆ†é¡¹æœ€ä½ä¿è´¹</p>
                                        </div>
                                    </div>

                                    {groupedResults.length > 0 && (
                                        <div className="space-y-12 animate-in slide-in-from-bottom-6 duration-700">
                                            <div className="relative group">
                                                <div className="absolute -inset-1 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-[48px] blur-2xl opacity-20"></div>
                                                <div className="relative bg-[#1d1d1f] p-12 rounded-[48px] text-white flex flex-col md:flex-row justify-between items-center gap-12 border border-white/5">
                                                    <div className="space-y-4 flex-1">
                                                        <div className="inline-block px-3 py-1 bg-blue-500/20 text-blue-400 text-[10px] font-black rounded-full uppercase tracking-widest">Aggregate Annual Premium (RMB)</div>
                                                        <div className="flex items-baseline gap-3">
                                                            <span className="text-4xl font-bold text-white/40">Â¥</span>
                                                            <span className="text-[100px] font-black leading-none tracking-tighter tabular-nums">{fComm(totalFinalPrem)}</span>
                                                        </div>
                                                        <div className="text-white/40 font-bold text-sm bg-white/5 p-4 rounded-2xl flex items-center gap-3">
                                                            <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                                                            è®¡è´¹é€»è¾‘ï¼šå·²å®Œæˆ {groupedResults.length} ä¸ªé£é™©ç¾¤ç»„çš„ç‹¬ç«‹é˜ˆå€¼è®¡ç®—å¹¶å®Œæˆæ€»å’Œç´¯åŠ ã€‚
                                                        </div>
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-4 min-w-[340px]">
                                                        <div className="bg-white/5 p-6 rounded-[32px] border border-white/5 text-center">
                                                            <p className="text-[9px] text-white/40 font-bold uppercase mb-2">ç»“ç®—æ±‡ç‡</p>
                                                            <p className="text-2xl font-black">{exRate}</p>
                                                        </div>
                                                        <div className="bg-white/5 p-6 rounded-[32px] border border-white/5 text-center">
                                                            <p className="text-[9px] text-white/40 font-bold uppercase mb-2">ç±»ç›®æ€»æ•°</p>
                                                            <p className="text-2xl font-black">{groupedResults.length}</p>
                                                        </div>
                                                        <div className="col-span-2 bg-blue-600/10 p-6 rounded-[32px] border border-blue-500/20 text-center">
                                                            <p className="text-[9px] text-blue-400 font-bold uppercase mb-2">å…èµ”è®¾ç½®</p>
                                                            <p className="text-lg font-black uppercase text-blue-100">{deductibleType === '0' ? 'Nil (1.2x Uplift)' : 'USD 10K (Standard)'}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="space-y-6">
                                                <div className="flex items-center gap-4 border-b pb-6">
                                                    <h4 className="text-2xl font-black tracking-tight text-gray-900 italic">Risk Categorization Summary (å“ç±»æ±‡æ€»è®¡è´¹è¡¨)</h4>
                                                </div>
                                                <div className="overflow-x-auto no-scrollbar">
                                                    <table className="w-full text-xs text-left border-separate border-spacing-y-2">
                                                        <thead>
                                                            <tr className="text-gray-400 font-black uppercase tracking-widest">
                                                                <th className="pb-4 px-6">Risk Category (Code)</th>
                                                                <th className="pb-4 px-6 text-right">Allocated Sales (USD)</th>
                                                                <th className="pb-4 px-6 text-center">Effective Rate</th>
                                                                <th className="pb-4 px-6 text-center">Min Prem (RMB)</th>
                                                                <th className="pb-4 px-6 text-right">Category Prem (RMB)</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody className="space-y-4">
                                                            {groupedResults.map((g, i) => (
                                                                <tr key={i} className="bg-gray-50/50 hover:bg-blue-50/50 transition-all group overflow-hidden rounded-[24px]">
                                                                    <td className="py-6 px-6 font-black rounded-l-[24px]">
                                                                        <div className="flex flex-col">
                                                                            <span className="text-gray-900 text-sm">{g.cat}</span>
                                                                            <span className="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Code {g.id} | {g.itemsCount} SKUs</span>
                                                                        </div>
                                                                    </td>
                                                                    <td className="py-6 px-6 text-right font-bold text-gray-500 tabular-nums">
                                                                        ${fComm(g.allocatedSales)}
                                                                    </td>
                                                                    <td className="py-6 px-6 text-center font-mono font-black text-blue-600">
                                                                        {(g.effectiveRate * 100).toFixed(4)}%
                                                                    </td>
                                                                    <td className="py-6 px-6 text-center font-bold text-gray-400">
                                                                        Â¥{fComm(g.effectiveMin)}
                                                                    </td>
                                                                    <td className="py-6 px-6 text-right rounded-r-[24px]">
                                                                        <div className="flex flex-col items-end">
                                                                            <span className="text-base font-black text-gray-900 tabular-nums">Â¥{fComm(g.finalGroupPrem)}</span>
                                                                            <span className={`text-[8px] px-1.5 py-0.5 rounded font-black uppercase ${g.isMinApplied ? 'bg-orange-100 text-orange-600' : 'bg-green-100 text-green-600'}`}>
                                                                                {g.isMinApplied ? 'Min Applied (é˜ˆå€¼å†…)' : 'Rate Applied (è¶…é˜ˆå€¼)'}
                                                                            </span>
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>

                                            <div className="pt-12 border-t space-y-4">
                                                <h5 className="text-sm font-black text-gray-400 uppercase tracking-widest px-4">åŸå§‹ SKU åŒ¹é…æ˜ç»†æ˜ç»†</h5>
                                                <div className="max-h-[400px] overflow-y-auto no-scrollbar border rounded-[32px] bg-white">
                                                    <table className="w-full text-[11px] text-left">
                                                        <thead className="sticky top-0 bg-gray-50 border-b">
                                                            <tr>
                                                                <th className="p-4 uppercase tracking-widest">Description</th>
                                                                <th className="p-4 uppercase tracking-widest">Sales (Excel)</th>
                                                                <th className="p-4 uppercase tracking-widest">Match Result</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody className="divide-y">
                                                            {merchantResults.map((r, i) => (
                                                                <tr key={i} className="hover:bg-gray-50/50">
                                                                    <td className="p-4 font-bold text-gray-600 max-w-sm truncate">{r.title}</td>
                                                                    <td className="p-4 tabular-nums font-mono text-gray-400">${fComm(r.salesValue)}</td>
                                                                    <td className="p-4"><span className="px-2 py-0.5 bg-blue-50 text-blue-600 rounded font-bold">{r.cat}</span></td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {view === 'coi' && (
                            <div className="max-w-3xl mx-auto space-y-10 animate-in fade-in slide-in-from-bottom-4 duration-700">
                                <button onClick={() => setView('home')} className="text-blue-600 font-bold text-sm flex items-center gap-2">
                                    <span className="text-lg">â†</span> è¿”å›ä¸»é¡µå¯¼èˆª
                                </button>

                                <div className="apple-card p-16 text-center space-y-12 relative overflow-hidden">
                                    <div className="space-y-4">
                                        <div className="w-20 h-20 bg-green-50 rounded-3xl flex items-center justify-center text-4xl mx-auto">ğŸ›¡ï¸</div>
                                        <h3 className="text-4xl font-black tracking-tight">AI ä¿å•åˆè§„é¢„å®¡</h3>
                                        <p className="text-gray-400 text-lg font-medium">æ·±åº¦æ‰«æä¿å•ï¼Œè‡ªåŠ¨æ ¸å¯¹ Amazon $1,000,000 é™é¢è¦æ±‚</p>
                                    </div>

                                    {coiStep === 'idle' ? (
                                        <div onClick={() => { setCoiStep('scanning'); setTimeout(() => setCoiStep('result'), 2500) }} className="group border-2 border-dashed border-gray-100 rounded-[44px] p-24 cursor-pointer hover:border-green-500 hover:bg-green-50/20 transition-all duration-500">
                                            <div className="text-6xl mb-6 grayscale group-hover:grayscale-0 transition-all duration-500">ğŸ“¤</div>
                                            <p className="text-gray-400 font-bold text-lg">ç‚¹å‡»ç‚¹å‡»æˆ–æ‹–æ‹½ COI æ‰«æä»¶ (PDF/JPG)</p>
                                            <p className="text-[10px] text-gray-300 font-black uppercase tracking-widest mt-6">Secure OCR Transmission</p>
                                        </div>
                                    ) : coiStep === 'scanning' ? (
                                        <div className="py-24 relative">
                                            <div className="h-1 bg-green-500 absolute top-0 left-0 w-full animate-pulse"></div>
                                            <p className="text-green-600 font-black text-xl animate-pulse mt-12 tracking-tight">æ­£åœ¨æ ¸å¯¹ Amazon.com Services LLC. åˆè§„æè¿°...</p>
                                            <div className="mt-8 flex justify-center gap-2">
                                                <div className="w-2 h-2 bg-green-200 rounded-full animate-bounce delay-75"></div>
                                                <div className="w-2 h-2 bg-green-300 rounded-full animate-bounce delay-150"></div>
                                                <div className="w-2 h-2 bg-green-400 rounded-full animate-bounce delay-300"></div>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="text-left space-y-8 animate-in fade-in zoom-in-95 duration-500">
                                            <div className="p-8 bg-red-50/50 border border-red-100 rounded-[40px] space-y-4">
                                                <div className="flex items-center gap-3 text-red-600">
                                                    <span className="text-2xl">ğŸš¨</span>
                                                    <h4 className="text-xl font-black tracking-tight">è‡´å‘½åˆè§„é¡¹ç¼ºå¤± (2)</h4>
                                                </div>
                                                <ul className="text-sm text-red-700/80 space-y-4 font-bold ml-9">
                                                    <li className="flex items-start gap-2 leading-relaxed">
                                                        <span className="mt-1.5 w-1.5 h-1.5 bg-red-500 rounded-full shrink-0"></span>
                                                        <span>ä¿é¢ä¸è¶³ï¼šå½“å‰æ ‡å‡†è¦æ±‚å•æ¬¡èµ”ä»˜é™é¢ä¸ä½äº ${fComm(coiRules.find(r => r.id === 'limit')?.value || 1000000)}ã€‚</span>
                                                    </li>
                                                    <li className="flex items-start gap-2 leading-relaxed">
                                                        <span className="mt-1.5 w-1.5 h-1.5 bg-red-500 rounded-full shrink-0"></span>
                                                        <span>é™„åŠ è¢«ä¿é™©äººæè¿°æœ‰è¯¯ï¼šå¿…é¡»åŒ…å« "{coiRules.find(r => r.id === 'holder')?.value || 'Amazon.com Services LLC'}" ç­‰æ³•å®šè¡¨è¿°ã€‚</span>
                                                    </li>
                                                </ul>
                                            </div>

                                            <div className="p-8 bg-green-50/50 border border-green-100 rounded-[40px] flex items-center gap-6">
                                                <div className="w-12 h-12 bg-green-100 rounded-2xl flex items-center justify-center text-xl">âœ…</div>
                                                <div>
                                                    <h4 className="font-black text-green-900 leading-none mb-2">å…èµ”é¢åˆè§„</h4>
                                                    <p className="text-sm text-green-700 font-medium">æ£€æµ‹ç»“æœç¬¦åˆä¸è¶…è¿‡ ${fComm(coiRules.find(r => r.id === 'deductible')?.value || 10000)} ç¾é‡‘çš„é™åº¦è¦æ±‚ã€‚</p>
                                                </div>
                                            </div>

                                            <button className="w-full py-6 bg-gray-900 text-white rounded-[28px] text-lg font-black hover:bg-black transition-all shadow-xl shadow-gray-200" onClick={() => alert('ä¿®æ”¹æ„è§å·²ç”Ÿæˆï¼Œè¯·å‘é€ç»™æ‚¨çš„ä¿é™©ç»çºªã€‚')}>
                                                è·å–ä¸“å®¶ä¿®æ”¹æ„è§
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {view === 'admin' && (
                            <div className="max-w-5xl mx-auto space-y-10 animate-in fade-in duration-700">
                                <button onClick={() => setView('home')} className="text-blue-600 font-bold text-sm">â† è¿”å›ä¸»é¡µå¯¼èˆª</button>
                                <div className="grid md:grid-cols-3 gap-8">
                                    <div className="md:col-span-2 apple-card p-12 space-y-8 border-2 border-blue-500/10">
                                        <h3 className="text-3xl font-black italic">å‚æ•°ç»´æŠ¤ä¸­å¿ƒ</h3>
                                        <div className="grid md:grid-cols-2 gap-8">
                                            <div className="space-y-4">
                                                <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest">æ ‡å‡†æŠ˜ç®—æ±‡ç‡ (USD/CNY)</label>
                                                <input type="number" step="0.01" className="w-full p-6 h-[80px] rounded-[24px] bg-gray-50 border-none font-black text-2xl text-blue-600 outline-none focus:bg-white" value={exRate} onChange={e => setExRate(e.target.value)} />
                                            </div>
                                            <div className="space-y-4">
                                                <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest">åŒæ­¥ MASTER è´¹ç‡åº“ (.xlsx)</label>
                                                <div className="h-[80px] border-2 border-dashed border-gray-100 rounded-[24px] flex items-center justify-center bg-gray-50 relative hover:border-blue-400 transition-all cursor-pointer">
                                                    <input type="file" onChange={handleAdminUpload} className="absolute inset-0 opacity-0 cursor-pointer" />
                                                    <span className="text-sm font-black text-gray-400">ç‚¹å‡»ä¸Šä¼ æŠ¥ä»·è§„åˆ™</span>
                                                </div>
                                            </div>
                                            <div className="space-y-4 md:col-span-2">
                                                <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest">æ›´æ–°äºšé©¬é€Š COI å®¡æ ¸æ ‡å‡† (Amazon Requirements)</label>
                                                <div className="border-2 border-dashed border-gray-100 rounded-[24px] p-6 bg-gray-50 flex items-center justify-between group hover:border-green-400 transition-all relative">
                                                    <div className="flex gap-6 items-center">
                                                        <div className="text-2xl">ğŸ“‘</div>
                                                        <div className="text-left">
                                                            <p className="text-xs font-black text-gray-900">å½“å‰æ ‡å‡†ï¼šé™é¢ ${fComm(coiRules.find(r => r.id === 'limit')?.value)} / å…èµ” ${fComm(coiRules.find(r => r.id === 'deductible')?.value)}</p>
                                                            <p className="text-[9px] text-gray-400 font-bold uppercase tracking-widest">æ”¯æŒ PDF / Word / Excel / TXT åŒæ­¥åˆ¤å®šé€»è¾‘</p>
                                                        </div>
                                                    </div>
                                                    <input type="file" onChange={handleCoiRulesUpload} className="absolute inset-0 opacity-0 cursor-pointer" />
                                                    <button className="px-4 py-2 bg-white border rounded-xl text-[10px] font-black group-hover:bg-green-500 group-hover:text-white transition-all shadow-sm">UPLOAD</button>
                                                </div>
                                            </div>

                                            <div className="space-y-4 md:col-span-2">
                                                <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest">å®¢æˆ·åˆ†å‘ç®¡ç† (Distribution Settings)</label>
                                                <div className="p-8 bg-blue-600 rounded-[32px] text-white flex justify-between items-center shadow-xl shadow-blue-100">
                                                    <div className="space-y-2">
                                                        <h4 className="text-xl font-bold">å¯¼å‡ºåˆ†å‘ç‰ˆ HTML</h4>
                                                        <p className="text-blue-100 text-xs font-medium">å¯¼å‡ºåï¼Œæ–‡ä»¶å°†å†…ç½®æ‚¨å½“å‰çš„è´¹ç‡åº“é€»è¾‘ã€‚å‘é€ç»™å®¢æˆ·å³å¯ç›´æ¥ä½¿ç”¨ã€‚</p>
                                                    </div>
                                                    <button onClick={downloadDistributionFile} className="px-8 py-4 bg-white text-blue-600 rounded-2xl font-black text-sm hover:bg-blue-50 transition-all">ä¸€é”®å¯¼å‡º</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="apple-card p-10 bg-gray-900 text-white flex flex-col justify-center gap-6">
                                        <div><p className="text-[9px] opacity-40 uppercase font-black">Database Rows</p><p className="text-4xl font-black">{db.length}</p></div>
                                        <div className="h-[1px] bg-white/10 w-full"></div>
                                        <div><p className="text-[9px] opacity-40 uppercase font-black">Audit Entries</p><p className="text-4xl font-black">{logs.length}</p></div>
                                    </div>
                                </div>

                                <div className="log-window no-scrollbar max-h-[400px] overflow-y-auto">
                                    <p className="text-[10px] text-gray-500 mb-8 font-black uppercase text-center border-b border-white/5 pb-4">System Event Log</p>
                                    {logs.map(log => (
                                        <div key={log.id} className="flex justify-between items-center py-4 border-b border-white/5">
                                            <div>
                                                <span className="text-blue-500 font-black text-[9px] tracking-widest uppercase mr-3">{log.type}</span>
                                                <span className="text-white/80 font-medium text-sm">{log.detail}</span>
                                            </div>
                                            <span className="text-white/20 text-[9px] font-mono">{log.time}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>

</html>