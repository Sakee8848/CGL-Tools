<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>亚马逊 CGL 智能体 - 旗舰合规版</title>
    <script src="https://lib.baomitu.com/react/18.2.0/umd/react.development.min.js"></script>
    <script src="https://lib.baomitu.com/react-dom/18.2.0/umd/react-dom.development.min.js"></script>
    <script src="https://lib.baomitu.com/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://lib.baomitu.com/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://lib.baomitu.com/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://lib.baomitu.com/mammoth/1.5.1/mammoth.browser.min.js"></script>
    <script src="https://lib.baomitu.com/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://lib.baomitu.com/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://lib.baomitu.com/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            background-color: #F5F5F7;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .apple-card {
            background: white;
            border-radius: 28px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.4s ease;
        }

        .log-window {
            background: #1d1d1f;
            color: #00ff00;
            font-family: ui-monospace, monospace;
            font-size: 11px;
            border-radius: 16px;
            padding: 20px;
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Print Styles */
        @media print {
            body * {
                visibility: hidden;
            }

            #risk-report-print-container,
            #risk-report-print-container * {
                visibility: visible;
            }

            #risk-report-print-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                display: block !important;
                background-color: white;
            }

            /* Hide non-print elements */
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">const {
            useState,
            useEffect
        }

            = React;

        // Helper to estimate sales from Amazon Best Seller Rank (BSR)
        // Model: Power Law Distribution
        // Disclaimer: This is a rough heuristic for estimation purposes only.
        const estimateAnnualSalesFromBSR = (rank) => {
            const r = parseInt(rank);
            if (!r || r <= 0) return 0;
            // Formula: Monthly Sales ~= 60000 * Rank ^ (-0.85)
            // Adjusted for broader category average.
            const monthly = 60000 * Math.pow(r, -0.85);
            return Math.floor(monthly * 12);
        }

            ;

        const fComm = (val) => {
            if (val === undefined || val === null || isNaN(val)) return "0";

            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 2, maximumFractionDigits: 2
            }).format(val);
        }

            ;

        // Helper to safely access localStorage (sandboxed iframe compatible)
        const safeGetItem = (key, defaultVal) => {
            try {
                if (typeof window !== 'undefined' && window.localStorage) {
                    const val = localStorage.getItem(key);
                    return val ? JSON.parse(val) : defaultVal;
                }
            }

            catch (e) {
                console.warn(`LocalStorage access failed for key $ {
                        key
                    }

                    :`, e);
            }

            return defaultVal;
        }

            ;

        const safeSetItem = (key, val) => {
            try {
                if (typeof window !== 'undefined' && window.localStorage) {
                    localStorage.setItem(key, typeof val === 'string' ? val : JSON.stringify(val));
                }
            }

            catch (e) {
                console.warn(`LocalStorage write failed for key $ {
                        key
                    }

                    :`, e);
            }
        }

            ;

        // 初始化数据库：包含更丰富的五金、工具与风险品类库，以及深度专家洞察 (Deep Expert Insights)
        const DEFAULT_DB = [ // === 高风险/拒保类 (High Risk / Excluded) ===

            {

                id: '11213',
                cat: '焊接设备/Welding & Soldering',
                cls: 'Excluded',
                rate: 0.05,
                min: 10000,
                keywords: 'welder,welding,soldering,plastic welder,arc weld,spot welder,mig welder,tig welder,plasma cutter',
                deep_analysis: {
                    focus: `<strong>高能热源与电气风险：</strong>焊接设备不仅仅因高温熔融金属构成直接火灾隐患，其瞬间高压电弧更可能导致严重的操作者电击。<ul><li><strong>火灾蔓延：</strong>焊接飞溅物(Spatter)通常超过1500°C，可引燃数米外的隐蔽可燃物。</li><li><strong>烟尘毒性：</strong>长期吸入焊接烟尘(Fume)特别是镀锌管焊接产生的氧化锌，可导致金属烟热病(Metal Fume Fever)甚至永久性肺损伤。</li><li><strong>光辐射：</strong>强紫外线会导致"电光性眼炎"(Arc Eye)及皮肤灼伤。</li></ul>`,
                    cases: `<ul> <li><strong>2021年加州车库火灾案 (赔付 $1.2M)：</strong> 一名业余DIY用户在使用便携式MIG焊机修复围栏时，未注意清理周边的油漆稀释剂抹布。飞溅火花引燃抹布，火势迅速蔓延至整个车库及邻居家。诉讼指控产品未提供足够的"清理作业环境" 警示。</li> <li><strong>2019年伊利诺伊州电击案 (赔付 $850K)：</strong> 工人在潮湿环境下使用廉价逆变焊机，因设备内部绝缘老化漏电，导致其触电身亡。法医鉴定显示设备未达IP23防护等级。</li> <li><strong>2018年纽约烟尘中毒集体诉讼：</strong> 某工业焊机品牌因未在说明书中明确建议佩戴呼吸防护，导致多名工人确诊锰中毒(Manganism)，引发千万级集体索赔。</li> </ul>`,
                    mitigation: "建议：仅承保家用小型设备，必须强制要求 ANSI Z49.1 合规，并在显眼位置张贴 '佩戴呼吸防护' 与 '清理易燃物' 的警告标签。"
                }
            },
            {
                id: '90002',
                cat: '成人用品/Adult Toys',
                cls: 'C',
                rate: 0.015,
                min: 8000,
                keywords: 'sex toy,vibrator,dildo,adult novelty,masturbator,prostate massager,cock ring,bondage,anal plug,love egg,wand massager',
                deep_analysis: {
                    focus: `<strong>私密部位接触与化学毒性：</strong> 成人用品直接接触人体最敏感的黏膜组织，核心风险在于化学成分迁移与机械性损伤。<ul><li><strong>化学灼伤与致癌：</strong> 廉价TPR/TPE材质常含有邻苯二甲酸酯(Phthalates)，长期接触可能迁移至体内干扰内分泌或诱发癌症。</li><li><strong>异物滞留(Retention)：</strong> 设计不当（通过性差、底座过小）的肛门玩具极易滑入直肠无法取出，导致急诊手术甚至肠穿孔。</li><li><strong>电池与过热：</strong> 贴身使用的震动类产品若发生锂电池热失控，将直接造成严重的人体接触性烧伤。</li></ul>`,
                    cases: `<ul> <li><strong>2020年直肠异物滞留案：</strong> 用户使用一款无底座设计的按摩塞后滑入直肠，导致结肠穿孔并引发败血症。诉讼指控产品存在严重的“设计缺陷”。</li> <li><strong>2019年邻苯二甲酸酯超标集体诉讼：</strong> 某知名情趣品牌被检测出产品塑化剂超标，且未按加州Prop 65要求贴标，导致数百万美元的和解赔偿。</li> <li><strong>2022年充电震动棒爆炸案：</strong> 产品在充电时内置锂电池爆炸引发火灾，且用户在使用过程中因过热导致局部皮肤二级烧伤。</li> </ul>`,
                    mitigation: "强烈建议：1. 仅承保使用医用级硅胶(Medical Grade Silicone)或ABS材质的产品。2. 肛门类玩具必须有 flared base (加宽底座) 设计。3. 必须符合 ISO 3533 (森玩具安全标准)。"
                }
            },
            {
                id: '12060',
                cat: '内衣与情趣服饰/Lingerie',
                cls: 'B',
                rate: 0.0018,
                min: 4500,
                keywords: 'lingerie,underwear,bra,panty,thong,stocking,corset,bodysuit,intimate apparel,babydoll,teddy,nightwear',
                deep_analysis: {
                    focus: `<strong>皮肤过敏与易燃性：</strong> 虽然风险低于成人玩具，但贴身衣物仍有独特的责任风险。<ul><li><strong>化学过敏(Dermatitis)：</strong> 残留的甲醛（用于固色）、偶氮染料或镍金属扣件，常导致接触性皮炎或严重的全身性过敏反应。</li><li><strong>易燃风险：</strong> 情趣内衣常使用蕾丝、薄纱等化纤材料，若未进行阻燃处理，遭遇明火（如香薰蜡烛）时会瞬间剧烈燃烧并附着在皮肤上，造成深度烧伤。</li><li><strong>机械伤害：</strong> 钢圈(Underwire)刺破面料划伤皮肤，或紧身束胸(Corset)设计不当导致肋骨压迫伤害。</li></ul>`,
                    cases: `<ul> <li><strong>维多利亚的秘密甲醛诉讼案：</strong> 多名消费者声称穿着该品牌内衣后出现严重的皮疹和疤痕，检测发现面料中甲醛含量超标。</li> <li><strong>2015年睡衣燃烧案：</strong> 一名女士身穿的丝质睡衣被厨房炉火引燃，因面料不符合 16 CFR 1610 易燃性标准，火势失控导致全身40%烧伤。</li> </ul>`,
                    mitigation: "1. 严格遵守 16 CFR 1610 纺织品易燃性标准。2. 确保金属配件无镍(Nickel Class Free)。3. 必须加贴完整的洗涤与材质标签。"
                }
            },
            {

                id: '10203',
                cat: '电池/Battery Packs',
                cls: 'C',
                rate: 0.012,
                min: 6500,
                keywords: 'battery,lithium,power bank,18650,lipo,battery pack,laptop battery,ebike battery',
                deep_analysis: {
                    focus: `<strong>热失控 (Thermal Runaway) 及其连锁反应：</strong> 锂离子电池的核心风险在于其高能量密度与电解液的易燃性。一旦发生内短路（如枝晶生长穿刺隔膜）或外力损伤，电池会在数秒内温度飙升至600°C以上，并喷射出氢气、甲烷等可燃气体，导致猛烈的喷射火或爆炸。此过程几乎无法通过常规灭火器扑灭。`,
                    cases: `<ul> <li><strong>2023年纽约电动单车火灾 (造成4人死亡)：</strong> 一家电动自行车维修店因过夜充电廉价翻新电池引发火灾，火势瞬间吞噬楼上公寓。调查发现电池缺乏BMS(电池管理系统)的过充保护功能。</li> <li><strong>2016年三星Note 7事件 (召回成本$53亿)：</strong> 虽然是知名品牌，但因电池仓设计预留空间不足导致负极板受压变形短路。此案彻底改变了消费电子行业的电池测试标准。</li> <li><strong>2020年航空货运火灾：</strong> 一批未申报的锂电池在货舱内自燃，导致飞机紧急迫降。涉事货代与制造商面临FAA巨额罚款及刑事指控。</li> </ul>`,
                    mitigation: "合规建议：必须提供完整的 UN38.3 运输报告，电芯需过 UL 1642，电池包需过 UL 2054。必须在产品上标注'切勿过充'及'发现鼓包立即停止使用'的警示。"
                }
            }

            ,
            {

                id: '12240',
                cat: '头盔/Helmets',
                cls: 'C',
                rate: 0.015,
                min: 8000,
                keywords: 'helmet,safety hat,protective headwear,bike helmet,motorcycle helmet,ski helmet',
                deep_analysis: {
                    focus: `<strong>防护失效与虚假安全感：</strong> 头盔不仅是物理屏障，更是能量吸收系统。如果EPS泡沫密度不均或外壳在冲击下过早碎裂，将无法有效缓冲撞击力，导致比"未戴头盔" 更严重的法律后果——因为用户是基于信任才购买的。核心风险是颅脑损伤(TBI)带来的终身护理费用索赔。`,
                    cases: `<ul> <li><strong>2018年佛罗里达摩托车事故 (赔付 $3.5M)：</strong> 骑手在低速碰撞中脑部严重受损。测试发现该头盔虽然贴有DOT标签，但并未通过穿刺测试，且系带扣在撞击瞬间断裂脱落，导致头盔飞出。</li> <li><strong>2020年滑雪头盔脑震荡案：</strong> 滑雪者佩戴不知名品牌头盔撞击树干后昏迷。CT扫描显示头盔内部泡沫几乎未发生形变吸收能量，而是直接将冲击力传导至头骨。</li> </ul>`,
                    mitigation: "必须拥有第三方实验室出具的 DOT (FMVSS 218) 或 ECE 22.05 测试报告。自行车头盔需符合 CPSC 1203 标准。"
                }
            }

            ,
            {

                id: '90001',
                cat: '儿童玩具/Toys',
                cls: 'C',
                rate: 0.010,
                min: 6000,
                keywords: 'toy,plush,kids,children,doll,lego,blocks,puzzle,baby',
                deep_analysis: {
                    focus: `<strong>机械窒息与隐形化学毒害：</strong> 儿童产品的容错率为零。 <ul> <li><strong>小部件 (Small Parts)：</strong> 3岁以下儿童不仅会吞食，还可能塞入鼻孔耳道。任何能放入"小部件测试筒" 的零件未加警示均为严重违规。</li> <li><strong>绳索勒杀：</strong> 拖拉玩具绳索过长可能缠绕颈部。</li> <li><strong>磁力珠风险：</strong> 吞食多颗强力磁珠会在肠道内相吸穿孔，引发危及生命的腹膜炎。</li> </ul>`,
                    cases: `<ul> <li><strong>2012年磁力珠致死案：</strong> 一名2岁儿童误吞7颗巴克球(Buckyballs)，造成肠穿孔死亡。此案导致CPSC对高磁通量磁铁实施了多年的禁令。</li> <li><strong>2021年亚马逊下架风波：</strong> 数万款中国产泰迪熊因眼睛纽扣拉力测试未达标（易脱落被吞食）被强制下架召回。</li> <li><strong>2019年邻苯二甲酸酯超标案：</strong> 某塑胶洗澡鸭被检出增塑剂超标200倍，可能干扰儿童内分泌系统，引发大规模消费者集体诉讼。</li> </ul>`,
                    mitigation: "强制要求 CPC (Children's Product Certificate)，并基于 CPSC 认可实验室的 ASTM F963-17 测试报告。特别关注重金属（铅）与邻苯二甲酸酯含量。"
                }
            }

            ,
            {

                id: '11113',
                cat: '加热设备/Heating Equipment',
                cls: 'A',
                rate: 0.0035,
                min: 5500,
                keywords: 'heater,garage heater,space heater,fireplace,stove,electric blanket,heating pad',
                deep_analysis: {
                    focus: `<strong>无人看管下的过热起火：</strong> 加热类电器的核心风险在于温控器失效。如果继电器粘连导致持续加热，或倾倒保护开关设计位置不当（在地毯上失效），极易在深夜引发火灾。此外，长期使用的电源线老化发热也是主要隐患。`,
                    cases: `<ul> <li><strong>2022年布朗克斯公寓大火 (17人死亡)：</strong> 调查确认起火源为一台连续运行数天的故障电暖气。该设备未能在过热时自动切断电源，引燃了周围的床垫。此案引发了对廉价电暖器安全标准的全国性审查。</li> <li><strong>2020年电热毯灼伤案：</strong> 糖尿病患者因末梢神经感觉迟钝，整夜使用过热的电热毯导致双腿深度三度烧伤。诉讼指控产品缺乏"自动定时关闭" 功能且警示说明字体过小。</li> </ul>`,
                    mitigation: "产品必须具备双重冗余保护：电子温控 + 机械式过热熔断器。必须通过 UL 1278 (移动式加热器) 标准测试。"
                }
            }

            ,
            {

                id: '11209',
                cat: '电动工具/Power Tools',
                cls: 'A',
                rate: 0.0030,
                min: 5000,
                keywords: 'spray gun,paint sprayer,drill,saw,grinder,sander,power tool,impact driver,circular saw',
                deep_analysis: {
                    focus: `<strong>高速旋转件的切割与抛射风险：</strong> 砂轮机、圆锯等工具转速高达10, 000 RPM以上。一旦砂轮片破裂，碎片动能堪比子弹。另一大风险是"反冲 (Kickback)" ——锯片卡死导致工具瞬间反弹击中操作者面部。`,
                    cases: `<ul> <li><strong>2017年砂轮机碎片致盲案：</strong> 操作者虽佩戴护目镜，但高速飞出的砂轮碎片击穿了普通PC镜片刺入眼球。法院判决认为产品包装未明确建议使用"全封闭面罩" 属于警示缺陷。</li> <li><strong>2021年台锯断指案：</strong> 木工在使用未配备 SawStop 技术的台锯时手指被切断。虽然产品符合当时标准，但陪审团认为现有更安全的技术未被采用构成了"设计缺陷" 。</li> </ul>`,
                    mitigation: "警示语必须包含 ANSI Z87.1 护目镜要求。对于手持切割工具，必须设计有Dead-man Switch (离手即停开关)。"
                }
            }

            ,
            {

                id: '10406',
                cat: '家用电器(加热)/Appliances-Heat',
                cls: 'A',
                rate: 0.0025,
                min: 4800,
                keywords: 'oven,toaster,fryer,kettle,coffee maker,air fryer,rice cooker,sous vide',
                deep_analysis: {
                    focus: `<strong>厨房环境下的水火风险：</strong> 涉及水、电、油、火的混合场景。空气炸锅积油引燃、压力锅盖飞出爆炸、电水壶蒸汽烫伤是三大高频事故。此外，电源线过短或无接地保护也是常见不合规点。`,
                    cases: `<ul> <li><strong>2023年空气炸锅召回事件：</strong> 某知名品牌召回200万台炸锅，因内部电线连接器过热熔化导致火灾风险。已有205起燃烧报告。</li> <li><strong>2019年高压锅爆炸案 (赔付 $2.1M)：</strong> 用户在未完全泄压时强行打开锅盖（安全锁失效），滚烫的食物喷射导致全身60%面积严重烫伤。</li> </ul>`,
                    mitigation: "需符合 UL 1026 (烹饪电器) 标准。压力容器类产品必须有多重物理联锁装置防止带压开盖。"
                }
            }

            ,
            {

                id: '11210',
                cat: '手动工具/Hand Tools',
                cls: 'B',
                rate: 0.0012,
                min: 4500,
                keywords: 'wrench,plier,screwdriver,hammer,tap and die,nut driver,pipe threading,socket set,hex key,allen key,security bit,knife,axe,multitool',
                deep_analysis: {
                    focus: `<strong>材质缺陷与意外断裂：</strong> 虽然无动力源，但手动工具在高负载下（如锤击、大力拧紧）金属疲劳断裂是由于热处理工艺不当造成的。崩飞的金属碎片可能致盲。刀具类产品则涉及锁定机构失效导致的割伤。`,
                    cases: `<ul> <li><strong>2015年折叠刀伤手案：</strong> 用户在使用折叠刀用力切削时，锁定片失效导致刀刃折回切断肌腱。</li> <li><strong>2020年扳手断裂案：</strong> 汽修工全力拧螺丝时扳手卡口断裂，导致手部重重撞击金属锐边造成骨折。</li> </ul>`,
                    mitigation: "确保金相热处理工艺稳定。刀具类必须通过锁定强度测试。"
                }
            }

            ,
            {

                id: '10905',
                cat: '工作服与劳保/Work Clothes',
                cls: 'B',
                rate: 0.0015,
                min: 4200,
                keywords: 'glove,work glove,safety vest,apron,uniform,safety shoes,boots',
                deep_analysis: {
                    focus: `<strong>虚假防护承诺：</strong> 如果仅作为普通衣物销售风险较低。但一旦标榜"防割"(Cut Resistant)、"阻燃"(FR)、"绝缘"(Dielectric) 等专业防护功能，若实际未达标，将导致用户在危险环境中失去预期的最后一道防线。`,
                    cases: `<ul> <li><strong>2018年防割手套失效案：</strong> 屠宰场工人在佩戴标称ANSI A4级防割手套工作时仍被利刃割伤神经。测试显示该批次手套仅达A1级。</li> </ul>`,
                    mitigation: "任何宣称防护等级的产品，必须有对应的 ANSI/ISEA 检测报告支撑。否则应作为普通耐磨手套销售。"
                }
            }

            ,
            {

                id: '10137',
                cat: '汽车配件/Auto Parts',
                cls: 'B',
                rate: 0.0018,
                min: 4800,
                keywords: 'car part,bumper,wiper,filter,mat,automotive,seat cover,light,mirror,handle',
                deep_analysis: {
                    focus: `<strong>行车安全干扰与材料合规：</strong> 就算是非关键底盘件，内饰件（脚垫、座套）如果卡住油门踏板或阻碍气囊弹出，也能引发致命事故。材料方面，需关注 FMVSS 302 阻燃标准及 VOC 挥发物。`,
                    cases: `<ul> <li><strong>2009年丰田脚垫门事件 (致全家死亡)：</strong> 全天候脚垫设计缺陷卡住了雷克萨斯的油门踏板，导致车辆失控高速撞毁。此案引发了全球千万辆级的大召回。</li> <li><strong>2021年LED车灯刺眼案：</strong> 改装的高亮LED大灯因光型设计不符合DOT标准，致使对向司机短暂致盲发生碰撞，改装件卖家被追加为被告。</li> </ul>`,
                    mitigation: "脚垫必须有防滑固定扣。车灯需符合 DOT/SAE 标准。避免销售涉及刹车、悬挂、转向的核心改装件。"
                }
            }

            ,
            {

                id: '11114',
                cat: '家居用品/Home Goods',
                cls: 'B',
                rate: 0.0008,
                min: 4000,
                keywords: 'organizer,storage,shelf,rack,hook,hanger,basket,bin,mirror,frame,clock,vase',
                deep_analysis: {
                    focus: `<strong>倾倒砸伤与玻璃破裂：</strong> 超过30英寸高的柜类家具有极高的倾倒风险，尤其是对攀爬的儿童。玻璃制品（镜子、桌面）若未使用钢化玻璃，破碎后的锐利大块碎片极易割伤大动脉。`,
                    cases: `<ul> <li><strong>宜家 Malm 抽屉柜召回案 (致8名儿童死亡)：</strong> 因未固定在墙上，抽屉柜倾倒压死多名幼童。最终赔偿金额高达4600万美元，并强制要求提供墙面固定套件。</li> <li><strong>2019年浴室镜炸裂案：</strong> 安装在浴室的普通玻璃镜因受热胀冷缩炸裂，飞溅的玻璃碎片划伤正洗澡的用户面部。</li> </ul>`,
                    mitigation: "高于75cm的柜类必须附带防倾倒固定件 (Anti-tip kit)。大尺寸玻璃建议使用钢化玻璃或贴防爆膜。"
                }
            }

            ,
            {

                id: '12050',
                cat: '纺织品/Textiles',
                cls: 'B',
                rate: 0.0009,
                min: 4000,
                keywords: 'fabric,cloth,towel,bedding,pillow,curtain,blanket,rug,carpet',
                deep_analysis: {
                    focus: `<strong>易燃性风险：</strong> 特别是大面积垂直悬挂的织物（窗帘）或人体睡眠接触物（睡衣、床品）。如果极易被火柴或香烟引燃且燃烧速度过快（闪燃），将无法给用户逃生时间。`,
                    cases: `<ul> <li><strong>2016年长绒地毯火灾案：</strong> 也是因为一根掉落的香烟，某种化纤长绒地毯迅速熔化并剧烈燃烧，产生的有毒黑烟导致户主窒息。产品未通过 16 CFR 1630 易燃性测试。</li> </ul>`,
                    mitigation: "必须符合 16 CFR 1610 (衣物) 或 16 CFR 1630 (地毯) 的阻燃标准。儿童睡衣有更严格的自熄要求。"
                }
            }

            ,
            {

                id: '10000',
                cat: '普通百货/General MDSE',
                cls: 'B',
                rate: 0.00065,
                min: 4200,
                keywords: 'merchandise,general,gift,stationery,decor,craft,paper,notebook',
                deep_analysis: {
                    focus: `<strong>一般性物理伤害：</strong> 风险相对较低，但仍需注意锐边、包装袋窒息风险（大塑料袋需打孔或印警示语）、以及误食风险（如外观像糖果的文具）。`,
                    cases: `<ul> <li><strong>2018年因包装袋窒息案：</strong> 婴儿将未打孔的大号透明塑料包装袋套在头上玩耍导致窒息。</li> <li><strong>2021年"食品级" 硅胶模具案：</strong> 某硅胶模具其实使用工业硅胶，导致烘焙不管是异味还是有害物质析出。</li> </ul>`,
                    mitigation: "确保符合加州 65 号法案（Prop 65）关于化学物质的警示要求。塑料袋开口大于5英寸需印窒息警示。"
                }
            }

        ];

        // 强制更新本地存储的数据库以应用新的专家洞察数据的 Helper
        // (仅在开发调试阶段或版本迁移时使用)
        const FORCE_UPDATE_DB = true;
        if (FORCE_UPDATE_DB) safeSetItem('cgl_db_v3', DEFAULT_DB);


        const DEFAULT_COI_RULES = [{
            id: 'limit', label: '单次事故赔付限额', value: 1000000, unit: 'USD', desc: 'Amazon 要求不低于 $1M'
        }

            ,
        {
            id: 'deductible', label: '免赔额上限', value: 10000, unit: 'USD', desc: 'Amazon 要求不超过 $10K'
        }

            ,
        {
            id: 'holder', label: '附加被保险人描述', value: 'Amazon.com Services LLC. its affiliates and assignees', unit: 'Text', desc: '官方指定文本'
        }

        ];


        // --- 新增：知识库导入组件 (Knowledge Base Importer) ---
        const KnowledgeImporter = ({
            onImportSuccess

        }) => {
            const [uploading,
                setUploading] = React.useState(false);
            const [logs,
                setLogs] = React.useState([]);

            const handleZipUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                setUploading(true);
                setLogs(['🚀 开始处理知识库压缩包...']);
                const newEntries = []; // Fix: Declare outside try/catch scope

                try {
                    const zip = new JSZip();
                    const zipContent = await zip.loadAsync(file);

                    // Debug Information
                    const allFiles = Object.keys(zipContent.files);
                    const docFiles = allFiles.filter(name => name.endsWith('.doc'));
                    const docxFiles = allFiles.filter(name => !name.startsWith('__MACOSX') && name.endsWith('.docx'));

                    if (docxFiles.length === 0) {
                        if (docFiles.length > 0) {
                            setLogs(prev => [...prev, `⚠️ 发现 $ {
                                    docFiles.length
                                }

                                个 .doc 格式文档，但本系统仅支持 .docx 格式。建议您将文档另存为 .docx 后重新打包上传。`]);
                        }

                        else {
                            setLogs(prev => [...prev, `⚠️ 压缩包中未找到 .docx 文档。共扫描了 $ {
                                    allFiles.length
                                }

                                个文件。请确认文件格式正确。`]);
                        }

                        setUploading(false);
                        return;
                    }

                    setLogs(prev => [...prev, `📂 发现 $ {
                            docxFiles.length
                        }

                        个有效 Word 文档 (.docx)，开始解析...`]);

                    for (let filename of docxFiles) {
                        try {
                            const fileData = await zipContent.files[filename].async("arraybuffer");

                            // 使用 Mammoth 解析 Word
                            const result = await mammoth.convertToHtml({
                                arrayBuffer: fileData
                            });
                            const htmlContent = result.value;

                            // 智能提取逻辑 (Smart Extraction)
                            // 假设文件名即为品类名 (e.g., "Camping Stoves.docx")
                            const categoryName = filename.replace('.docx', '').split('/').pop();

                            // 简单的关键词提取 (如果文档中有明确的 Risk/Mitigation 标题)
                            // 这里做一个简单的 HTML 包装作为 deep_analysis
                            // 优化：LocalStorage 容量有限（通常仅 5MB），无法存几百个完整 Word 的 HTML
                            // 解决方案：仅提取纯文本的前 800 个字符作为摘要
                            const rawText = result.value.replace(/<[^>]*>?/gm, ' '); // 剥离 HTML 标签
                            const truncatedText = rawText.substring(0, 800) + (rawText.length > 800 ? '...' : '');

                            const deepAnalysis = {
                                focus: `基于专家文档 [$ {
                                filename
                            }

                            ] 的分析`,
                                cases: `<div class="kb-summary">$ {
                                truncatedText
                            }

                            </div><br/><small style="color:gray">*由于浏览器存储限制，仅展示文档摘要。请查阅原件。</small>`,
                                mitigation: "请参考上述专家文档中的详细合规建议。"
                            }

                                ;

                            // 构造一个新的 DB Entry
                            // 生成一个基于文件名的唯一 ID Hash
                            const idHash = categoryName.split('').reduce((a, b) => a + b.charCodeAt(0), 0).toString().slice(0, 5);

                            const newEntry = {
                                id: `IMP-$ {
                                idHash
                            }

                            `,
                                cat: categoryName,
                                // 使用文件名作为分类
                                cls: 'Referral',
                                // 默认为待人工核保，因为我们不知道费率
                                rate: 0,
                                min: 0,
                                keywords: categoryName.toLowerCase().replace(/_/g, ','),
                                // 将文件名转为关键词
                                deep_analysis: deepAnalysis,
                                isImported: true
                            }

                                ;

                            newEntries.push(newEntry);

                            setLogs(prev => [...prev, `✅ 解析成功: $ {
                                categoryName
                            }

                            `]);

                        }

                        catch (err) {
                            console.error(err);

                            setLogs(prev => [...prev, `❌ 解析失败: $ {
                                filename
                            }

                            - $ {
                                err.message
                            }

                            `]);
                        }
                    }

                    // 合并到现有数据库
                    if (newEntries.length > 0) {
                        const currentDB = safeGetItem('cgl_db_v3', []);
                        // 简单的去重合并策略：如果同名则覆盖，否则追加
                        const updatedDB = [...currentDB];

                        newEntries.forEach(ENTRY => {
                            const idx = updatedDB.findIndex(d => d.cat === ENTRY.cat);

                            if (idx > -1) {
                                // 仅更新 deep_analysis
                                updatedDB[idx].deep_analysis = ENTRY.deep_analysis;
                            }

                            else {
                                updatedDB.push(ENTRY);
                            }
                        });

                        safeSetItem('cgl_db_v3', updatedDB);

                        setLogs(prev => [...prev, `🎉 成功导入 $ {
                            newEntries.length
                        }

                        条专家知识！数据库已更新。`]);

                        if (onImportSuccess) onImportSuccess();

                        setTimeout(() => {
                            alert(`成功从文档库中导入 $ {
                                    newEntries.length
                                }

                                个新的风险品类！\n\n新导入的品类将自动用于后续的风险分析。`);
                        }

                            , 500);
                    }

                }

                catch (error) {
                    setLogs(prev => [...prev, `🔥 严重错误: $ {
                        error.message
                    }

                    `]);
                }

                finally {
                    setUploading(false);
                }
            }

                ;

            return (<div style={
                {
                    marginTop: '20px', padding: '20px', background: '#fff', borderRadius: '16px', border: '2px dashed #cbd5e0'
                }
            }

            > <h3 style={
                {
                    fontSize: '16px', fontWeight: 'bold', marginBottom: '10px', display: 'flex', alignItems: 'center'
                }
            }

            > 📚 导入专家知识库 (ZIP/Word) <span style={
                {
                    fontSize: '10px', background: '#edf2f7', padding: '2px 6px', borderRadius: '4px', marginLeft: '8px', color: '#718096'
                }
            }

            > Beta </span> </h3> <p style={
                {
                    fontSize: '12px', color: '#718096', marginBottom: '16px'
                }
            }

            > 支持批量导入 .zip 格式的压缩包。系统将自动解析压缩包内的 Word 文档 (.docx)，并将文件名作为"品类名称" ，文档内容作为"深度风险评估" 存入数据库。 </p> <div style={
                {
                    display: 'flex', gap: '10px', alignItems: 'center'
                }
            }

            > <div style={
                {
                    position: 'relative', overflow: 'hidden', display: 'inline-block'
                }
            }

            > <button className="btn" style={
                {
                    background: '#4a5568', color: 'white', padding: '8px 16px', borderRadius: '8px', fontWeight: 'bold', fontSize: '12px'
                }
            }

            > {
                                uploading ? '⏳ 正在解析...' : '📂 选择 ZIP 文件'
                            }

                        </button> <input type="file" accept=".zip" onChange={
                            handleZipUpload
                        }

                            disabled={
                                uploading
                            }

                            style={
                                {
                                    position: 'absolute', left: 0, top: 0, opacity: 0, width: '100%', height: '100%', cursor: 'pointer'
                                }
                            }

                        /> </div> </div> {
                    logs.length > 0 && (<div style={
                        {
                            marginTop: '16px', background: '#1a202c', color: '#48bb78', padding: '12px', borderRadius: '8px', fontSize: '10px', maxHeight: '120px', overflowY: 'auto'
                        }
                    }

                    > {
                            logs.map((log, i) => <div key={
                                i
                            }

                            > {
                                    log
                                }

                            </div>)
                        }

                    </div>)
                }

            </div>);
        }

            ;




        // --- 新增：风险分析卡片组件 ---
        const RiskAnalysisCard = ({
            analysis, isHighRisk

        }) => {
            const [expanded,
                setExpanded] = useState(false);

            // Construct full content
            let contentHTML = "";

            if (analysis) {

                // Determine if fields are present
                const focus = analysis.focus ? `<div class="mb-3"><div class="font-bold text-gray-800 mb-1">🎯 核心风险 (Risk Focus)</div><div class="pl-2 border-l-2 border-red-400 bg-red-50/50 p-2 rounded text-gray-700">${analysis.focus}</div></div>` : "";

                const cases = analysis.cases ? `<div class="mb-3"><div class="font-bold text-gray-800 mb-1">⚖️ 真实案例 (Real Cases)</div><div class="pl-2 border-l-2 border-amber-400 bg-amber-50/50 p-2 rounded text-gray-700">${analysis.cases}</div></div>` : "";

                const mitigation = analysis.mitigation ? `<div class="mb-1"><div class="font-bold text-gray-800 mb-1">🛡️ 合规建议 (Mitigation)</div><div class="pl-2 border-l-2 border-green-400 bg-green-50/50 p-2 rounded text-gray-700">${analysis.mitigation}</div></div>` : "";

                // Fallback for simple string format if legacy data exists
                if (!focus && !cases && !mitigation && typeof analysis === 'string') {
                    contentHTML = analysis;
                }

                else {
                    contentHTML = focus + cases + mitigation;
                }
            }

            else {
                contentHTML = isHighRisk ? "<div class='p-2 bg-red-50 text-red-600 rounded'>⚠️ 高风险类别：建议严格审查产品警示语及测试报告。</div>" :
                    "<div class='p-2 bg-gray-50 text-gray-500 rounded'>✅ 标准风险类别：符合一般贸易品承保逻辑。</div>";
            }

            // Simple heuristic for "long content"
            const isLong = contentHTML.length > 200;

            return (<div className="w-full" > <div className={
                `text-xs leading-relaxed font-medium bg-white p-5 rounded-xl border border-gray-100 shadow-sm relative transition-all duration-500 ${!expanded && isLong ? 'max-h-40 overflow-hidden mask-bottom' : ''
                }

                    `
            }

            > <div dangerouslySetInnerHTML={
                {
                    __html: contentHTML
                }
            }

                className="space-y-2" /> {
                    !expanded && isLong && (<div className="absolute bottom-0 left-0 w-full h-16 bg-gradient-to-t from-white via-white/80 to-transparent pointer-events-none" ></div>)
                }

            </div> {
                    isLong && (<button onClick={
                        () => setExpanded(!expanded)
                    }

                        className="mt-2 text-[10px] uppercase font-bold text-blue-600 hover:text-blue-800 flex items-center gap-1 ml-1"

                    > {
                            expanded ? "收起分析 (Collapse)" : "阅读完整专家分析 (Read More)"
                        }

                        {
                            expanded ? "▲" : "▼"
                        }

                    </button>)
                }

            </div>);
        }

            ;

        function App() {
            const [view,
                setView] = useState('home');
            // Migration: v4 forces a fresh start with the new rich knowledge base
            const [db,
                setDb] = useState(() => safeGetItem('cgl_db_v4', DEFAULT_DB));
            const [logs,
                setLogs] = useState(() => safeGetItem('cgl_audit_logs', []));
            const [exRate,
                setExRate] = useState(() => safeGetItem('cgl_ex_rate', 7.2));

            const [customDict,
                setCustomDict] = useState(() => safeGetItem('cgl_custom_dict', {}));

            const [isCustomerMode] = useState(() => new URLSearchParams(window.location.search).get('mode') === 'customer');

            const [revenueRaw,
                setRevenueRaw] = useState("1,000,000"); // 用户输入的总预估销售额
            const [merchantResults,
                setMerchantResults] = useState([]); // 原始匹配列表
            const [groupedResults,
                setGroupedResults] = useState([]); // 按品类汇总后的结果
            const [totalFinalPrem,
                setTotalFinalPrem] = useState(0);

            const [storeInfo,
                setStoreInfo] = useState({
                    name: 'Amazon Store', url: ''
                }); // 新增：店铺信息状态

            // Manual Sync Trigger
            const requestSync = () => {
                console.log("Manually requesting data sync...");

                window.parent.postMessage({
                    action: 'appReady'
                }

                    , '*');
                addLog('System', '尝试手动请求数据同步...');
            }

                ;

            const [deductibleType,
                setDeductibleType] = useState('10000');
            const [modalFile,
                setModalFile] = useState(null);
            const [lastUploadStats,
                setLastUploadStats] = useState(null);
            const [coiStep,
                setCoiStep] = useState('idle');
            const [coiRules,
                setCoiRules] = useState(() => safeGetItem('cgl_coi_rules', DEFAULT_COI_RULES));
            const [showImporter,
                setShowImporter] = React.useState(false);

            // DB Refresh Helper
            const refreshDB = () => {
                const storedDB = safeGetItem('cgl_db_v4', null);
                if (storedDB) setDb(storedDB);
            }

                ;

            // 优化输入体验：本地编辑状态 (解决小数点输入和格式化冲突)
            const [editState,
                setEditState] = useState({
                    id: null, val: ''
                });

            const addLog = (type, detail, snapshot = null) => {
                const entry = {
                    id: Date.now(), time: new Date().toLocaleString(), type, detail, snapshot
                }

                    ;
                setLogs(prev => [entry, ...prev].slice(0, 50));
            }

                ;

            const getRevenueNum = () => parseFloat(revenueRaw.replace(/, /g, '')) || 0;

            useEffect(() => {
                safeSetItem('cgl_db_v4', db);
                safeSetItem('cgl_audit_logs', logs);
                safeSetItem('cgl_ex_rate', exRate);
                safeSetItem('cgl_coi_rules', coiRules);
            }

                , [db, logs, exRate, coiRules]);

            useEffect(() => {
                // Version Check for v4
                const storedV4 = safeGetItem('cgl_db_v4', null);

                if (!storedV4) {
                    // First time v4 user or migration
                    console.warn("Storage upgraded to v4. Hydrating with new Rich Expert Knowledge Base.");
                    setDb(DEFAULT_DB);
                    safeSetItem('cgl_db_v4', DEFAULT_DB);
                }

                else {
                    // Check if it has specific new fields (e.g. welding deep analysis is an object)
                    const sample = storedV4.find(i => i.id === '11213');
                    const hasNewCats = storedV4.find(i => i.id === '90002'); // Check for Adult Toys

                    if (!sample || !hasNewCats || typeof sample.deep_analysis !== 'object') {
                        console.warn("Detected v4 DB but with old structure or missing categories. Force updating...");
                        setDb(DEFAULT_DB);
                        safeSetItem('cgl_db_v4', DEFAULT_DB);
                    }
                }
            }

                , []);

            // 🆕 插件联动逻辑：检查是否有来自 Popup 的待处理文件
            // 🆕 插件联动逻辑：通过 postMessage 接收数据 (Sandbox模式)
            useEffect(() => {
                const handleMessage = (event) => {
                    const message = event.data;
                    if (!message) return;

                    // 0. 数据恢复 (Hydration)
                    if (message.type === 'hydrateState') {

                        // Support migrating v2/v3 to v4 if needed, but here we prioritize v4 or default
                        const {
                            cgl_db_v4, cgl_db_v2, cgl_audit_logs, cgl_ex_rate, cgl_coi_rules
                        }

                            = message.payload;

                        // Prefer v4 if available from hydration, otherwise fallback to local DEFAULT_DB
                        if (cgl_db_v4) {
                            setDb(cgl_db_v4);
                        }

                        else if (cgl_db_v2) {
                            // Optional: Migrate v2 to v4 logic here if we wanted to keep user edits
                            // But for now, we want to force the new KB, so we might IGNORE v2 if it's old
                            console.log("Ignoring legacy v2 DB from hydration to enforce v4 update.");
                        }

                        if (cgl_audit_logs) setLogs(cgl_audit_logs);
                        if (cgl_ex_rate) setExRate(cgl_ex_rate);
                        if (cgl_coi_rules) setCoiRules(cgl_coi_rules);
                        console.log("State hydrated.");
                    }

                    // 1. 处理文件上传
                    if (message.type === 'pendingUpload') {
                        const {
                            name, type, data
                        }

                            = message.payload;
                        console.log("Received file via postMessage:", name);

                        addLog('EXT_SYNC', `接收到插件同步文件: $ {
                                name
                            }

                            `);

                        try {
                            if (type === 'xlsx' || type === 'xls') {

                                // Excel 处理
                                const wb = XLSX.read(data.split(',')[1], {
                                    type: 'base64'
                                });
                                const sheetName = wb.SheetNames[0];
                                const jsonData = XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);
                                processMerchantReport(jsonData);
                            }

                            else if (type === 'txt' || type === 'csv') {
                                // 文本处理
                                const textContent = atob(data.split(',')[1]);
                                const parsedData = parseTextToData(textContent);
                                processMerchantReport(parsedData);
                            }

                            setView('merchant');

                            // 通知父窗口清除 Storage (因为sandbox不能访问chrome.storage)
                            window.parent.postMessage({
                                action: 'clearStorage', key: 'pendingUpload'
                            }

                                , '*');

                        }

                        catch (err) {
                            console.error("File load error:", err);
                            alert("文件加载失败: " + err.message);
                        }
                    }

                    // 2. 处理页面抓取数据
                    else if (message.type === 'extractedData') {
                        const {
                            items, extractedAt, storeName, url
                        }

                            = message.payload;

                        if (storeName) setStoreInfo({
                            name: storeName, url: url || ''
                        });

                        // Check if data is fresh (within 5 minutes)
                        const timeDiff = new Date() - new Date(extractedAt);

                        if (timeDiff < 300000) {
                            // 5 minutes
                            console.log("Received scraped data:", items.length);

                            addLog('EXT_XYNC', `接收到页面抓取数据 $ {
                        items.length
                    }

                    条`);
                            processMerchantReport(items);
                            setView('merchant');
                        }

                        else {
                            console.warn("Ignored stale extracted data from:", extractedAt);
                        }
                    }
                }

                    ;

                window.addEventListener('message', handleMessage);

                // 发送 "ready" 信号给父窗口，请求数据
                window.parent.postMessage({
                    action: 'appReady'
                }

                    , '*');

                return () => window.removeEventListener('message', handleMessage);
            }

                , []);



            // 核心处理函数：处理上传的销售报告
            const processMerchantReport = (data) => {
                const globalRev = getRevenueNum();
                console.group("SKU Matching Debug Log");

                // 1. 识别 SKU 风险并尝试提取销售数据
                const rawMatches = data.map((row, idx) => {
                    const keys = Object.keys(row);
                    const kLow = keys.map(k => k.toLowerCase());

                    // 优化：优先匹配明确的描述/名称列，支持中文
                    let titleKey = keys.find(k => {
                        const low = k.toLowerCase();
                        return (low.includes('description') || low.includes('name') || low.includes('title') || low.includes('product') || low.includes('描述') || low.includes('名称') || low.includes('品名') || low.includes('商品'));
                    });

                    // 如果没找到描述列，才尝试用 SKU 或第一列兜底
                    if (!titleKey) {
                        titleKey = keys.find(k => k.toLowerCase().includes('sku')) || keys[0];
                    }

                    // 优化：支持中文销售额列名
                    const salesKey = keys.find(k => {
                        const low = k.toLowerCase();
                        return (low.includes('sales') || low.includes('revenue') || low.includes('amount') || low.includes('total') || low.includes('price') || low.includes('销售') || low.includes('金额') || low.includes('价格'));
                    });

                    // 新增：识别 BSR 排名列
                    const rankKey = keys.find(k => {
                        const low = k.toLowerCase();
                        return (low.includes('rank') || low.includes('bsr') || low.includes('排名') || low.includes('best seller'));
                    });

                    const title = row[titleKey] || "未知商品";
                    let salesValue = parseFloat(String(row[salesKey] || "0").replace(/[^0-9.]/g, '')) || 0;

                    // Sales Estimation Logic
                    const rankValue = rankKey ? parseInt(String(row[rankKey]).replace(/[^0-9]/g, '')) : 0;
                    let estAnnualSales = 0;
                    let isEstimated = false;

                    if (rankValue > 0) {
                        estAnnualSales = estimateAnnualSalesFromBSR(rankValue);

                        // 如果没有提供真实销售额，则使用预估值
                        if (salesValue === 0) {
                            salesValue = 0; // 这里的 salesValue 是 "Excel提供的真实值"，我们不混淆它，而是在后面对比使用
                            isEstimated = true;
                        }
                    }

                    // Debug: 打印前5个详情
                    if (idx < 5) console.log(`Processing Item [$ {
                            idx
                        }

                        ]:`, title);

                    // --- 1. 核心功能分类 (Primary Functional Categorization) ---
                    // 逻辑：先识别它"是什么" (Functional Identification)
                    // 我们遍历数据库，寻找匹配的功能描述。此时不应过分纠结由于包含“电池”而直接判定为“电池类别”。
                    // 因此，我们需要确保数据库的顺序：具体功能 -> 通用功能 -> 兜底
                    let primaryMatch = db.find(d => {
                        // 排除纯风险描述类（如 Battery），除非它本身就是产品主体
                        const isPureRiskCategory = d.id === '10203'; // Battery ID
                        if (isPureRiskCategory) return false;

                        const keywords = String(d.keywords || '');

                        return keywords.split(/[, ，]/).find(k => {
                            const cleanK = k.trim().toLowerCase();
                            return cleanK && String(title).toLowerCase().includes(cleanK);
                        });
                    });

                    // --- 2. 风险特征扫描 (Risk Characteristic Scanning) ---
                    // 逻辑：扫描“含有什么风险” (Risk Component Identification)
                    // 无论它是什么产品，只要包含高危组件（如电池、燃油、高压），就必须在风险上加码
                    const riskKeywords = [{
                        key: 'battery', tag: 'High Risk: Battery Source', upgradeTo: 'C', minRate: 0.012, riskId: '10203'
                    }

                        ,
                    {
                        key: 'lithium', tag: 'High Risk: Lithium Battery', upgradeTo: 'C', minRate: 0.012, riskId: '10203'
                    }

                        ,
                    {
                        key: 'welder', tag: 'High Risk: Welding Arc', upgradeTo: 'Excluded', minRate: 0.05, riskId: '11213'
                    }

                        ,
                    {
                        key: 'heater', tag: 'High Risk: Heating Element', upgradeTo: 'A', minRate: 0.0035, riskId: '11113'
                    }

                    ];

                    let riskFactor = null;
                    const titleLower = String(title).toLowerCase();

                    // 扫描标题中是否包含风险词
                    for (const rf of riskKeywords) {
                        if (titleLower.includes(rf.key)) {
                            riskFactor = rf;
                            break; // 找到最高优先级的风险即可
                        }
                    }

                    // --- 3. 最终判定 (Final Determination) ---
                    let finalMatch = {
                        ... (primaryMatch || {})
                    }

                        ;

                    // 兜底逻辑：如果连功能都没匹配上 (Result is Unidentified)
                    if (!primaryMatch) {

                        // 如果包含风险词（如是一个纯"Lithium Battery Pack"），且没匹配到其他功能，那它就是风险产品本身
                        if (riskFactor) {
                            const riskDbItem = db.find(d => d.id === riskFactor.riskId);
                            primaryMatch = riskDbItem;

                            finalMatch = {
                                ...riskDbItem
                            }

                                ;
                        }

                        else {

                            // 真正的兜底：不再默认归为“普通百货”，而是归为“待人工核保”
                            primaryMatch = {
                                id: 'REFERRAL',
                                cat: '待人工核保/Refer to Underwriter',
                                cls: 'Referral',
                                rate: 0.00, // 费率置0，强制人工定价
                                min: 0,
                                isReferral: true
                            }

                                ;

                            finalMatch = {
                                ...primaryMatch
                            }

                                ;
                            riskAnalysisText = "❓ 系统无法识别该商品，请人工确认产品功能并指定费率。";
                        }
                    }

                    else if (primaryMatch.id === '10000') {
                        // 如果匹配到了普通百货 (General MDSE)，再次确认是否真的看起来像普通百货
                        // 防止 "Nuclear Reactor" 被兜底规则匹配成 General
                        // 这里我们信任数据库的关键词匹配，但由于 General 的关键词通常很宽泛，所以保持原状即可
                    }

                    // 风险升级逻辑：
                    // 如果扫描到了风险因子，且风险因子的费率/等级 高于 产品原本的等级，则进行强制升级
                    // 原则：以高风险为准 (Highest Risk Prevails)
                    let riskAnalysisText = "✅ 标准承保风险";
                    let deepAnalysisData = finalMatch.deep_analysis || null;

                    if (riskFactor) {
                        // 比较当前产品费率与风险因子最低费率
                        const currentRate = finalMatch.rate || 0;

                        if (riskFactor.minRate > currentRate) {
                            // 触发升级
                            finalMatch.cls = riskFactor.upgradeTo;
                            finalMatch.rate = riskFactor.minRate; // 使用高风险费率

                            // 生成复合分类名
                            finalMatch.cat = `$ {
                    finalMatch.cat
                }

                (with $ {
                        riskFactor.tag.split(':')[1].trim()
                    })`;

                            riskAnalysisText = `⚠️ <strong>检测到高危组件 [$ {
                    riskFactor.key
                }

                ]</strong><br>风险等级强制上调至 [Class $ {
                    riskFactor.upgradeTo
                }

                ]`;

                            // Log
                            if (idx < 5) console.log(` ‼️ Risk Upgrade: $ {
                        title
                    }

                    -> Detected $ {
                        riskFactor.key
                    }

                    , Upgrading to $ {
                        riskFactor.upgradeTo
                    }

                    `);

                            // 尝试获取该风险因子的深度分析数据（如果有，比如 Battery）
                            const riskDbItem = db.find(d => d.id === riskFactor.riskId);

                            if (riskDbItem && riskDbItem.deep_analysis) {
                                deepAnalysisData = riskDbItem.deep_analysis;
                            }
                        }
                    }

                    else if (deepAnalysisData) {
                        // 如果没有外部风险因子升级，但是本类目自带深度分析 (如本身就是 Welding)
                        riskAnalysisText = `ℹ️ <strong>行业风险提示</strong>`;
                    }

                    if (idx < 5 && !riskFactor) console.log(` ✅ Matched Standard Rule [$ {
                finalMatch.cat
            }

            ]`);

                    // 构造返回对象，额外带上 riskAnalysis 字段供 UI 展示
                    return {
                        title,
                        salesValue, // 真实（或Excel提供的）销售额
                        estAnnualSales, // BSR 预估销售额
                        rankValue,
                        isEstimated, // 标记是否有预估数据可用

                        ...finalMatch,
                        // 如果因为风险升级导致 id 没变（比如只是改了 rate），可能会导致不同风险的产品混在一个组
                        // 为了区分，我们需要让 composite ID 唯一
                        id: riskFactor ? `$ {
                finalMatch.id
            }

            -RISK-$ {
                riskFactor.key
            }

            ` : finalMatch.id,
                        originalCat: primaryMatch ? primaryMatch.cat : 'Uncategorized',
                        riskAnalysis: riskAnalysisText,
                        deepAnalysis: deepAnalysisData
                    }

                        ;
                });
                console.groupEnd();

                // 2. 按品类(ID)进行归集汇总
                const groupsMap = {}

                    ;

                rawMatches.forEach(item => {
                    // 使用新的 Composite ID 进行分组
                    const groupId = item.id;

                    if (!groupsMap[groupId]) {
                        groupsMap[groupId] = {
                            id: groupId,
                            cat: item.cat, // 这里的 cat 可能是复合名称 "Doorbell (w/ Battery)"
                            cls: item.cls,
                            rate: item.rate,
                            min: item.min,
                            itemsCount: 0,
                            excelTotalSales: 0,
                            riskAnalysis: item.riskAnalysis, // 取第一个样本的分析文案
                            deepAnalysis: item.deepAnalysis, // 取第一个样本的深度洞察
                            items: []
                        }

                            ;
                    }

                    groupsMap[groupId].itemsCount += 1;
                    groupsMap[groupId].excelTotalSales += item.salesValue;
                    groupsMap[groupId].items.push(item);
                });

                // 3. 计算权重并初始化申报销售额
                const totalExcelSales = rawMatches.reduce((sum, item) => sum + item.salesValue, 0);

                const groupsArray = Object.values(groupsMap).map(group => {
                    // 如果 Excel 没金额，则按产品数量平均分配；如果有金额，按比例分配
                    const weight = totalExcelSales > 0 ? group.excelTotalSales / totalExcelSales : 1 / Object.keys(groupsMap).length;

                    // 默认逻辑：将用户输入的总销售额按权重分配给各组
                    // 如果用户还没有输入总销售额，则使用 Excel 抓取总额作为默认值
                    const allocatedSales = globalRev > 0 ? globalRev * weight : group.excelTotalSales;

                    // 初始化 declaredSales (可编辑字段)
                    // 核心逻辑升级: 如果有 BSR 预估销售额且原销售额为 0，则优先使用 BSR 预估值
                    const hasEstSales = group.items.some(i => i.isEstimated);
                    const declaredSales = (group.excelTotalSales === 0 && hasEstSales) ? group.items.reduce((sum, i) => sum + (i.estAnnualSales || 0), 0) : allocatedSales;

                    const effectiveRate = deductibleType === '0' ? group.rate * 1.2 : group.rate;
                    const effectiveMin = deductibleType === '0' ? group.min * 1.2 : group.min;

                    // 高风险/拒保类特殊处理
                    const isHighRisk = group.cls === 'C' || group.cls === 'Excluded';

                    // 如果是 Excluded，费率可能极高或建议人工核保
                    // 这里为了演示，Excluded 按 rate 计算但不参与最低保费对冲（相对独立）
                    let elasticPrem = declaredSales * effectiveRate * exRate;

                    // Excluded 类目的最低保费通常是强制的，且不享受折扣
                    const finalGroupPrem = Math.max(elasticPrem, effectiveMin);

                    return {
                        ...group,
                        weight,
                        allocatedSales,
                        declaredSales,
                        effectiveRate,
                        effectiveMin,
                        elasticPrem,
                        finalGroupPrem,
                        isMinApplied: effectiveMin > elasticPrem,
                        isHighRisk, // 标记为高风险
                        sales: group.excelTotalSales,
                        hasEstSales // 标记该组是否包含预估数据
                    }

                        ;
                });

                setMerchantResults(rawMatches);
                setGroupedResults(groupsArray);
                setTotalFinalPrem(groupsArray.reduce((sum, g) => sum + g.finalGroupPrem, 0));

                // 如果发现使用了 BSR 预估数据，给出提示
                const totalEst = groupsArray.reduce((sum, g) => sum + (g.hasEstSales ? g.declaredSales : 0), 0);

                if (totalExcelSales === 0 && totalEst > 0) {
                    setRevenueRaw(fComm(totalEst)); // 自动填入总额

                    addLog('System', `已基于 BSR 排名自动预估年度销售额: $$ {
                    fComm(totalEst)
                }

                `);
                }
            }

                ;

            // 优化: 处理组销售额修改 (反向联动总销售额)
            const handleGroupSalesChange = (groupId, newVal) => {
                const val = parseFloat(newVal) || 0;

                // 1. 先计算新的分组状态
                const newGroups = groupedResults.map(g => {
                    if (g.id === groupId) {
                        const newG = {
                            ...g, declaredSales: val
                        }

                            ;
                        // 重新计算该组保费
                        const effectiveRate = deductibleType === '0' ? newG.rate * 1.2 : newG.rate;
                        const effectiveMin = deductibleType === '0' ? newG.min * 1.2 : newG.min;
                        let prem = val * effectiveRate * exRate;
                        newG.finalGroupPrem = Math.max(prem, effectiveMin);
                        newG.isMinApplied = effectiveMin > prem;
                        return newG;
                    }

                    return g;
                });

                // 2. 实时计算新的总销售额
                const newTotal = newGroups.reduce((sum, g) => sum + g.declaredSales, 0);

                setGroupedResults(newGroups);
                setTotalFinalPrem(newGroups.reduce((sum, g) => sum + g.finalGroupPrem, 0));

                // 3. 更新顶部总额显示 (仅更新数值，不触发重分配)
                setRevenueRaw(fComm(newTotal));
            }

                ;

            // 优化: 处理顶部总销售额修改 (正向联动: 按权重分配给所有组)
            const handleTotalRevenueChange = (newTotalRaw) => {
                const newTotal = parseFloat(newTotalRaw.replace(/[^0-9.]/g, '')) || 0;
                setRevenueRaw(newTotalRaw); // 保持用户输入体验 (允许输入逗号等)

                if (groupedResults.length > 0) {
                    const newGroups = groupedResults.map(g => {
                        const newAllocated = newTotal * g.weight;
                        const effectiveRate = deductibleType === '0' ? g.rate * 1.2 : g.rate;
                        const effectiveMin = deductibleType === '0' ? g.min * 1.2 : g.min;
                        let prem = newAllocated * effectiveRate * exRate;

                        return {
                            ...g,
                            declaredSales: newAllocated, // 同步更新申报额
                            allocatedSales: newAllocated,
                            finalGroupPrem: Math.max(prem, effectiveMin),
                            isMinApplied: effectiveMin > prem
                        }

                            ;
                    });
                    setGroupedResults(newGroups);
                    setTotalFinalPrem(newGroups.reduce((sum, g) => sum + g.finalGroupPrem, 0));
                }
            }

                ;


            const handleMerchantUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const fileName = file.name;
                const fileExt = fileName.split('.').pop().toLowerCase();

                try {
                    if (fileExt === 'xlsx' || fileExt === 'xls' || fileExt === 'csv') {
                        // Excel/CSV 处理
                        const reader = new FileReader();

                        reader.onload = (evt) => {
                            try {
                                const wb = XLSX.read(evt.target.result, {
                                    type: 'binary'
                                });
                                const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                                processMerchantReport(data);
                            }

                            catch (err) {
                                alert("Excel 解析失败");
                            }
                        }

                            ;
                        reader.readAsBinaryString(file);

                    }

                    else if (fileExt === 'txt') {
                        // TXT 文本处理
                        const text = await file.text();
                        const parsedData = parseTextToData(text);
                        processMerchantReport(parsedData);

                    }

                    else if (fileExt === 'pdf') {
                        // PDF 处理
                        const loadingTask = pdfjsLib.getDocument(URL.createObjectURL(file));
                        const pdf = await loadingTask.promise;
                        let fullText = '';

                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const content = await page.getTextContent();
                            fullText += content.items.map(item => item.str).join(' ') + '\n';
                        }

                        const parsedData = parseTextToData(fullText);
                        processMerchantReport(parsedData);

                    }

                    else if (fileExt === 'json') {
                        // JSON 处理 (支持插件下载的抓取数据)
                        const text = await file.text();
                        const json = JSON.parse(text);
                        // 适配两种格式：插件带有的元数据格式 {items: []} 或 纯数组
                        const items = Array.isArray(json) ? json : (json.items || []);
                        processMerchantReport(items);

                    }

                    else if (fileExt === 'docx' || fileExt === 'doc') {
                        // Word 文档处理
                        const arrayBuffer = await file.arrayBuffer();

                        const result = await mammoth.extractRawText({
                            arrayBuffer
                        });
                        const parsedData = parseTextToData(result.value);
                        processMerchantReport(parsedData);

                    }

                    else {
                        alert("不支持的文件格式\n\n请上传：Excel (.xlsx/.xls)、CSV、TXT、PDF 或 Word (.docx)");
                    }
                }

                catch (err) {
                    console.error('文件解析错误:', err);
                    alert("文件解析失败: " + err.message);
                }
            }

                ;

            // 新增：从文本中解析数据的辅助函数 (升级为正则智能匹配模式 + BSR提取)
            const parseTextToData = (text) => {
                const lines = text.split('\n').filter(line => line.trim());
                const parsedData = [];
                let matchCount = 0;

                lines.forEach(line => {
                    // 预处理：去掉两端空格
                    const content = line.trim();
                    if (!content) return;

                    let description = '';
                    let sales = 0;
                    let rank = 0;

                    // 策略 0: 尝试提取 BSR 排名 (支持格式: #12,345 或 BSR: 12345)
                    const rankMatch = content.match(/(?:#|BSR:?|Rank:?)\s?([0-9, ]+)/i);

                    if (rankMatch) {
                        // 提取后移除掉排名部分，避免干扰描述
                        rank = parseInt(rankMatch[1].replace(/, /g, '')) || 0;
                    }

                    // 策略 1: Tab 分隔符 (Excel copy-paste 或 TSV 格式)
                    if (content.includes('\t')) {
                        const parts = content.split('\t');
                        // 找最长的一段文本，大概率是产品描述
                        description = parts.reduce((a, b) => a.length > b.length ? a : b, '');

                        // 找看起来像金额的列
                        const moneyPart = parts.find(p => /[\$¥￥]?\s?[0-9, ]+\.\d{2}/.test(p) || (p.match(/[0-9]/) && p.length < 10 && !p.includes('#')));
                        if (moneyPart) {
                            sales = parseFloat(moneyPart.replace(/[^0-9.]/g, '')) || 0;
                        }

                        // 如果Tab分割里有明确的排名列 (数字且不包含.)
                        if (!rank) {
                            const rankPart = parts.find(p => /^[0-9, ]+$/.test(p.trim()) && p.trim().length < 8 && !p.includes('.'));
                            if (rankPart) rank = parseInt(rankPart.replace(/, /g, ''));
                        }
                    }

                    // 策略 2: 单纯的长文本行
                    else {
                        // 移除排名部分剩下的文本
                        let cleanHasRank = content;

                        if (rankMatch) {
                            cleanHasRank = content.replace(rankMatch[0], '').trim();
                        }

                        // 如果这一行包含金额格式，尝试分割
                        const salesMatch = cleanHasRank.match(/[\t\s]+[\$¥￥]?([0-9, ]+\.?\d*)$/);

                        if (salesMatch) {
                            sales = parseFloat(salesMatch[1].replace(/, /g, '')) || 0;
                            description = cleanHasRank.replace(salesMatch[0], '').trim();
                        }

                        else {
                            description = cleanHasRank;
                        }
                    }

                    // 过滤掉太短的无意义行
                    if (description.length > 3 && !['description', 'product', 'sales', 'sku', 'rank'].includes(description.toLowerCase())) {
                        parsedData.push({
                            'Product Description': description,
                            'Sales': sales,
                            'Rank': rank // 传递 Rank 字段
                        });
                        matchCount++;
                    }
                });

                if (parsedData.length === 0) {
                    alert("⚠️ 未能从文件中识别出有效数据\n\n请确保文件中包含 SKU (如 B08N5WRWNW) 或 商品名+金额");
                }

                else {
                    console.log(`✅ 智能文本解析成功: 提取到 ${parsedData.length} 条数据`);
                }

                return parsedData;
            }

                ;


            const handleAdminUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();

                reader.onload = (evt) => {
                    try {
                        const wb = XLSX.read(evt.target.result, {
                            type: 'binary'
                        });
                        // 1. 读取为 JSON 对象数组，不再依赖固定行号
                        const rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

                        if (!rawData || rawData.length === 0) {
                            alert("未在 Excel 中找到有效数据");
                            return;
                        }

                        // 2. 智能识别列名（取第一行数据的 key 做探测）
                        const sampleRow = rawData[0];
                        const keys = Object.keys(sampleRow);
                        const kLow = keys.map(k => k.toLowerCase());

                        // 辅助函数：查找匹配的 Key（模糊匹配）
                        const findKey = (patterns) => keys.find(k => patterns.some(p => k.toLowerCase().includes(p)));

                        const keyMap = {
                            id: findKey(['code', 'sku', 'id', '代码', '编码', '序号']),
                            cat: findKey(['cat', 'name', 'desc', 'type', '分类', '名称', '品类', 'description']),
                            cls: findKey(['class', 'level', 'risk', '级别', '风险', '等级']),
                            rate: findKey(['rate', 'prem', '费率', '价格', '点位']),
                            min: findKey(['min', 'floor', '最低', '起步']),
                            // 关键：尝试找专门的关键词列，如果没有，后续会用 cat 填充
                            keywords: findKey(['keyword', 'tag', 'match', '关键词', '匹配', 'description'])
                        }

                            ;

                        console.log("识别到的列映射:", keyMap);

                        // 3. 构建标准数据库结构
                        const newDb = rawData.map(r => {
                            const catName = r[keyMap.cat] || '未命名分类';
                            let keywords = r[keyMap.keywords];

                            // 如果没有专门的 keywords 列，或者 keywords 为空，就使用分类名称作为关键词
                            // 并进行简单的分词处理，增加匹配概率
                            if (!keywords) {
                                // 移除括号内容，如 "Hand Tools (手动工具)" -> "Hand Tools 手动工具"
                                keywords = String(catName).replace(/[()（）]/g, ' ').replace(/\//g, ' ');
                            }

                            else {
                                keywords = String(keywords);
                            }

                            return {
                                id: String(r[keyMap.id] || Math.floor(Math.random() * 100000)),
                                cat: catName,
                                cls: r[keyMap.cls] || 'B', // 默认为 B 类
                                rate: parseFloat(String(r[keyMap.rate] || '0').replace(/%/, '')) / (String(r[keyMap.rate]).includes('%') ? 100 : 1) || 0.00065,
                                min: parseFloat(String(r[keyMap.min] || '0').replace(/[^0-9.]/g, '')) || 4500,
                                keywords: keywords
                            }

                                ;
                        }).filter(item => item.id && item.cat); // 过滤无效行

                        if (newDb.length > 0) {
                            setDb(newDb);

                            setLastUploadStats({
                                count: newDb.length, fileName: file.name, time: new Date().toLocaleString()
                            });

                            addLog('费率库更新', `管理员上传了报价表: ${file.name} (共 ${newDb.length} 条)`, newDb.slice(0, 3));

                            alert(`✅ 规则已更新 (${newDb.length} 条)\n系统已基于列名自动识别规则，并提取类目名称作为匹配关键词。`);
                        }

                        else {
                            alert("未能解析出有效规则，请检查表头名。");
                        }
                    }

                    catch (err) {
                        console.error(err);
                        alert("Excel 解析失败，请检查文件格式。");
                    }
                }

                    ;
                reader.readAsBinaryString(file);
            }

                ;

            const extractRequirementsFromText = (text) => {
                const limitMatch = text.match(/(?:limit|occurrence)[^$0-9]*\$?\s?([\d, ]{5,})/i);

                const dedMatch = text.match(/(?:deductible|retention)[^$0-9]*\$?\s?([\d, ]+)/i);
                const holderMatch = text.match(/Amazon\.com Services LLC/i);

                return [{
                    id: 'limit', label: '单次事故赔付限额', value: limitMatch ? parseInt(limitMatch[1].replace(/, /g, '')) : 1000000, unit: 'USD', desc: 'Auto-extracted from document'
                }

                    ,
                {
                    id: 'deductible', label: '免赔额上限', value: dedMatch ? parseInt(dedMatch[1].replace(/, /g, '')) : 10000, unit: 'USD', desc: 'Auto-extracted from document'
                }

                    ,
                {
                    id: 'holder', label: '附加被保险人描述', value: holderMatch ? "Amazon.com Services LLC. its affiliates and assignees" : '未识别到精确抬头', unit: 'Text', desc: 'Auto-extracted from document'
                }

                ];
            }

                ;

            const handleCoiRulesUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const ext = file.name.split('.').pop().toLowerCase();
                let extractedText = "";

                try {
                    if (ext === 'xlsx' || ext === 'xls' || ext === 'csv') {
                        const reader = new FileReader();

                        reader.onload = (evt) => {
                            const wb = XLSX.read(evt.target.result, {
                                type: 'binary'
                            });
                            const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

                            if (data.length > 0) {
                                setCoiRules(data);

                                addLog('COI规则更新', `管理员上传 Excel 标准: $ {
                                file.name
                            }

                            `, data);
                                alert(`✅ COI 审核标准已通过 Excel 更新`);
                            }
                        }

                            ;
                        reader.readAsBinaryString(file);
                        return;
                    }

                    if (ext === 'pdf') {
                        const loadingTask = pdfjsLib.getDocument(URL.createObjectURL(file));
                        const pdf = await loadingTask.promise;
                        let fullText = "";

                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const content = await page.getTextContent();
                            fullText += content.items.map(item => item.str).join(' ');
                        }

                        extractedText = fullText;
                    }

                    else if (ext === 'docx') {
                        const arrayBuffer = await file.arrayBuffer();

                        const result = await mammoth.extractRawText({
                            arrayBuffer
                        });
                        extractedText = result.value;
                    }

                    else if (ext === 'txt') {
                        extractedText = await file.text();
                    }

                    else {
                        alert("不支持的文件格式");
                        return;
                    }

                    if (extractedText) {
                        const newRules = extractRequirementsFromText(extractedText);
                        setCoiRules(newRules);

                        addLog('COI规则更新', `基于 AI/Regex 从 $ {
                    ext.toUpperCase()
                }

                文档提取标准: $ {
                    file.name
                }

                `, newRules);

                        alert(`✅ 已从 $ {
                    ext.toUpperCase()
                }

                文档成功提取判定逻辑`);
                    }

                }

                catch (err) {
                    console.error(err);
                    alert("文档解析失败: " + err.message);
                }
            }

                ;

            const downloadDistributionFile = async () => {
                try {
                    const response = await fetch(window.location.href);
                    const sourceHtml = await response.text();

                    const frozenDb = JSON.stringify(db);
                    const frozenCoi = JSON.stringify(coiRules);
                    const frozenEx = exRate.toString();

                    let distHtml = sourceHtml.replace(/const DEFAULT_DB=\[.*?\]; /s, `const DEFAULT_DB=$ {
                        frozenDb
                    }

                    ; `).replace(/const DEFAULT_COI_RULES=\[.*?\]; /s, `const DEFAULT_COI_RULES=$ {
                        frozenCoi
                    }

                    ; `).replace(/parseFloat\(localStorage\.getItem\('cgl_ex_rate' \)\) \|\| 7.2/, `$ {
                        frozenEx
                    }

                    `).replace(/const \[isCustomerMode\]=useState\(.*?\); /, `const [isCustomerMode]=useState(true); `);

                    const blob = new Blob([distHtml], {
                        type: 'text/html'
                    });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;

                    a.download = `CGL_Compliance_Tool_$ {
                new Date().toISOString().split('T')[0]
            }

            .html`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    addLog('导出分发', '成功生成了硬编码费率的客户脱机版。');
                }

                catch (err) {
                    alert("导出失败，请尝试在服务器环境下运行（如 Netlify/Vercel）：" + err.message);
                }
            }

                ;

            // Generate PDF Report via Print
            const generateRiskReport = () => {
                window.print();
            }

                ;

            return (<div className="min-h-screen relative no-scrollbar" > <nav className="p-6 bg-white border-b sticky top-0 z-40 flex justify-between items-center px-12" > <div className="flex items-center gap-4 cursor-pointer" onClick={
                () => setView('home')
            }

            > <h1 className="text-xl font-bold tracking-tight text-gray-900" > {
                isCustomerMode ? '报价合规中心' : '亚马逊 CGL 智能体'
            }

                </h1> </div> <div className="flex gap-6 items-center" > <button onClick={
                    requestSync
                }

                    className="text-[10px] font-bold text-gray-400 hover:text-blue-600 uppercase tracking-[0.2em]" title="强制同步插件数据" > Sync Data </button> {
                        !isCustomerMode && <button onClick={
                            () => setView('admin')
                        }

                            className="text-[10px] font-bold text-gray-400 hover:text-blue-600 uppercase tracking-[0.2em]" >Admin Portal</button>
                    }

                </div> </nav> <main className="max-w-6xl mx-auto p-12" > {
                    view === 'home' && (<div className="py-20 space-y-24 animate-in fade-in duration-1000" > <div className="space-y-6 text-center" > <h2 className="text-8xl font-black tracking-tighter leading-[0.8] mb-8" > {
                        isCustomerMode ? '合规创造价值' : '分品类计费'
                    }

                        <br /> <span className="text-blue-600" > {
                            isCustomerMode ? '专业的合规报价' : '更专业的对冲'
                        }

                        </span> </h2> <p className="text-xl text-gray-400 max-w-2xl mx-auto font-medium" > {
                            isCustomerMode ? '请上传您的销售报告，我们将为您核算精准的保费预估并核对保单合规性。' : '支持按风险品类自动汇总销售额，独立计算最低保费与弹性费率。'
                        }

                        </p> </div> <div className="grid md:grid-cols-2 gap-10" > <div onClick={
                            () => setView('merchant')
                        }

                            className="apple-card p-16 cursor-pointer group hover:bg-white/80" > <div className="text-5xl mb-10 group-hover:scale-110 transition-transform" >📊</div> <h3 className="text-3xl font-black mb-4 tracking-tight" >智能报价分析</h3> <p className="text-gray-400 leading-relaxed font-medium" >上传销售报告，系统将自动核算最优保费方案。</p> </div> <div onClick={
                                () => setView('coi')
                            }

                                className="apple-card p-16 cursor-pointer group" > <div className="text-5xl mb-10 group-hover:scale-110 transition-transform" >🛡️</div> <h3 className="text-3xl font-black mb-4 tracking-tight" >COI 凭证预审</h3> <p className="text-gray-400 leading-relaxed font-medium" >AI 扫描保单，核对亚马逊 $1, 000, 000 强制限额要求。</p> </div> </div> </div>)
                }

                    {
                        view === 'merchant' && (<div className="space-y-10 animate-in fade-in duration-700" > <button onClick={
                            () => setView('home')
                        }

                            className="text-blue-600 font-bold text-sm" >← 返回主页导航</button> <div className="apple-card p-12 space-y-12" > <div className="grid md:grid-cols-3 gap-8" > <div className="md:col-span-2 space-y-2" > <label className="text-xs font-black text-gray-400 uppercase tracking-widest ml-1" >全账户预计年度总销售额 (Annual USD Revenue)</label> <div className="relative" > <span className="absolute left-6 top-1/2 -translate-y-1/2 text-gray-300 font-bold text-2xl" >$</span> <input type="text" className="w-full pl-12 pr-6 py-4 rounded-[24px] bg-gray-50 border-none font-black text-3xl text-gray-900 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all" value={
                                revenueRaw
                            }

                                onChange={
                                    e => handleTotalRevenueChange(e.target.value)
                                }

                            /> </div> </div> <div className="space-y-4" > <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-1" >免赔额控制 (Deductible)</label> <select className="w-full p-6 h-[88px] rounded-[28px] bg-gray-50 border-none font-black text-xl text-gray-900 focus:bg-white appearance-none cursor-pointer outline-none transition-all" value={
                                deductibleType
                            }

                                onChange={
                                    e => setDeductibleType(e.target.value)
                                }

                            > <option value="10000" >10, 000 美金 (标准)</option> <option value="0" >无免赔 (Nil)</option> </select> </div> </div> <div className="border-2 border-dashed border-gray-100 rounded-[40px] p-20 text-center hover:bg-blue-50/20 hover:border-blue-400 transition-all relative group bg-gray-50/30" > <input type="file" accept=".xlsx,.xls,.csv,.txt,.pdf,.docx,.doc" className="absolute inset-0 opacity-0 cursor-pointer z-10" onChange={
                                handleMerchantUpload
                            }

                            /> <div className="space-y-4" > <div className="text-5xl group-hover:scale-110 transition-transform" >📄</div> <h4 className="text-xl font-black" >上传 SKU 详情报告</h4> <p className="text-gray-400 font-medium italic" >支持 Excel、CSV、TXT、PDF、Word 等格式</p> </div> </div> {
                                    groupedResults.length > 0 && (<div className="space-y-12 animate-in slide-in-from-bottom-6 duration-700" > <div className="relative group" > <div className="absolute -inset-1 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-[48px] blur-2xl opacity-20" ></div> <div className="relative bg-[#1d1d1f] p-12 rounded-[48px] text-white flex flex-col md:flex-row justify-between items-center gap-12 border border-white/5" > <div className="space-y-4 flex-1" > <div className="inline-block px-3 py-1 bg-blue-500/20 text-blue-400 text-[10px] font-black rounded-full uppercase tracking-widest" >Aggregate Annual Premium (RMB)</div> <div className="flex items-baseline gap-3" > <span className="text-4xl font-bold text-white/40" >¥</span> <span className="text-[100px] font-black leading-none tracking-tighter tabular-nums" > {
                                        fComm(totalFinalPrem)
                                    }

                                    </span> </div> <div className="text-white/40 font-bold text-sm bg-white/5 p-4 rounded-2xl flex items-center gap-3" > <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse" ></span> 计费逻辑：已完成 {
                                        groupedResults.length
                                    }

                                            个风险群组的独立阈值计算并完成总和累加。 </div> </div> <div className="grid grid-cols-2 gap-4 min-w-[340px]" > <div className="bg-white/5 p-6 rounded-[32px] border border-white/5 text-center" > <p className="text-[9px] text-white/40 font-bold uppercase mb-2" >结算汇率</p> <p className="text-2xl font-black" > {
                                                exRate
                                            }

                                            </p> </div> <div className="bg-white/5 p-6 rounded-[32px] border border-white/5 text-center" > <p className="text-[9px] text-white/40 font-bold uppercase mb-2" >类目总数</p> <p className="text-2xl font-black" > {
                                                groupedResults.length
                                            }

                                            </p> </div> <div className="col-span-2 bg-blue-600/10 p-6 rounded-[32px] border border-blue-500/20 text-center" > <p className="text-[9px] text-blue-400 font-bold uppercase mb-2" >免赔设置</p> <p className="text-lg font-black uppercase text-blue-100" > {
                                                deductibleType === '0' ? 'Nil (1.2x Uplift)' : 'USD 10K (Standard)'
                                            }

                                            </p> </div> </div> </div> </div> {
                                            /* 新增: 风险分类汇总与申报卡片区 */
                                        }

                                        <div className="space-y-6 pt-12 border-t border-gray-100" > <div className="flex items-center justify-between pb-4" > <div> <h4 className="text-xl font-black text-gray-900 tracking-tight" >风险分类详情与申报 (Submission Details)</h4> <p className="text-xs text-gray-400 font-medium mt-1" >请核对各大类申报销售额，系统将基于申报额重新计算保费</p> </div> <span className="text-xs font-bold text-gray-400 uppercase tracking-widest bg-gray-50 px-3 py-1 rounded-full" >Automated Analysis</span> </div> {
                                            /* PDF Export Button & Hidden Template */
                                        }

                                            <div className="flex justify-end mb-4" > <button onClick={
                                                () => generateRiskReport()
                                            }

                                                className="flex items-center gap-2 bg-gradient-to-r from-red-500 to-pink-600 text-white px-4 py-2 rounded-full font-bold text-xs shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5"

                                            > <span>📸</span> 生成小红书风风险报告 (Export PDF) </button> </div> {
                                                /* Hidden Report Container for Print Only */
                                            }

                                            <div id="risk-report-print-container" style={
                                                {
                                                    display: 'none'
                                                }
                                            }

                                            > <div className="w-[375px] mx-auto bg-[#fffbf0] p-6 text-gray-900 font-sans relative overflow-hidden border" > {
                                                /* Decorative Background Elements */
                                            }

                                                    <div className="absolute top-0 right-0 w-32 h-32 bg-yellow-200 rounded-full blur-3xl opacity-50 -mr-10 -mt-10" ></div> <div className="absolute bottom-0 left-0 w-40 h-40 bg-pink-200 rounded-full blur-3xl opacity-50 -ml-10 -mb-10" ></div> {
                                                        /* Header */
                                                    }

                                                    <div className="relative z-10 mb-6" > <div className="text-[10px] font-black tracking-[0.3em] text-gray-400 uppercase mb-2" >RISK ASSESSMENT</div> <h1 className="text-2xl font-black leading-tight mb-2 text-gray-900 border-l-4 border-black pl-3" > {
                                                        storeInfo.name
                                                    }

                                                        <br /> <span className="text-red-500" >产品合规风控报告</span> </h1> <div className="flex gap-2 text-[9px] font-bold text-gray-500 mt-3" > <span className="bg-white px-2 py-1 rounded border border-gray-200 shadow-sm" >🗓️ {
                                                            new Date().toLocaleDateString()
                                                        }

                                                        </span> <span className="bg-white px-2 py-1 rounded border border-gray-200 shadow-sm" >📦 {
                                                            groupedResults.reduce((acc, g) => acc + g.itemsCount, 0)
                                                        }

                                                                Items Scanned</span> </div> </div> {
                                                        /* Core Risk Metrics */
                                                    }

                                                    <div className="grid grid-cols-2 gap-3 mb-6 relative z-10" > <div className="bg-white p-3 rounded-xl shadow-sm border border-gray-100" > <div className="text-2xl mb-1" >🚨</div> <div className="text-xs text-gray-400 font-bold uppercase" >High Risk Groups</div> <div className="text-xl font-black text-red-500" > {
                                                        groupedResults.filter(g => g.cls === 'C' || g.cls === 'Excluded').length
                                                    }

                                                    </div> </div> <div className="bg-white p-3 rounded-xl shadow-sm border border-gray-100" > <div className="text-2xl mb-1" >🛡️</div> <div className="text-xs text-gray-400 font-bold uppercase" >Avg. Premium Rate</div> <div className="text-xl font-black text-blue-600" > {
                                                        (groupedResults.reduce((acc, g) => acc + g.rate, 0) / (groupedResults.length || 1)).toFixed(3)
                                                    }

                                                        % </div> </div> </div> {
                                                        /* Category Breakdown (No detailed SKUs) */
                                                    }

                                                    <div className="space-y-3 mb-6 relative z-10" > <h3 className="text-sm font-black border-b pb-2 flex justify-between items-center" > <span>📊 风险分布 (Risk Distribution)</span> </h3> {
                                                        groupedResults.slice(0, 6).map((group, i) => (<div key={
                                                            i
                                                        }

                                                            className="flex items-center justify-between bg-white p-3 rounded-lg shadow-sm border border-gray-50" > <div className="flex items-center gap-3" > <span className={
                                                                `w-8 h-8 flex items-center justify-center rounded-lg font-black text-xs $ {
                                                group.cls==='C' || group.cls==='Excluded' ? 'bg-red-100 text-red-600' : 'bg-gray-100 text-gray-600'
                                            }

                                            `
                                                            }

                                                            > {
                                                                    group.cls
                                                                }

                                                            </span> <div> <div className="font-bold text-xs text-gray-800 line-clamp-1 w-32" > {
                                                                group.cat
                                                            }

                                                            </div> <div className="text-[9px] text-gray-400 font-medium" > {
                                                                group.itemsCount
                                                            }

                                                                        SKU · {
                                                                            group.rate
                                                                        }

                                                                        % Rate</div> </div> </div> <div className="text-right" > {
                                                                            group.cls === 'C' || group.cls === 'Excluded' ? <span className="text-[9px] bg-red-500 text-white px-2 py-0.5 rounded font-bold" >HIGH RISK</span> : <span className="text-[9px] bg-green-100 text-green-600 px-2 py-0.5 rounded font-bold" >PASS</span>
                                                                        }

                                                            </div> </div>))
                                                    }

                                                        {
                                                            groupedResults.length > 6 && (<div className="text-center text-[10px] text-gray-400 font-medium italic" >...以及其他 {
                                                                groupedResults.length - 6
                                                            }

                                                                个风险组别</div>)
                                                        }

                                                    </div> {
                                                        /* Expert Insights (Top 1) */
                                                    }

                                                    <div className="bg-gray-900 text-white p-4 rounded-xl shadow-lg relative z-10" > <div className="flex items-center gap-2 mb-2" > <span className="text-xl" >💡</span> <span className="text-xs font-black uppercase tracking-widest text-yellow-400" >Expert Observation</span> </div> <div className="text-[10px] leading-relaxed opacity-90 font-medium" > {
                                                        (() => {
                                                            // Find the most critical insight: 1. High Risk, 2. Any group with analysis
                                                            let highRiskGroup = groupedResults.find(g => (g.cls === 'C' || g.cls === 'Excluded') && g.deepAnalysis?.focus);
                                                            if (!highRiskGroup) {
                                                                highRiskGroup = groupedResults.find(g => g.deepAnalysis?.focus);
                                                            }

                                                            if (highRiskGroup && highRiskGroup.deepAnalysis) {
                                                                // Strip HTML for PDF cleanliness
                                                                const focusRaw = highRiskGroup.deepAnalysis.focus.replace(/<[^>]+>/g, '');

                                                                return `[${highRiskGroup.cat}]: ${focusRaw.substring(0, 500)}...`;
                                                            }

                                                            return "根据CGL数据模型，您的产品组合整体风险可控，但仍建议关注高频退货品类的潜在责任风险。";
                                                        })()
                                                    }

                                                    </div> <div className="mt-3 pt-3 border-t border-white/10 flex justify-between items-center" > <span className="text-[8px] text-white/40" >GENERATED BY CGL AI AGENT</span> <div className="flex gap-1" > <div className="w-1.5 h-1.5 rounded-full bg-red-500" ></div> <div className="w-1.5 h-1.5 rounded-full bg-yellow-500" ></div> <div className="w-1.5 h-1.5 rounded-full bg-green-500" ></div> </div> </div> </div> </div> </div> <div className="space-y-4" > {
                                                        groupedResults.map((group) => {
                                                            const isHighRisk = group.cls === 'C' || group.cls === 'Excluded';

                                                            return (<div key={
                                                                group.id
                                                            }

                                                                className={
                                                                    `bg-white rounded-[24px] border $ {
                                                    isHighRisk ? 'border-red-200 bg-red-50/10' : 'border-gray-100'
                                                }

                                                overflow-hidden shadow-sm hover:shadow-md transition-all duration-300`
                                                                }

                                                            > {
                                                                    /* 卡片头部 */
                                                                }

                                                                <div className="p-6 flex flex-col md:flex-row gap-6 md:items-center justify-between" > {
                                                                    /* 左侧：分类信息 */
                                                                }

                                                                    <div className="flex items-center gap-4 min-w-[300px]" > <div className={
                                                                        `w-12 h-12 rounded-2xl flex items-center justify-center text-2xl font-black $ {
                                                    isHighRisk ? 'bg-red-100 text-red-600' : 'bg-blue-50 text-blue-600'
                                                }

                                                `
                                                                    }

                                                                    > {
                                                                            group.cls
                                                                        }

                                                                    </div> <div> <div className="flex items-center gap-2" > <h5 className="font-bold text-gray-900" > {
                                                                        group.cat
                                                                    }

                                                                    </h5> {
                                                                            isHighRisk && <span className="text-[10px] bg-red-600 text-white px-2 py-0.5 rounded-full font-bold" >HIGH RISK</span>
                                                                        }

                                                                    </div> <p className="text-xs text-gray-400 font-medium mt-1" >包含 {
                                                                        group.items?.length || 0
                                                                    }

                                                                                个 SKU · 风险费率 {
                                                                                    group.rate
                                                                                }

                                                                                %</p> </div> </div> {
                                                                        /* 中间：销售额申报 */
                                                                    }

                                                                    <div className="flex-1 min-w-[200px]" > <label className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 flex justify-between items-center" > <span>该类目申报销售额 (USD)</span> {
                                                                        group.hasEstSales && (<span className="text-[9px] bg-gradient-to-r from-orange-400 to-red-400 text-white px-2 py-0.5 rounded-full font-black tracking-widest flex items-center gap-1 shadow-sm animate-pulse" > <span>🪄</span> AUTO-ESTIMATED </span>)
                                                                    }

                                                                    </label> <div className="relative group/input" > <span className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold" >$</span> {
                                                                        /* 实时格式化提示 (当用户输入时显示带逗号的数值) */
                                                                    }

                                                                            {
                                                                                editState.id === group.id && (<div className="absolute right-0 -top-6 text-[10px] bg-blue-600 text-white px-2 py-0.5 rounded shadow-sm font-bold animate-in fade-in zoom-in duration-200 z-10" > {
                                                                                    fComm(parseFloat(editState.val) || 0)
                                                                                }

                                                                                </div>)
                                                                            }

                                                                            <input type="text"

                                                                                className={
                                                                                    `w-full pl-8 pr-4 py-3 bg-gray-50 border-transparent rounded-xl text-gray-900 font-bold focus:bg-white focus:ring-2 focus:ring-blue-500 transition-all text-right $ {
                                                    editState.id===group.id ? 'ring-2 ring-blue-500 bg-white' : ''
                                                }

                                                `
                                                                                }

                                                                                value={
                                                                                    editState.id === group.id ? editState.val : fComm(group.declaredSales)
                                                                                }

                                                                                onFocus={
                                                                                    () => setEditState({
                                                                                        id: group.id, val: group.declaredSales === 0 ? '' : String(group.declaredSales)
                                                                                    })
                                                                                }

                                                                                onBlur={
                                                                                    () => setEditState({
                                                                                        id: null, val: ''
                                                                                    })
                                                                                }

                                                                                onChange={
                                                                                    (e) => {
                                                                                        const raw = e.target.value.replace(/[^0-9.]/g, '');

                                                                                        setEditState({
                                                                                            id: group.id, val: raw
                                                                                        });
                                                                                        handleGroupSalesChange(group.id, raw);
                                                                                    }
                                                                                }

                                                                            /> <div className="absolute right-0 -bottom-5 text-[10px] text-gray-400 opacity-0 group-hover/input:opacity-100 transition-opacity" > Excel抓取总额: $ {
                                                                                fComm(group.sales)
                                                                            }

                                                                            </div> </div> </div> {
                                                                        /* 右侧：计算结果 */
                                                                    }

                                                                    <div className="text-right min-w-[150px]" > <label className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block" >预估保费 (CNY)</label> <div className="text-2xl font-black text-gray-900 flex items-center justify-end gap-1" > <span className="text-sm text-gray-300" >¥</span> {
                                                                        fComm(group.finalGroupPrem)
                                                                    }

                                                                    </div> {
                                                                            group.isMinApplied && <span className="text-[10px] text-orange-500 font-bold bg-orange-50 px-2 rounded-full" >已应用最低保费</span>
                                                                        }

                                                                    </div> </div> {
                                                                    /* 折叠区域：SKU 明细 */
                                                                }

                                                                <details className="border-t border-gray-50 group/details" > <summary className="p-4 flex items-center justify-center cursor-pointer hover:bg-gray-50 transition-colors text-xs font-bold text-gray-400 uppercase tracking-widest select-none list-none" > <span className="group-open/details:hidden" >查看风险分析与 SKU 明细 ({
                                                                    group.items?.length

                                                                }) ▼</span> <span className="hidden group-open/details:block" >收起明细 ▲</span> </summary> <div className="p-8 bg-gray-50/50 space-y-6" > {
                                                                    /* Expert Risk Analysis Section */
                                                                }

                                                                        <div className="flex gap-4" > <div className="text-2xl mt-1" >🧐</div> <div className="space-y-2" > <h6 className="text-[10px] font-black text-gray-900 uppercase tracking-widest" >Risk Analysis (专家风险洞察)</h6> <RiskAnalysisCard analysis={
                                                                            group.items?.[0]?.deep_analysis
                                                                        }

                                                                            isHighRisk={
                                                                                isHighRisk
                                                                            }

                                                                        /> </div> </div> {
                                                                            /* SKU List */
                                                                        }

                                                                        <div className="space-y-3 pl-10" > <h6 className="text-[10px] font-black text-gray-400 uppercase tracking-widest" >Included SKUs (该类目下包含的产品)</h6> <div className="grid grid-cols-1 md:grid-cols-2 gap-2" > {
                                                                            group.items?.map((item, idx) => {

                                                                                // --- Translation Helper (Localized) ---
                                                                                // 1. Built-in Basic Dictionary (Fallback)
                                                                                const BASIC_DICT = {
                                                                                    // Tools & Hardware
                                                                                    'drill': '钻机', 'saw': '锯', 'grinder': '磨光机', 'sander': '砂光机', 'polisher': '抛光机',
                                                                                    'wrench': '扳手', 'plier': '钳子', 'screwdriver': '螺丝刀', 'hammer': '锤子', 'mallet': '槌',
                                                                                    'ratchet': '棘轮', 'socket': '套筒', 'bit': '批头', 'blade': '刀片', 'disc': '磨盘',
                                                                                    'clamp': '夹具', 'vise': '虎钳', 'tool': '工具', 'set': '套装', 'kit': '套件',
                                                                                    'screw': '螺丝', 'bolt': '螺栓', 'nut': '螺母', 'washer': '垫圈', 'nail': '钉子',
                                                                                    'hook': '挂钩', 'hinge': '铰链', 'lock': '锁', 'knob': '旋钮', 'handle': '把手',
                                                                                    // Security & Smart Home
                                                                                    'alarm': '报警器', 'security': '安防', 'camera': '摄像头', 'system': '系统', 'sensor': '传感器',
                                                                                    'detector': '探测器', 'smart': '智能', 'wifi': 'WiFi', 'remote': '遥控', 'doorbell': '门铃',
                                                                                    'siren': '警报器', 'keypad': '键盘', 'motion': '移动侦测', 'home': '家居',
                                                                                    // Electronics & Accessories
                                                                                    'battery': '电池', 'charger': '充电器', 'cable': '线缆', 'cord': '电源线', 'adapter': '适配器',
                                                                                    'plug': '插头', 'switch': '开关', 'led': 'LED灯', 'light': '灯', 'lamp': '台灯',
                                                                                    'holder': '支架', 'mount': '底座', 'stand': '立架', 'case': '保护壳', 'cover': '保护罩',
                                                                                    'screen': '屏幕', 'display': '显示器', 'mouse': '鼠标', 'keyboard': '键盘', 'pad': '垫',
                                                                                    // Automotive
                                                                                    'car': '汽车', 'auto': '汽车', 'motor': '电机', 'engine': '引擎', 'tire': '轮胎', 'wheel': '轮毂',
                                                                                    'bumper': '保险杠', 'wiper': '雨刮', 'mat': '脚垫', 'dash': '仪表盘', 'seat': '座椅',
                                                                                    // Kitchen & Household
                                                                                    'kitchen': '厨房', 'knife': '刀', 'spoon': '勺', 'fork': '叉', 'pan': '平底锅', 'pot': '锅',
                                                                                    'bottle': '瓶子', 'cup': '杯子', 'mug': '马克杯', 'glass': '玻璃杯', 'plate': '盘子',
                                                                                    'shelf': '架子', 'rack': '置物架', 'organizer': '收纳盒', 'box': '盒子', 'bag': '袋子',
                                                                                    'towel': '毛巾', 'brush': '刷子', 'mop': '拖把', 'broom': '扫帚', 'soap': '肥皂',
                                                                                    'heater': '加热器', 'fan': '风扇', 'air': '空气', 'fryer': '炸锅', 'oven': '烤箱',
                                                                                    'table': '桌子', 'chair': '椅子', 'cabinet': '柜子', 'bed': '床', 'pillow': '枕头',

                                                                                    // Mother & Baby (Expanded)
                                                                                    'baby': '婴儿', 'kid': '儿童', 'child': '孩子', 'toddler': '幼儿', 'infant': '婴幼儿',
                                                                                    'diaper': '尿布', 'wipe': '湿巾', 'bottle': '奶瓶', 'nipple': '奶嘴', 'pacifier': '安抚奶嘴',
                                                                                    'stroller': '推车', 'crib': '婴儿床', 'carrier': '背带', 'seat': '座椅', 'bib': '围兜',
                                                                                    'toy': '玩具', 'doll': '玩偶', 'game': '游戏', 'puzzle': '拼图', 'block': '积木',
                                                                                    'monitor': '监视器', 'lock': '锁', 'gate': '门栏', 'corner': '角', 'guard': '护角',

                                                                                    // Pets (Expanded)
                                                                                    'pet': '宠物', 'dog': '狗', 'cat': '猫', 'fish': '鱼', 'bird': '鸟',
                                                                                    'leash': '牵引绳', 'collar': '项圈', 'harness': '背带', 'bowl': '碗', 'feeder': '喂食器',
                                                                                    'food': '食品', 'treat': '零食', 'toy': '玩具', 'bed': '窝', 'cage': '笼子',
                                                                                    'litter': '猫砂', 'box': '砂盆', 'brush': '梳子', 'clipper': '推剪', 'shampoo': '香波',

                                                                                    // Sports & Outdoors
                                                                                    'sport': '运动', 'gym': '健身', 'fitness': '健身', 'yoga': '瑜伽', 'mat': '垫子',
                                                                                    'ball': '球', 'racket': '球拍', 'bat': '球棒', 'club': '球杆', 'net': '网',
                                                                                    'tent': '帐篷', 'camp': '露营', 'bag': '睡袋', 'backpack': '背包', 'light': '灯',
                                                                                    'bike': '自行车', 'cycle': '骑行', 'helmet': '头盔', 'lock': '锁', 'pump': '打气筒',
                                                                                    'swim': '游泳', 'pool': '泳池', 'goggle': '泳镜', 'fin': '脚蹼', 'suit': '泳衣',

                                                                                    // Beauty & Personal Care
                                                                                    'beauty': '美妆', 'makeup': '化妆', 'face': '面部', 'eye': '眼部', 'lip': '唇部',
                                                                                    'hair': '头发', 'brush': '刷子', 'comb': '梳子', 'dryer': '吹风机', 'iron': '卷发棒',
                                                                                    'nail': '指甲', 'art': '艺术', 'care': '护理', 'skin': '皮肤', 'cream': '霜',
                                                                                    'shave': '剃须', 'razor': '剃须刀', 'soap': '肥皂', 'bath': '沐浴', 'shower': '淋浴',
                                                                                    // Beauty & Personal Care
                                                                                    // Removed Duplicate Block

                                                                                    // Lingerie & Adult
                                                                                    'lingerie': '情趣内衣', 'underwear': '内裤', 'bra': '文胸', 'panty': '内裤', 'thong': '丁字裤',
                                                                                    'corset': '束胸衣', 'bodysuit': '连体衣', 'babydoll': '娃娃裙', 'teddy': '连体衣', 'nightwear': '睡衣',
                                                                                    'sex': '成人', 'toy': '玩具', 'vibrator': '震动棒', 'dildo': '假阴茎', 'masturbator': '自慰杯',
                                                                                    'adult': '成人', 'novelty': '情趣', 'plug': '塞', 'anal': '后庭', 'bondage': '束缚',
                                                                                    'women': '女士', 'men': '男士', 'female': '女性', 'male': '男性', 'sexy': '性感',
                                                                                    'set': '套装', 'lace': '蕾丝', 'mesh': '网眼', 'satin': '缎面', 'silk': '丝绸',
                                                                                    // Safety & Apparel
                                                                                    'glove': '手套', 'vest': '背心', 'jacket': '夹克', 'coat': '外套', 'boot': '靴子', 'shoe': '鞋',
                                                                                    'hat': '帽子', 'cap': '鸭舌帽', 'sock': '袜子', 'shirt': '衬衫', 'pant': '裤子',
                                                                                    'safety': '安全', 'glass': '眼镜', 'goggle': '护目镜', 'protector': '护具', 'guard': '防护罩',
                                                                                    'face': '面部', 'ear': '耳部', 'knee': '膝盖', 'elbow': '肘部',
                                                                                    // Materials & Adjectives
                                                                                    'steel': '钢', 'metal': '金属', 'wood': '木', 'plastic': '塑料', 'leather': '皮革',
                                                                                    'rubber': '橡胶', 'silicone': '硅胶', 'glass': '玻璃', 'ceramic': '陶瓷',
                                                                                    'electric': '电动', 'manual': '手动', 'cordless': '无绳', 'pneumatic': '气动',
                                                                                    'portable': '便携', 'mini': '迷你', 'heavy': '重型', 'duty': '任务', 'pro': '专业',
                                                                                    'waterproof': '防水', 'resistant': '耐受', 'proof': '防护',
                                                                                    'winter': '冬季', 'summer': '夏季', 'thermal': '保暖', 'cool': '凉爽',
                                                                                    'black': '黑', 'white': '白', 'red': '红', 'blue': '蓝', 'pink': '粉', 'purple': '紫',
                                                                                    'green': '绿', 'yellow': '黄', 'orange': '橙', 'rose': '玫瑰红'
                                                                                }

                                                                                    ;

                                                                                // 2. Merge with User Custom Dictionary (from State/LocalStorage)
                                                                                // To make this work inside map, we rely on the parent state 'customDict' passed down or accessed via closure if defined in App scope.
                                                                                // Since this map is inside render, we can access 'customDict' if it is in scope.
                                                                                // Assuming 'customDict' is essentially a JSON object like BASIC_DICT.

                                                                                const FINAL_DICT = {
                                                                                    ...BASIC_DICT, ...customDict
                                                                                }

                                                                                    ;

                                                                                // Simple Smart Translator
                                                                                const translateTitle = (text) => {
                                                                                    if (!text) return "";
                                                                                    const words = text.toLowerCase().replace(/[^a-z0-9\s]/g, ' ').split(/\s+/);
                                                                                    const matches = words.map(w => FINAL_DICT[w] || FINAL_DICT[w.replace(/s$/, '')]) // Handle simple plurals
                                                                                        .filter(Boolean);

                                                                                    if (matches.length === 0) return "";
                                                                                    // Deduplicate and join
                                                                                    return [...new Set(matches)].join(' ');
                                                                                }

                                                                                    ;

                                                                                const cnGuess = translateTitle(item.title);

                                                                                return (<div key={
                                                                                    idx
                                                                                }

                                                                                    className="flex flex-col gap-1 text-xs p-2 rounded-lg hover:bg-white transition-colors border border-transparent hover:border-gray-100 group/item" > <div className="flex items-center gap-3" > <span className="font-mono text-gray-400 font-bold bg-white px-2 py-1 rounded border border-gray-100 min-w-[50px] text-center" > {
                                                                                        item.id
                                                                                    }

                                                                                    </span> <span className="text-gray-600 font-medium truncate group-hover/item:text-blue-600 transition-colors" title={
                                                                                        item.title
                                                                                    }

                                                                                    > {
                                                                                                item.title
                                                                                            }

                                                                                        </span> </div> {
                                                                                        /* BSR & Sales Estimation Badge (Always visible if Rank exists, for comparison) */
                                                                                    }

                                                                                    {
                                                                                        item.rankValue > 0 && (<div className="pl-[62px] flex items-center gap-2 mt-1" > <div className="flex items-center bg-gray-900 text-white text-[9px] rounded-md overflow-hidden shadow-sm" > <span className="px-1.5 py-0.5 font-bold bg-gray-800 text-gray-400" >#</span> <span className="px-1.5 py-0.5 font-mono font-bold tracking-tight" > {
                                                                                            item.rankValue.toLocaleString()
                                                                                        }

                                                                                        </span> </div> <span className="text-[9px] font-bold text-orange-500 flex items-center gap-1" > <span>🪄</span> Est. $ {
                                                                                            fComm(item.estAnnualSales)
                                                                                        }

                                                                                            </span> </div>)
                                                                                    }

                                                                                    {
                                                                                        /* Chinese Translation Hint */
                                                                                    }

                                                                                    {
                                                                                        cnGuess && (<div className="pl-[62px] text-[10px] text-blue-500 font-bold flex items-center gap-1 opacity-80" > <span className="text-[8px] bg-blue-50 px-1 rounded uppercase" >CN</span> {
                                                                                            cnGuess
                                                                                        }

                                                                                        </div>)
                                                                                    }

                                                                                </div>);
                                                                            })
                                                                        }

                                                                        </div> </div> </div> </details> </div>);
                                                        })
                                                    }

                                            </div> </div> </div>)
                                }

                            </div> </div>)
                    }

                    {
                        view === 'coi' && (<div className="max-w-3xl mx-auto space-y-10 animate-in fade-in slide-in-from-bottom-4 duration-700" > <button onClick={
                            () => setView('home')
                        }

                            className="text-blue-600 font-bold text-sm flex items-center gap-2" > <span className="text-lg" >←</span> 返回主页导航 </button> <div className="apple-card p-16 text-center space-y-12 relative overflow-hidden" > <div className="space-y-4" > <div className="w-20 h-20 bg-green-50 rounded-3xl flex items-center justify-center text-4xl mx-auto" >🛡️</div> <h3 className="text-4xl font-black tracking-tight" >AI 保单合规预审</h3> <p className="text-gray-400 text-lg font-medium" >深度扫描保单，自动核对 Amazon $1, 000, 000 限额要求</p> </div> {
                                coiStep === 'idle' ? (<div onClick={
                                    () => {
                                        setCoiStep('scanning'); setTimeout(() => setCoiStep('result'), 2500)
                                    }
                                }

                                    className="group border-2 border-dashed border-gray-100 rounded-[44px] p-24 cursor-pointer hover:border-green-500 hover:bg-green-50/20 transition-all duration-500" > <div className="text-6xl mb-6 grayscale group-hover:grayscale-0 transition-all duration-500" >📤</div> <p className="text-gray-400 font-bold text-lg" >点击点击或拖拽 COI 扫描件 (PDF/JPG)</p> <p className="text-[10px] text-gray-300 font-black uppercase tracking-widest mt-6" >Secure OCR Transmission</p> </div>) : coiStep === 'scanning' ? (<div className="py-24 relative" > <div className="h-1 bg-green-500 absolute top-0 left-0 w-full animate-pulse" ></div> <p className="text-green-600 font-black text-xl animate-pulse mt-12 tracking-tight" >正在核对 Amazon.com Services LLC. 合规描述...</p> <div className="mt-8 flex justify-center gap-2" > <div className="w-2 h-2 bg-green-200 rounded-full animate-bounce delay-75" ></div> <div className="w-2 h-2 bg-green-300 rounded-full animate-bounce delay-150" ></div> <div className="w-2 h-2 bg-green-400 rounded-full animate-bounce delay-300" ></div> </div> </div>) : (<div className="text-left space-y-8 animate-in fade-in zoom-in-95 duration-500" > <div className="p-8 bg-red-50/50 border border-red-100 rounded-[40px] space-y-4" > <div className="flex items-center gap-3 text-red-600" > <span className="text-2xl" >🚨</span> <h4 className="text-xl font-black tracking-tight" >致命合规项缺失 (2)</h4> </div> <ul className="text-sm text-red-700/80 space-y-4 font-bold ml-9" > <li className="flex items-start gap-2 leading-relaxed" > <span className="mt-1.5 w-1.5 h-1.5 bg-red-500 rounded-full shrink-0" ></span> <span>保额不足：当前标准要求单次赔付限额不低于 $ {
                                        fComm(coiRules.find(r => r.id === 'limit')?.value || 1000000)
                                    }

                                        。</span> </li> <li className="flex items-start gap-2 leading-relaxed" > <span className="mt-1.5 w-1.5 h-1.5 bg-red-500 rounded-full shrink-0" ></span> <span>附加被保险人描述有误：必须包含 "{coiRules.find(r => r.id === 'holder')?.value || 'Amazon.com Services LLC'}" 等法定表述。</span> </li> </ul> </div> <div className="p-8 bg-green-50/50 border border-green-100 rounded-[40px] flex items-center gap-6" > <div className="w-12 h-12 bg-green-100 rounded-2xl flex items-center justify-center text-xl" >✅</div> <div> <h4 className="font-black text-green-900 leading-none mb-2" >免赔额合规</h4> <p className="text-sm text-green-700 font-medium" >检测结果符合不超过 $ {
                                            fComm(coiRules.find(r => r.id === 'deductible')?.value || 10000)
                                        }

                                            美金的限度要求。</p> </div> </div> <button className="w-full py-6 bg-gray-900 text-white rounded-[28px] text-lg font-black hover:bg-black transition-all shadow-xl shadow-gray-200" onClick={
                                                () => alert('修改意见已生成，请发送给您的保险经纪。')
                                            }

                                            > 获取专家修改意见 </button> </div>)
                            }

                            </div> </div>)
                    }

                    {
                        view === 'admin' && (<div className="max-w-5xl mx-auto space-y-10 animate-in fade-in duration-700" > <button onClick={
                            () => setView('home')
                        }

                            className="text-blue-600 font-bold text-sm" >← 返回主页导航</button> <div className="grid md:grid-cols-3 gap-8" > <div className="md:col-span-2 apple-card p-12 space-y-8 border-2 border-blue-500/10" > <h3 className="text-3xl font-black italic" >参数维护中心</h3> <div className="grid md:grid-cols-2 gap-8" > <div className="space-y-4" > <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest" >标准折算汇率 (USD/CNY)</label> <input type="number" step="0.01" className="w-full p-6 h-[80px] rounded-[24px] bg-gray-50 border-none font-black text-2xl text-blue-600 outline-none focus:bg-white" value={
                                exRate
                            }

                                onChange={
                                    e => setExRate(e.target.value)
                                }

                            /> </div> <div className="space-y-4" > <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest" >同步 MASTER 费率库 (.xlsx)</label> <div className="h-[80px] border-2 border-dashed border-gray-100 rounded-[24px] flex items-center justify-center bg-gray-50 relative hover:border-blue-400 transition-all cursor-pointer" > <input type="file" onChange={
                                handleAdminUpload
                            }

                                className="absolute inset-0 opacity-0 cursor-pointer" /> <span className="text-sm font-black text-gray-400" >点击上传报价规则</span> </div> </div> <div className="space-y-4 md:col-span-2" > <div className="flex justify-between items-center" > <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest" >自定义翻译词典 (Custom Dictionary)</label> <span className="text-[9px] bg-purple-100 text-purple-600 px-2 py-0.5 rounded font-bold" >Auto-Learning Active</span> </div> <div className="border-2 border-dashed border-gray-200 rounded-[24px] p-6 bg-gray-50/50 group hover:border-purple-400 transition-all space-y-8" > {
                                    /* 1. Smart Discovery Tool (Top) */
                                }

                                    <div className="space-y-4" > <div className="flex items-center justify-between" > <div className="flex items-center gap-3" > <div className="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 animate-pulse" >✨</div> <div> <h4 className="text-sm font-black text-gray-800" >未收录高频词发现 (AI Discovery)</h4> <p className="text-[9px] text-gray-400 font-bold uppercase" >系统自动扫描当前商品库，找出需翻译的生词</p> </div> </div> <span className="text-[9px] text-gray-400 bg-white px-2 py-1 rounded border border-gray-100 shadow-sm" >Real-time Analysis</span> </div> <div className="grid grid-cols-2 md:grid-cols-4 gap-2" > {
                                        (() => {

                                            // Dynamic analysis of unknown words
                                            const wordCounts = {}

                                                ;

                                            const ALL_DICT = {
                                                ... {
                                                    // Basic Stop List for simple check
                                                    ...customDict
                                                }
                                            }

                                                ;

                                            const KNOWN_ROOTS = new Set(['drill', 'saw', 'grinder', 'sander', 'polisher', 'wrench', 'plier', 'hammer', 'ratchet', 'socket', 'bit', 'blade', 'disc', 'clamp', 'vise', 'tool', 'kit', 'set',
                                                'screw', 'bolt', 'nut', 'washer', 'nail', 'hook', 'hinge', 'lock', 'knob', 'handle',
                                                'alarm', 'security', 'camera', 'system', 'sensor', 'detector', 'smart', 'wifi', 'battery', 'charger', 'cable', 'cord', 'plug', 'switch', 'led', 'light',
                                                'baby', 'diaper', 'wipe', 'bottle', 'stroller', 'crib', 'toy', 'kid', 'pet', 'dog', 'cat', 'leash', 'collar', 'food', 'bowl',
                                                'kitchen', 'knife', 'pan', 'pot', 'cup', 'mug', 'fork', 'spoon',
                                                'pcs', 'pack', 'pair', 'inch', 'cm', 'mm', 'black', 'white', 'red', 'blue', 'green', 'yellow', 'orange', 'purple', 'gray', 'grey',
                                                'and', 'for', 'with', 'the', 'pro', 'max', 'mini', 'plus', 'ultra', 'new', 'old', 'top', 'big', 'small', 'hot'
                                            ]);

                                            db.forEach(group => {
                                                group.items?.forEach(item => {
                                                    const words = item.title.toLowerCase().replace(/[^a-z0-9\s]/g, ' ').split(/\s+/);

                                                    words.forEach(w => {
                                                        if (w.length > 2 && !KNOWN_ROOTS.has(w) && !KNOWN_ROOTS.has(w.replace(/s$/, '')) && !customDict[w] && isNaN(w)) {
                                                            wordCounts[w] = (wordCounts[w] || 0) + 1;
                                                        }
                                                    });
                                                });
                                            });

                                            const sorted = Object.entries(wordCounts).sort(([, a], [, b]) => b - a).slice(0, 12);

                                            if (sorted.length === 0) return (<div className="col-span-4 p-4 text-center border border-green-100 rounded-xl bg-green-50/50 flex flex-col items-center justify-center gap-2" > <div className="text-xl text-green-500" >✅</div> <p className="text-xs font-bold text-green-700" >完美状态：所有高频词均已收录</p> </div>);

                                            return sorted.map(([word, count]) => (<button key={
                                                word
                                            }

                                                onClick={
                                                    () => {
                                                        const input = prompt(`【快速学习】\n请输入单词 "${word}" 的中文意思:`, "");

                                                        if (input) {
                                                            const newDict = {
                                                                ...customDict, [word]: input
                                                            }

                                                                ;
                                                            setCustomDict(newDict);
                                                            safeSetItem('cgl_custom_dict', newDict);
                                                        }
                                                    }
                                                }

                                                className="flex items-center justify-between bg-white hover:bg-purple-500 hover:text-white group px-3 py-2 rounded-xl border border-gray-200 hover:border-purple-500 transition-all shadow-sm text-left"

                                            > <div> <div className="font-bold text-xs" > {
                                                word
                                            }

                                            </div> <div className="text-[8px] text-gray-400 group-hover:text-purple-100" >Freq: {
                                                count
                                            }

                                                    </div> </div> <div className="w-5 h-5 rounded-full bg-gray-50 group-hover:bg-white/20 flex items-center justify-center text-gray-400 group-hover:text-white font-bold text-xs" >+</div> </button>));
                                        })()
                                    }

                                    </div> </div> <div className="w-full h-[1px] bg-gray-200" ></div> {
                                        /* 2. Manual Edit Area (Bottom) */
                                    }

                                    <div className="space-y-4" > <div className="flex gap-3 items-start" > <div className="text-xl" >📖</div> <div> <p className="text-xs font-black text-gray-900" >核心词库管理 (Manual Dictionary)</p> <p className="text-[9px] text-gray-400 font-bold uppercase" >支持批量粘贴 / 查看所有词汇 (格式: 英文=中文)</p> </div> </div> <textarea className="w-full h-32 p-4 rounded-xl bg-white border border-gray-200 text-xs font-mono text-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none"
                                        placeholder="drone=无人机&#10;scooter=滑板车"

                                        value={
                                            Object.entries(customDict || {}).map(([k, v]) => `$ {
                            k
                        }

                        =$ {
                            v
                        }

                        `).join('\n')
                                        }

                                        onChange={
                                            (e) => {
                                                const text = e.target.value;

                                                const newDict = {}

                                                    ;

                                                text.split('\n').forEach(line => {
                                                    const [key, val] = line.split('=');
                                                    if (key && val) newDict[key.trim().toLowerCase()] = val.trim();
                                                });
                                                setCustomDict(newDict);
                                                safeSetItem('cgl_custom_dict', newDict);
                                            }
                                        }

                                    /> </div> </div> </div> <div className="space-y-4 md:col-span-2" > <div className="flex justify-between items-center" > <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest" >专家知识库管理 (Knowledge Base)</label> <button onClick={
                                        () => setShowImporter(!showImporter)
                                    }

                                        className="text-[10px] font-bold text-blue-500 hover:text-blue-700 transition-colors" > {
                                            showImporter ? '收起导入器' : '展开导入器'
                                        }

                                    </button> </div> {
                                        /* KB Importer Zone */
                                    }

                                    {
                                        !showImporter ? (<div onClick={
                                            () => setShowImporter(true)
                                        }

                                            className="border-2 border-dashed border-gray-100 rounded-[24px] p-6 bg-gray-50 flex items-center justify-between group hover:border-indigo-400 transition-all cursor-pointer relative" > <div className="flex gap-6 items-center" > <div className="text-2xl" >📚</div> <div className="text-left" > <p className="text-xs font-black text-gray-900" >导入专家核保知识 (.zip)</p> <p className="text-[9px] text-gray-400 font-bold uppercase tracking-widest" >一键解析 Word 文档，更新风险洞察库</p> </div> </div> <span className="px-4 py-2 bg-white border rounded-xl text-[10px] font-black group-hover:bg-indigo-500 group-hover:text-white transition-all shadow-sm" >IMPORT</span> </div>) : (<KnowledgeImporter onImportSuccess={
                                                () => {
                                                    refreshDB(); addLog('KB Import', '成功更新了专家知识库');
                                                }
                                            }

                                            />)
                                    }

                                </div> <div className="space-y-4 md:col-span-2" > <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest" >客户分发管理 (Distribution Settings)</label> <div className="p-8 bg-blue-600 rounded-[32px] text-white flex justify-between items-center shadow-xl shadow-blue-100" > <div className="space-y-2" > <h4 className="text-xl font-bold" >导出分发版 HTML</h4> <p className="text-blue-100 text-xs font-medium" >导出后，文件将内置您当前的费率库逻辑。发送给客户即可直接使用。</p> </div> <button onClick={
                                    downloadDistributionFile
                                }

                                    className="px-8 py-4 bg-white text-blue-600 rounded-2xl font-black text-sm hover:bg-blue-50 transition-all" >一键导出</button> </div> </div> </div> </div> <div className="apple-card p-10 bg-gray-900 text-white flex flex-col justify-center gap-6" > <div><p className="text-[9px] opacity-40 uppercase font-black" >Database Rows</p><p className="text-4xl font-black" > {
                                        db.length
                                    }

                                    </p></div> <div className="h-[1px] bg-white/10 w-full" ></div> <div><p className="text-[9px] opacity-40 uppercase font-black" >Audit Entries</p><p className="text-4xl font-black" > {
                                        logs.length
                                    }

                                    </p></div> </div> </div> <div className="log-window no-scrollbar max-h-[400px] overflow-y-auto" > <p className="text-[10px] text-gray-500 mb-8 font-black uppercase text-center border-b border-white/5 pb-4" >System Event Log</p> {
                                        logs.map(log => (<div key={
                                            log.id
                                        }

                                            className="flex justify-between items-center py-4 border-b border-white/5" > <div> <span className="text-blue-500 font-black text-[9px] tracking-widest uppercase mr-3" > {
                                                log.type
                                            }

                                            </span> <span className="text-white/80 font-medium text-sm" > {
                                                log.detail
                                            }

                                                </span> </div> <span className="text-white/20 text-[9px] font-mono" > {
                                                    log.time
                                                }

                                            </span> </div>))
                                    }

                            </div> </div>)
                    }

                </main> </div>);
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>

</html>