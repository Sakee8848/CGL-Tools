<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>äºšé©¬é€Š CGL æ™ºèƒ½ä½“ - æ——èˆ°åˆè§„ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.5.1/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            background-color: #F5F5F7;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .apple-card {
            background: white;
            border-radius: 28px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.4s ease;
        }

        .log-window {
            background: #1d1d1f;
            color: #00ff00;
            font-family: ui-monospace, monospace;
            font-size: 11px;
            border-radius: 16px;
            padding: 20px;
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Helper to estimate sales from Amazon Best Seller Rank (BSR)
        // Model: Power Law Distribution
        // Disclaimer: This is a rough heuristic for estimation purposes only.
        const estimateAnnualSalesFromBSR = (rank) => {
            const r = parseInt(rank);
            if (!r || r <= 0) return 0;
            // Formula: Monthly Sales ~= 60000 * Rank ^ (-0.85)
            // Adjusted for broader category average.
            const monthly = 60000 * Math.pow(r, -0.85);
            return Math.floor(monthly * 12);
        };

        const fComm = (val) => {
            if (val === undefined || val === null || isNaN(val)) return "0";
            return new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(val);
        };

        // Helper to safely access localStorage (sandboxed iframe compatible)
        const safeGetItem = (key, defaultVal) => {
            try {
                if (typeof window !== 'undefined' && window.localStorage) {
                    const val = localStorage.getItem(key);
                    return val ? JSON.parse(val) : defaultVal;
                }
            } catch (e) {
                console.warn(`LocalStorage access failed for key ${key}:`, e);
            }
            return defaultVal;
        };

        const safeSetItem = (key, val) => {
            try {
                if (typeof window !== 'undefined' && window.localStorage) {
                    localStorage.setItem(key, typeof val === 'string' ? val : JSON.stringify(val));
                }
            } catch (e) {
                console.warn(`LocalStorage write failed for key ${key}:`, e);
            }
        };

        // åˆå§‹åŒ–æ•°æ®åº“ï¼šåŒ…å«æ›´ä¸°å¯Œçš„äº”é‡‘ã€å·¥å…·ä¸é£é™©å“ç±»åº“ï¼Œä»¥åŠæ·±åº¦ä¸“å®¶æ´å¯Ÿ (Deep Expert Insights)
        const DEFAULT_DB = [
            // === é«˜é£é™©/æ‹’ä¿ç±» (High Risk / Excluded) ===
            {
                id: '11213',
                cat: 'ç„Šæ¥è®¾å¤‡/Welding & Soldering',
                cls: 'Excluded',
                rate: 0.05,
                min: 10000,
                keywords: 'welder,welding,soldering,plastic welder,arc weld,spot welder,mig welder,tig welder,plasma cutter',
                deep_analysis: {
                    focus: `<strong>é«˜èƒ½çƒ­æºä¸ç”µæ°”é£é™©ï¼š</strong>ç„Šæ¥è®¾å¤‡ä¸ä»…ä»…å› é«˜æ¸©ç†”èé‡‘å±æ„æˆç›´æ¥ç«ç¾éšæ‚£ï¼Œå…¶ç¬é—´é«˜å‹ç”µå¼§æ›´å¯èƒ½å¯¼è‡´ä¸¥é‡çš„æ“ä½œè€…ç”µå‡»ã€‚<ul><li><strong>ç«ç¾è”“å»¶ï¼š</strong>ç„Šæ¥é£æº…ç‰©(Spatter)é€šå¸¸è¶…è¿‡1500Â°Cï¼Œå¯å¼•ç‡ƒæ•°ç±³å¤–çš„éšè”½å¯ç‡ƒç‰©ã€‚</li><li><strong>çƒŸå°˜æ¯’æ€§ï¼š</strong>é•¿æœŸå¸å…¥ç„Šæ¥çƒŸå°˜(Fume)ç‰¹åˆ«æ˜¯é•€é”Œç®¡ç„Šæ¥äº§ç”Ÿçš„æ°§åŒ–é”Œï¼Œå¯å¯¼è‡´é‡‘å±çƒŸçƒ­ç—…(Metal Fume Fever)ç”šè‡³æ°¸ä¹…æ€§è‚ºæŸä¼¤ã€‚</li><li><strong>å…‰è¾å°„ï¼š</strong>å¼ºç´«å¤–çº¿ä¼šå¯¼è‡´"ç”µå…‰æ€§çœ¼ç‚"(Arc Eye)åŠçš®è‚¤ç¼ä¼¤ã€‚</li></ul>`,
                    cases: `<ul>
                                <li><strong>2021å¹´åŠ å·è½¦åº“ç«ç¾æ¡ˆ (èµ”ä»˜ $1.2M)ï¼š</strong> ä¸€åä¸šä½™DIYç”¨æˆ·åœ¨ä½¿ç”¨ä¾¿æºå¼MIGç„Šæœºä¿®å¤å›´æ æ—¶ï¼Œæœªæ³¨æ„æ¸…ç†å‘¨è¾¹çš„æ²¹æ¼†ç¨€é‡Šå‰‚æŠ¹å¸ƒã€‚é£æº…ç«èŠ±å¼•ç‡ƒæŠ¹å¸ƒï¼Œç«åŠ¿è¿…é€Ÿè”“å»¶è‡³æ•´ä¸ªè½¦åº“åŠé‚»å±…å®¶ã€‚è¯‰è®¼æŒ‡æ§äº§å“æœªæä¾›è¶³å¤Ÿçš„"æ¸…ç†ä½œä¸šç¯å¢ƒ"è­¦ç¤ºã€‚</li>
                                <li><strong>2019å¹´ä¼Šåˆ©è¯ºä¼Šå·ç”µå‡»æ¡ˆ (èµ”ä»˜ $850K)ï¼š</strong> å·¥äººåœ¨æ½®æ¹¿ç¯å¢ƒä¸‹ä½¿ç”¨å»‰ä»·é€†å˜ç„Šæœºï¼Œå› è®¾å¤‡å†…éƒ¨ç»ç¼˜è€åŒ–æ¼ç”µï¼Œå¯¼è‡´å…¶è§¦ç”µèº«äº¡ã€‚æ³•åŒ»é‰´å®šæ˜¾ç¤ºè®¾å¤‡æœªè¾¾IP23é˜²æŠ¤ç­‰çº§ã€‚</li>
                                <li><strong>2018å¹´çº½çº¦çƒŸå°˜ä¸­æ¯’é›†ä½“è¯‰è®¼ï¼š</strong> æŸå·¥ä¸šç„Šæœºå“ç‰Œå› æœªåœ¨è¯´æ˜ä¹¦ä¸­æ˜ç¡®å»ºè®®ä½©æˆ´å‘¼å¸é˜²æŠ¤ï¼Œå¯¼è‡´å¤šåå·¥äººç¡®è¯Šé”°ä¸­æ¯’(Manganism)ï¼Œå¼•å‘åƒä¸‡çº§é›†ä½“ç´¢èµ”ã€‚</li>
                            </ul>`,
                    mitigation: "å»ºè®®ï¼šä»…æ‰¿ä¿å®¶ç”¨å°å‹è®¾å¤‡ï¼Œå¿…é¡»å¼ºåˆ¶è¦æ±‚ ANSI Z49.1 åˆè§„ï¼Œå¹¶åœ¨æ˜¾çœ¼ä½ç½®å¼ è´´ 'ä½©æˆ´å‘¼å¸é˜²æŠ¤' ä¸ 'æ¸…ç†æ˜“ç‡ƒç‰©' çš„è­¦å‘Šæ ‡ç­¾ã€‚"
                }
            },
            {
                id: '10203',
                cat: 'ç”µæ± /Battery Packs',
                cls: 'C',
                rate: 0.012,
                min: 6500,
                keywords: 'battery,lithium,power bank,18650,lipo,battery pack,laptop battery,ebike battery',
                deep_analysis: {
                    focus: `<strong>çƒ­å¤±æ§ (Thermal Runaway) åŠå…¶è¿é”ååº”ï¼š</strong> é”‚ç¦»å­ç”µæ± çš„æ ¸å¿ƒé£é™©åœ¨äºå…¶é«˜èƒ½é‡å¯†åº¦ä¸ç”µè§£æ¶²çš„æ˜“ç‡ƒæ€§ã€‚ä¸€æ—¦å‘ç”Ÿå†…çŸ­è·¯ï¼ˆå¦‚ææ™¶ç”Ÿé•¿ç©¿åˆºéš”è†œï¼‰æˆ–å¤–åŠ›æŸä¼¤ï¼Œç”µæ± ä¼šåœ¨æ•°ç§’å†…æ¸©åº¦é£™å‡è‡³600Â°Cä»¥ä¸Šï¼Œå¹¶å–·å°„å‡ºæ°¢æ°”ã€ç”²çƒ·ç­‰å¯ç‡ƒæ°”ä½“ï¼Œå¯¼è‡´çŒ›çƒˆçš„å–·å°„ç«æˆ–çˆ†ç‚¸ã€‚æ­¤è¿‡ç¨‹å‡ ä¹æ— æ³•é€šè¿‡å¸¸è§„ç­ç«å™¨æ‰‘ç­ã€‚`,
                    cases: `<ul>
                                <li><strong>2023å¹´çº½çº¦ç”µåŠ¨å•è½¦ç«ç¾ (é€ æˆ4äººæ­»äº¡)ï¼š</strong> ä¸€å®¶ç”µåŠ¨è‡ªè¡Œè½¦ç»´ä¿®åº—å› è¿‡å¤œå……ç”µå»‰ä»·ç¿»æ–°ç”µæ± å¼•å‘ç«ç¾ï¼Œç«åŠ¿ç¬é—´åå™¬æ¥¼ä¸Šå…¬å¯“ã€‚è°ƒæŸ¥å‘ç°ç”µæ± ç¼ºä¹BMS(ç”µæ± ç®¡ç†ç³»ç»Ÿ)çš„è¿‡å……ä¿æŠ¤åŠŸèƒ½ã€‚</li>
                                <li><strong>2016å¹´ä¸‰æ˜ŸNote 7äº‹ä»¶ (å¬å›æˆæœ¬$53äº¿)ï¼š</strong> è™½ç„¶æ˜¯çŸ¥åå“ç‰Œï¼Œä½†å› ç”µæ± ä»“è®¾è®¡é¢„ç•™ç©ºé—´ä¸è¶³å¯¼è‡´è´Ÿææ¿å—å‹å˜å½¢çŸ­è·¯ã€‚æ­¤æ¡ˆå½»åº•æ”¹å˜äº†æ¶ˆè´¹ç”µå­è¡Œä¸šçš„ç”µæ± æµ‹è¯•æ ‡å‡†ã€‚</li>
                                <li><strong>2020å¹´èˆªç©ºè´§è¿ç«ç¾ï¼š</strong> ä¸€æ‰¹æœªç”³æŠ¥çš„é”‚ç”µæ± åœ¨è´§èˆ±å†…è‡ªç‡ƒï¼Œå¯¼è‡´é£æœºç´§æ€¥è¿«é™ã€‚æ¶‰äº‹è´§ä»£ä¸åˆ¶é€ å•†é¢ä¸´FAAå·¨é¢ç½šæ¬¾åŠåˆ‘äº‹æŒ‡æ§ã€‚</li>
                            </ul>`,
                    mitigation: "åˆè§„å»ºè®®ï¼šå¿…é¡»æä¾›å®Œæ•´çš„ UN38.3 è¿è¾“æŠ¥å‘Šï¼Œç”µèŠ¯éœ€è¿‡ UL 1642ï¼Œç”µæ± åŒ…éœ€è¿‡ UL 2054ã€‚å¿…é¡»åœ¨äº§å“ä¸Šæ ‡æ³¨'åˆ‡å‹¿è¿‡å……'åŠ'å‘ç°é¼“åŒ…ç«‹å³åœæ­¢ä½¿ç”¨'çš„è­¦ç¤ºã€‚"
                }
            },
            {
                id: '12240',
                cat: 'å¤´ç›”/Helmets',
                cls: 'C',
                rate: 0.015,
                min: 8000,
                keywords: 'helmet,safety hat,protective headwear,bike helmet,motorcycle helmet,ski helmet',
                deep_analysis: {
                    focus: `<strong>é˜²æŠ¤å¤±æ•ˆä¸è™šå‡å®‰å…¨æ„Ÿï¼š</strong> å¤´ç›”ä¸ä»…æ˜¯ç‰©ç†å±éšœï¼Œæ›´æ˜¯èƒ½é‡å¸æ”¶ç³»ç»Ÿã€‚å¦‚æœEPSæ³¡æ²«å¯†åº¦ä¸å‡æˆ–å¤–å£³åœ¨å†²å‡»ä¸‹è¿‡æ—©ç¢è£‚ï¼Œå°†æ— æ³•æœ‰æ•ˆç¼“å†²æ’å‡»åŠ›ï¼Œå¯¼è‡´æ¯”"æœªæˆ´å¤´ç›”"æ›´ä¸¥é‡çš„æ³•å¾‹åæœâ€”â€”å› ä¸ºç”¨æˆ·æ˜¯åŸºäºä¿¡ä»»æ‰è´­ä¹°çš„ã€‚æ ¸å¿ƒé£é™©æ˜¯é¢…è„‘æŸä¼¤(TBI)å¸¦æ¥çš„ç»ˆèº«æŠ¤ç†è´¹ç”¨ç´¢èµ”ã€‚`,
                    cases: `<ul>
                                <li><strong>2018å¹´ä½›ç½—é‡Œè¾¾æ‘©æ‰˜è½¦äº‹æ•… (èµ”ä»˜ $3.5M)ï¼š</strong> éª‘æ‰‹åœ¨ä½é€Ÿç¢°æ’ä¸­è„‘éƒ¨ä¸¥é‡å—æŸã€‚æµ‹è¯•å‘ç°è¯¥å¤´ç›”è™½ç„¶è´´æœ‰DOTæ ‡ç­¾ï¼Œä½†å¹¶æœªé€šè¿‡ç©¿åˆºæµ‹è¯•ï¼Œä¸”ç³»å¸¦æ‰£åœ¨æ’å‡»ç¬é—´æ–­è£‚è„±è½ï¼Œå¯¼è‡´å¤´ç›”é£å‡ºã€‚</li>
                                <li><strong>2020å¹´æ»‘é›ªå¤´ç›”è„‘éœ‡è¡æ¡ˆï¼š</strong> æ»‘é›ªè€…ä½©æˆ´ä¸çŸ¥åå“ç‰Œå¤´ç›”æ’å‡»æ ‘å¹²åæ˜è¿·ã€‚CTæ‰«ææ˜¾ç¤ºå¤´ç›”å†…éƒ¨æ³¡æ²«å‡ ä¹æœªå‘ç”Ÿå½¢å˜å¸æ”¶èƒ½é‡ï¼Œè€Œæ˜¯ç›´æ¥å°†å†²å‡»åŠ›ä¼ å¯¼è‡³å¤´éª¨ã€‚</li>
                            </ul>`,
                    mitigation: "å¿…é¡»æ‹¥æœ‰ç¬¬ä¸‰æ–¹å®éªŒå®¤å‡ºå…·çš„ DOT (FMVSS 218) æˆ– ECE 22.05 æµ‹è¯•æŠ¥å‘Šã€‚è‡ªè¡Œè½¦å¤´ç›”éœ€ç¬¦åˆ CPSC 1203 æ ‡å‡†ã€‚"
                }
            },
            {
                id: '90001',
                cat: 'å„¿ç«¥ç©å…·/Toys',
                cls: 'C',
                rate: 0.010,
                min: 6000,
                keywords: 'toy,plush,kids,children,doll,lego,blocks,puzzle,baby',
                deep_analysis: {
                    focus: `<strong>æœºæ¢°çª’æ¯ä¸éšå½¢åŒ–å­¦æ¯’å®³ï¼š</strong> å„¿ç«¥äº§å“çš„å®¹é”™ç‡ä¸ºé›¶ã€‚
                            <ul>
                            <li><strong>å°éƒ¨ä»¶ (Small Parts)ï¼š</strong> 3å²ä»¥ä¸‹å„¿ç«¥ä¸ä»…ä¼šåé£Ÿï¼Œè¿˜å¯èƒ½å¡å…¥é¼»å­”è€³é“ã€‚ä»»ä½•èƒ½æ”¾å…¥"å°éƒ¨ä»¶æµ‹è¯•ç­’"çš„é›¶ä»¶æœªåŠ è­¦ç¤ºå‡ä¸ºä¸¥é‡è¿è§„ã€‚</li>
                            <li><strong>ç»³ç´¢å‹’æ€ï¼š</strong> æ‹–æ‹‰ç©å…·ç»³ç´¢è¿‡é•¿å¯èƒ½ç¼ ç»•é¢ˆéƒ¨ã€‚</li>
                            <li><strong>ç£åŠ›ç é£é™©ï¼š</strong> åé£Ÿå¤šé¢—å¼ºåŠ›ç£ç ä¼šåœ¨è‚ é“å†…ç›¸å¸ç©¿å­”ï¼Œå¼•å‘å±åŠç”Ÿå‘½çš„è…¹è†œç‚ã€‚</li>
                            </ul>`,
                    cases: `<ul>
                                <li><strong>2012å¹´ç£åŠ›ç è‡´æ­»æ¡ˆï¼š</strong> ä¸€å2å²å„¿ç«¥è¯¯å7é¢—å·´å…‹çƒ(Buckyballs)ï¼Œé€ æˆè‚ ç©¿å­”æ­»äº¡ã€‚æ­¤æ¡ˆå¯¼è‡´CPSCå¯¹é«˜ç£é€šé‡ç£é“å®æ–½äº†å¤šå¹´çš„ç¦ä»¤ã€‚</li>
                                <li><strong>2021å¹´äºšé©¬é€Šä¸‹æ¶é£æ³¢ï¼š</strong> æ•°ä¸‡æ¬¾ä¸­å›½äº§æ³°è¿ªç†Šå› çœ¼ç›çº½æ‰£æ‹‰åŠ›æµ‹è¯•æœªè¾¾æ ‡ï¼ˆæ˜“è„±è½è¢«åé£Ÿï¼‰è¢«å¼ºåˆ¶ä¸‹æ¶å¬å›ã€‚</li>
                                <li><strong>2019å¹´é‚»è‹¯äºŒç”²é…¸é…¯è¶…æ ‡æ¡ˆï¼š</strong> æŸå¡‘èƒ¶æ´—æ¾¡é¸­è¢«æ£€å‡ºå¢å¡‘å‰‚è¶…æ ‡200å€ï¼Œå¯èƒ½å¹²æ‰°å„¿ç«¥å†…åˆ†æ³Œç³»ç»Ÿï¼Œå¼•å‘å¤§è§„æ¨¡æ¶ˆè´¹è€…é›†ä½“è¯‰è®¼ã€‚</li>
                            </ul>`,
                    mitigation: "å¼ºåˆ¶è¦æ±‚ CPC (Children's Product Certificate)ï¼Œå¹¶åŸºäº CPSC è®¤å¯å®éªŒå®¤çš„ ASTM F963-17 æµ‹è¯•æŠ¥å‘Šã€‚ç‰¹åˆ«å…³æ³¨é‡é‡‘å±ï¼ˆé“…ï¼‰ä¸é‚»è‹¯äºŒç”²é…¸é…¯å«é‡ã€‚"
                }
            },
            {
                id: '11113',
                cat: 'åŠ çƒ­è®¾å¤‡/Heating Equipment',
                cls: 'A',
                rate: 0.0035,
                min: 5500,
                keywords: 'heater,garage heater,space heater,fireplace,stove,electric blanket,heating pad',
                deep_analysis: {
                    focus: `<strong>æ— äººçœ‹ç®¡ä¸‹çš„è¿‡çƒ­èµ·ç«ï¼š</strong> åŠ çƒ­ç±»ç”µå™¨çš„æ ¸å¿ƒé£é™©åœ¨äºæ¸©æ§å™¨å¤±æ•ˆã€‚å¦‚æœç»§ç”µå™¨ç²˜è¿å¯¼è‡´æŒç»­åŠ çƒ­ï¼Œæˆ–å€¾å€’ä¿æŠ¤å¼€å…³è®¾è®¡ä½ç½®ä¸å½“ï¼ˆåœ¨åœ°æ¯¯ä¸Šå¤±æ•ˆï¼‰ï¼Œææ˜“åœ¨æ·±å¤œå¼•å‘ç«ç¾ã€‚æ­¤å¤–ï¼Œé•¿æœŸä½¿ç”¨çš„ç”µæºçº¿è€åŒ–å‘çƒ­ä¹Ÿæ˜¯ä¸»è¦éšæ‚£ã€‚`,
                    cases: `<ul>
                                <li><strong>2022å¹´å¸ƒæœ—å…‹æ–¯å…¬å¯“å¤§ç« (17äººæ­»äº¡)ï¼š</strong> è°ƒæŸ¥ç¡®è®¤èµ·ç«æºä¸ºä¸€å°è¿ç»­è¿è¡Œæ•°å¤©çš„æ•…éšœç”µæš–æ°”ã€‚è¯¥è®¾å¤‡æœªèƒ½åœ¨è¿‡çƒ­æ—¶è‡ªåŠ¨åˆ‡æ–­ç”µæºï¼Œå¼•ç‡ƒäº†å‘¨å›´çš„åºŠå«ã€‚æ­¤æ¡ˆå¼•å‘äº†å¯¹å»‰ä»·ç”µæš–å™¨å®‰å…¨æ ‡å‡†çš„å…¨å›½æ€§å®¡æŸ¥ã€‚</li>
                                <li><strong>2020å¹´ç”µçƒ­æ¯¯ç¼ä¼¤æ¡ˆï¼š</strong> ç³–å°¿ç—…æ‚£è€…å› æœ«æ¢¢ç¥ç»æ„Ÿè§‰è¿Ÿé’ï¼Œæ•´å¤œä½¿ç”¨è¿‡çƒ­çš„ç”µçƒ­æ¯¯å¯¼è‡´åŒè…¿æ·±åº¦ä¸‰åº¦çƒ§ä¼¤ã€‚è¯‰è®¼æŒ‡æ§äº§å“ç¼ºä¹"è‡ªåŠ¨å®šæ—¶å…³é—­"åŠŸèƒ½ä¸”è­¦ç¤ºè¯´æ˜å­—ä½“è¿‡å°ã€‚</li>
                            </ul>`,
                    mitigation: "äº§å“å¿…é¡»å…·å¤‡åŒé‡å†—ä½™ä¿æŠ¤ï¼šç”µå­æ¸©æ§ + æœºæ¢°å¼è¿‡çƒ­ç†”æ–­å™¨ã€‚å¿…é¡»é€šè¿‡ UL 1278 (ç§»åŠ¨å¼åŠ çƒ­å™¨) æ ‡å‡†æµ‹è¯•ã€‚"
                }
            },
            {
                id: '11209', cat: 'ç”µåŠ¨å·¥å…·/Power Tools', cls: 'A', rate: 0.0030, min: 5000, keywords: 'spray gun,paint sprayer,drill,saw,grinder,sander,power tool,impact driver,circular saw',
                deep_analysis: {
                    focus: `<strong>é«˜é€Ÿæ—‹è½¬ä»¶çš„åˆ‡å‰²ä¸æŠ›å°„é£é™©ï¼š</strong> ç ‚è½®æœºã€åœ†é”¯ç­‰å·¥å…·è½¬é€Ÿé«˜è¾¾10,000 RPMä»¥ä¸Šã€‚ä¸€æ—¦ç ‚è½®ç‰‡ç ´è£‚ï¼Œç¢ç‰‡åŠ¨èƒ½å ªæ¯”å­å¼¹ã€‚å¦ä¸€å¤§é£é™©æ˜¯"åå†² (Kickback)"â€”â€”é”¯ç‰‡å¡æ­»å¯¼è‡´å·¥å…·ç¬é—´åå¼¹å‡»ä¸­æ“ä½œè€…é¢éƒ¨ã€‚`,
                    cases: `<ul>
                                <li><strong>2017å¹´ç ‚è½®æœºç¢ç‰‡è‡´ç›²æ¡ˆï¼š</strong> æ“ä½œè€…è™½ä½©æˆ´æŠ¤ç›®é•œï¼Œä½†é«˜é€Ÿé£å‡ºçš„ç ‚è½®ç¢ç‰‡å‡»ç©¿äº†æ™®é€šPCé•œç‰‡åˆºå…¥çœ¼çƒã€‚æ³•é™¢åˆ¤å†³è®¤ä¸ºäº§å“åŒ…è£…æœªæ˜ç¡®å»ºè®®ä½¿ç”¨"å…¨å°é—­é¢ç½©"å±äºè­¦ç¤ºç¼ºé™·ã€‚</li>
                                <li><strong>2021å¹´å°é”¯æ–­æŒ‡æ¡ˆï¼š</strong> æœ¨å·¥åœ¨ä½¿ç”¨æœªé…å¤‡ SawStop æŠ€æœ¯çš„å°é”¯æ—¶æ‰‹æŒ‡è¢«åˆ‡æ–­ã€‚è™½ç„¶äº§å“ç¬¦åˆå½“æ—¶æ ‡å‡†ï¼Œä½†é™ªå®¡å›¢è®¤ä¸ºç°æœ‰æ›´å®‰å…¨çš„æŠ€æœ¯æœªè¢«é‡‡ç”¨æ„æˆäº†"è®¾è®¡ç¼ºé™·"ã€‚</li>
                            </ul>`,
                    mitigation: "è­¦ç¤ºè¯­å¿…é¡»åŒ…å« ANSI Z87.1 æŠ¤ç›®é•œè¦æ±‚ã€‚å¯¹äºæ‰‹æŒåˆ‡å‰²å·¥å…·ï¼Œå¿…é¡»è®¾è®¡æœ‰Dead-man Switch (ç¦»æ‰‹å³åœå¼€å…³)ã€‚"
                }
            },
            {
                id: '10406',
                cat: 'å®¶ç”¨ç”µå™¨(åŠ çƒ­)/Appliances-Heat',
                cls: 'A',
                rate: 0.0025,
                min: 4800,
                keywords: 'oven,toaster,fryer,kettle,coffee maker,air fryer,rice cooker,sous vide',
                deep_analysis: {
                    focus: `<strong>å¨æˆ¿ç¯å¢ƒä¸‹çš„æ°´ç«é£é™©ï¼š</strong> æ¶‰åŠæ°´ã€ç”µã€æ²¹ã€ç«çš„æ··åˆåœºæ™¯ã€‚ç©ºæ°”ç‚¸é”…ç§¯æ²¹å¼•ç‡ƒã€å‹åŠ›é”…ç›–é£å‡ºçˆ†ç‚¸ã€ç”µæ°´å£¶è’¸æ±½çƒ«ä¼¤æ˜¯ä¸‰å¤§é«˜é¢‘äº‹æ•…ã€‚æ­¤å¤–ï¼Œç”µæºçº¿è¿‡çŸ­æˆ–æ— æ¥åœ°ä¿æŠ¤ä¹Ÿæ˜¯å¸¸è§ä¸åˆè§„ç‚¹ã€‚`,
                    cases: `<ul>
                                <li><strong>2023å¹´ç©ºæ°”ç‚¸é”…å¬å›äº‹ä»¶ï¼š</strong> æŸçŸ¥åå“ç‰Œå¬å›200ä¸‡å°ç‚¸é”…ï¼Œå› å†…éƒ¨ç”µçº¿è¿æ¥å™¨è¿‡çƒ­ç†”åŒ–å¯¼è‡´ç«ç¾é£é™©ã€‚å·²æœ‰205èµ·ç‡ƒçƒ§æŠ¥å‘Šã€‚</li>
                                <li><strong>2019å¹´é«˜å‹é”…çˆ†ç‚¸æ¡ˆ (èµ”ä»˜ $2.1M)ï¼š</strong> ç”¨æˆ·åœ¨æœªå®Œå…¨æ³„å‹æ—¶å¼ºè¡Œæ‰“å¼€é”…ç›–ï¼ˆå®‰å…¨é”å¤±æ•ˆï¼‰ï¼Œæ»šçƒ«çš„é£Ÿç‰©å–·å°„å¯¼è‡´å…¨èº«60%é¢ç§¯ä¸¥é‡çƒ«ä¼¤ã€‚</li>
                            </ul>`,
                    mitigation: "éœ€ç¬¦åˆ UL 1026 (çƒ¹é¥ªç”µå™¨) æ ‡å‡†ã€‚å‹åŠ›å®¹å™¨ç±»äº§å“å¿…é¡»æœ‰å¤šé‡ç‰©ç†è”é”è£…ç½®é˜²æ­¢å¸¦å‹å¼€ç›–ã€‚"
                }
            },
            {
                id: '11210', cat: 'æ‰‹åŠ¨å·¥å…·/Hand Tools', cls: 'B', rate: 0.0012, min: 4500, keywords: 'wrench,plier,screwdriver,hammer,tap and die,nut driver,pipe threading,socket set,hex key,allen key,security bit,knife,axe,multitool',
                deep_analysis: {
                    focus: `<strong>æè´¨ç¼ºé™·ä¸æ„å¤–æ–­è£‚ï¼š</strong> è™½ç„¶æ— åŠ¨åŠ›æºï¼Œä½†æ‰‹åŠ¨å·¥å…·åœ¨é«˜è´Ÿè½½ä¸‹ï¼ˆå¦‚é”¤å‡»ã€å¤§åŠ›æ‹§ç´§ï¼‰é‡‘å±ç–²åŠ³æ–­è£‚æ˜¯ç”±äºçƒ­å¤„ç†å·¥è‰ºä¸å½“é€ æˆçš„ã€‚å´©é£çš„é‡‘å±ç¢ç‰‡å¯èƒ½è‡´ç›²ã€‚åˆ€å…·ç±»äº§å“åˆ™æ¶‰åŠé”å®šæœºæ„å¤±æ•ˆå¯¼è‡´çš„å‰²ä¼¤ã€‚`,
                    cases: `<ul>
                                <li><strong>2015å¹´æŠ˜å åˆ€ä¼¤æ‰‹æ¡ˆï¼š</strong> ç”¨æˆ·åœ¨ä½¿ç”¨æŠ˜å åˆ€ç”¨åŠ›åˆ‡å‰Šæ—¶ï¼Œé”å®šç‰‡å¤±æ•ˆå¯¼è‡´åˆ€åˆƒæŠ˜å›åˆ‡æ–­è‚Œè…±ã€‚</li>
                                <li><strong>2020å¹´æ‰³æ‰‹æ–­è£‚æ¡ˆï¼š</strong> æ±½ä¿®å·¥å…¨åŠ›æ‹§èºä¸æ—¶æ‰³æ‰‹å¡å£æ–­è£‚ï¼Œå¯¼è‡´æ‰‹éƒ¨é‡é‡æ’å‡»é‡‘å±é”è¾¹é€ æˆéª¨æŠ˜ã€‚</li>
                            </ul>`,
                    mitigation: "ç¡®ä¿é‡‘ç›¸çƒ­å¤„ç†å·¥è‰ºç¨³å®šã€‚åˆ€å…·ç±»å¿…é¡»é€šè¿‡é”å®šå¼ºåº¦æµ‹è¯•ã€‚"
                }
            },
            {
                id: '10905', cat: 'å·¥ä½œæœä¸åŠ³ä¿/Work Clothes', cls: 'B', rate: 0.0015, min: 4200, keywords: 'glove,work glove,safety vest,apron,uniform,safety shoes,boots',
                deep_analysis: {
                    focus: `<strong>è™šå‡é˜²æŠ¤æ‰¿è¯ºï¼š</strong> å¦‚æœä»…ä½œä¸ºæ™®é€šè¡£ç‰©é”€å”®é£é™©è¾ƒä½ã€‚ä½†ä¸€æ—¦æ ‡æ¦œ"é˜²å‰²" (Cut Resistant)ã€"é˜»ç‡ƒ" (FR)ã€"ç»ç¼˜" (Dielectric) ç­‰ä¸“ä¸šé˜²æŠ¤åŠŸèƒ½ï¼Œè‹¥å®é™…æœªè¾¾æ ‡ï¼Œå°†å¯¼è‡´ç”¨æˆ·åœ¨å±é™©ç¯å¢ƒä¸­å¤±å»é¢„æœŸçš„æœ€åä¸€é“é˜²çº¿ã€‚`,
                    cases: `<ul>
                                <li><strong>2018å¹´é˜²å‰²æ‰‹å¥—å¤±æ•ˆæ¡ˆï¼š</strong> å± å®°åœºå·¥äººåœ¨ä½©æˆ´æ ‡ç§°ANSI A4çº§é˜²å‰²æ‰‹å¥—å·¥ä½œæ—¶ä»è¢«åˆ©åˆƒå‰²ä¼¤ç¥ç»ã€‚æµ‹è¯•æ˜¾ç¤ºè¯¥æ‰¹æ¬¡æ‰‹å¥—ä»…è¾¾A1çº§ã€‚</li>
                            </ul>`,
                    mitigation: "ä»»ä½•å®£ç§°é˜²æŠ¤ç­‰çº§çš„äº§å“ï¼Œå¿…é¡»æœ‰å¯¹åº”çš„ ANSI/ISEA æ£€æµ‹æŠ¥å‘Šæ”¯æ’‘ã€‚å¦åˆ™åº”ä½œä¸ºæ™®é€šè€ç£¨æ‰‹å¥—é”€å”®ã€‚"
                }
            },
            {
                id: '10137', cat: 'æ±½è½¦é…ä»¶/Auto Parts', cls: 'B', rate: 0.0018, min: 4800, keywords: 'car part,bumper,wiper,filter,mat,automotive,seat cover,light,mirror,handle',
                deep_analysis: {
                    focus: `<strong>è¡Œè½¦å®‰å…¨å¹²æ‰°ä¸ææ–™åˆè§„ï¼š</strong> å°±ç®—æ˜¯éå…³é”®åº•ç›˜ä»¶ï¼Œå†…é¥°ä»¶ï¼ˆè„šå«ã€åº§å¥—ï¼‰å¦‚æœå¡ä½æ²¹é—¨è¸æ¿æˆ–é˜»ç¢æ°”å›Šå¼¹å‡ºï¼Œä¹Ÿèƒ½å¼•å‘è‡´å‘½äº‹æ•…ã€‚ææ–™æ–¹é¢ï¼Œéœ€å…³æ³¨ FMVSS 302 é˜»ç‡ƒæ ‡å‡†åŠ VOC æŒ¥å‘ç‰©ã€‚`,
                    cases: `<ul>
                                <li><strong>2009å¹´ä¸°ç”°è„šå«é—¨äº‹ä»¶ (è‡´å…¨å®¶æ­»äº¡)ï¼š</strong> å…¨å¤©å€™è„šå«è®¾è®¡ç¼ºé™·å¡ä½äº†é›·å…‹è¨æ–¯çš„æ²¹é—¨è¸æ¿ï¼Œå¯¼è‡´è½¦è¾†å¤±æ§é«˜é€Ÿæ’æ¯ã€‚æ­¤æ¡ˆå¼•å‘äº†å…¨çƒåƒä¸‡è¾†çº§çš„å¤§å¬å›ã€‚</li>
                                <li><strong>2021å¹´LEDè½¦ç¯åˆºçœ¼æ¡ˆï¼š</strong> æ”¹è£…çš„é«˜äº®LEDå¤§ç¯å› å…‰å‹è®¾è®¡ä¸ç¬¦åˆDOTæ ‡å‡†ï¼Œè‡´ä½¿å¯¹å‘å¸æœºçŸ­æš‚è‡´ç›²å‘ç”Ÿç¢°æ’ï¼Œæ”¹è£…ä»¶å–å®¶è¢«è¿½åŠ ä¸ºè¢«å‘Šã€‚</li>
                            </ul>`,
                    mitigation: "è„šå«å¿…é¡»æœ‰é˜²æ»‘å›ºå®šæ‰£ã€‚è½¦ç¯éœ€ç¬¦åˆ DOT/SAE æ ‡å‡†ã€‚é¿å…é”€å”®æ¶‰åŠåˆ¹è½¦ã€æ‚¬æŒ‚ã€è½¬å‘çš„æ ¸å¿ƒæ”¹è£…ä»¶ã€‚"
                }
            },
            {
                id: '11114', cat: 'å®¶å±…ç”¨å“/Home Goods', cls: 'B', rate: 0.0008, min: 4000, keywords: 'organizer,storage,shelf,rack,hook,hanger,basket,bin,mirror,frame,clock,vase',
                deep_analysis: {
                    focus: `<strong>å€¾å€’ç ¸ä¼¤ä¸ç»ç’ƒç ´è£‚ï¼š</strong> è¶…è¿‡30è‹±å¯¸é«˜çš„æŸœç±»å®¶å…·æœ‰æé«˜çš„å€¾å€’é£é™©ï¼Œå°¤å…¶æ˜¯å¯¹æ”€çˆ¬çš„å„¿ç«¥ã€‚ç»ç’ƒåˆ¶å“ï¼ˆé•œå­ã€æ¡Œé¢ï¼‰è‹¥æœªä½¿ç”¨é’¢åŒ–ç»ç’ƒï¼Œç ´ç¢åçš„é”åˆ©å¤§å—ç¢ç‰‡ææ˜“å‰²ä¼¤å¤§åŠ¨è„‰ã€‚`,
                    cases: `<ul>
                                <li><strong>å®œå®¶ Malm æŠ½å±‰æŸœå¬å›æ¡ˆ (è‡´8åå„¿ç«¥æ­»äº¡)ï¼š</strong> å› æœªå›ºå®šåœ¨å¢™ä¸Šï¼ŒæŠ½å±‰æŸœå€¾å€’å‹æ­»å¤šåå¹¼ç«¥ã€‚æœ€ç»ˆèµ”å¿é‡‘é¢é«˜è¾¾4600ä¸‡ç¾å…ƒï¼Œå¹¶å¼ºåˆ¶è¦æ±‚æä¾›å¢™é¢å›ºå®šå¥—ä»¶ã€‚</li>
                                <li><strong>2019å¹´æµ´å®¤é•œç‚¸è£‚æ¡ˆï¼š</strong> å®‰è£…åœ¨æµ´å®¤çš„æ™®é€šç»ç’ƒé•œå› å—çƒ­èƒ€å†·ç¼©ç‚¸è£‚ï¼Œé£æº…çš„ç»ç’ƒç¢ç‰‡åˆ’ä¼¤æ­£æ´—æ¾¡çš„ç”¨æˆ·é¢éƒ¨ã€‚</li>
                            </ul>`,
                    mitigation: "é«˜äº75cmçš„æŸœç±»å¿…é¡»é™„å¸¦é˜²å€¾å€’å›ºå®šä»¶ (Anti-tip kit)ã€‚å¤§å°ºå¯¸ç»ç’ƒå»ºè®®ä½¿ç”¨é’¢åŒ–ç»ç’ƒæˆ–è´´é˜²çˆ†è†œã€‚"
                }
            },
            {
                id: '12050', cat: 'çººç»‡å“/Textiles', cls: 'B', rate: 0.0009, min: 4000, keywords: 'fabric,cloth,towel,bedding,pillow,curtain,blanket,rug,carpet',
                deep_analysis: {
                    focus: `<strong>æ˜“ç‡ƒæ€§é£é™©ï¼š</strong> ç‰¹åˆ«æ˜¯å¤§é¢ç§¯å‚ç›´æ‚¬æŒ‚çš„ç»‡ç‰©ï¼ˆçª—å¸˜ï¼‰æˆ–äººä½“ç¡çœ æ¥è§¦ç‰©ï¼ˆç¡è¡£ã€åºŠå“ï¼‰ã€‚å¦‚æœææ˜“è¢«ç«æŸ´æˆ–é¦™çƒŸå¼•ç‡ƒä¸”ç‡ƒçƒ§é€Ÿåº¦è¿‡å¿«ï¼ˆé—ªç‡ƒï¼‰ï¼Œå°†æ— æ³•ç»™ç”¨æˆ·é€ƒç”Ÿæ—¶é—´ã€‚`,
                    cases: `<ul>
                                <li><strong>2016å¹´é•¿ç»’åœ°æ¯¯ç«ç¾æ¡ˆï¼š</strong> ä¹Ÿæ˜¯å› ä¸ºä¸€æ ¹æ‰è½çš„é¦™çƒŸï¼ŒæŸç§åŒ–çº¤é•¿ç»’åœ°æ¯¯è¿…é€Ÿç†”åŒ–å¹¶å‰§çƒˆç‡ƒçƒ§ï¼Œäº§ç”Ÿçš„æœ‰æ¯’é»‘çƒŸå¯¼è‡´æˆ·ä¸»çª’æ¯ã€‚äº§å“æœªé€šè¿‡ 16 CFR 1630 æ˜“ç‡ƒæ€§æµ‹è¯•ã€‚</li>
                            </ul>`,
                    mitigation: "å¿…é¡»ç¬¦åˆ 16 CFR 1610 (è¡£ç‰©) æˆ– 16 CFR 1630 (åœ°æ¯¯) çš„é˜»ç‡ƒæ ‡å‡†ã€‚å„¿ç«¥ç¡è¡£æœ‰æ›´ä¸¥æ ¼çš„è‡ªç†„è¦æ±‚ã€‚"
                }
            },
            {
                id: '10000', cat: 'æ™®é€šç™¾è´§/General MDSE', cls: 'B', rate: 0.00065, min: 4200, keywords: 'merchandise,general,gift,stationery,decor,craft,paper,notebook',
                deep_analysis: {
                    focus: `<strong>ä¸€èˆ¬æ€§ç‰©ç†ä¼¤å®³ï¼š</strong> é£é™©ç›¸å¯¹è¾ƒä½ï¼Œä½†ä»éœ€æ³¨æ„é”è¾¹ã€åŒ…è£…è¢‹çª’æ¯é£é™©ï¼ˆå¤§å¡‘æ–™è¢‹éœ€æ‰“å­”æˆ–å°è­¦ç¤ºè¯­ï¼‰ã€ä»¥åŠè¯¯é£Ÿé£é™©ï¼ˆå¦‚å¤–è§‚åƒç³–æœçš„æ–‡å…·ï¼‰ã€‚`,
                    cases: `<ul>
                                <li><strong>2018å¹´å› åŒ…è£…è¢‹çª’æ¯æ¡ˆï¼š</strong> å©´å„¿å°†æœªæ‰“å­”çš„å¤§å·é€æ˜å¡‘æ–™åŒ…è£…è¢‹å¥—åœ¨å¤´ä¸Šç©è€å¯¼è‡´çª’æ¯ã€‚</li>
                                <li><strong>2021å¹´"é£Ÿå“çº§"ç¡…èƒ¶æ¨¡å…·æ¡ˆï¼š</strong> æŸç¡…èƒ¶æ¨¡å…·å…¶å®ä½¿ç”¨å·¥ä¸šç¡…èƒ¶ï¼Œå¯¼è‡´çƒ˜ç„™ä¸ç®¡æ˜¯å¼‚å‘³è¿˜æ˜¯æœ‰å®³ç‰©è´¨æå‡ºã€‚</li>
                            </ul>`,
                    mitigation: "ç¡®ä¿ç¬¦åˆåŠ å· 65 å·æ³•æ¡ˆï¼ˆProp 65ï¼‰å…³äºåŒ–å­¦ç‰©è´¨çš„è­¦ç¤ºè¦æ±‚ã€‚å¡‘æ–™è¢‹å¼€å£å¤§äº5è‹±å¯¸éœ€å°çª’æ¯è­¦ç¤ºã€‚"
                }
            }
        ];

        // å¼ºåˆ¶æ›´æ–°æœ¬åœ°å­˜å‚¨çš„æ•°æ®åº“ä»¥åº”ç”¨æ–°çš„ä¸“å®¶æ´å¯Ÿæ•°æ®çš„ Helper
        // (ä»…åœ¨å¼€å‘è°ƒè¯•é˜¶æ®µæˆ–ç‰ˆæœ¬è¿ç§»æ—¶ä½¿ç”¨)
        const FORCE_UPDATE_DB = true;
        if (FORCE_UPDATE_DB) safeSetItem('cgl_db_v3', DEFAULT_DB);


        const DEFAULT_COI_RULES = [
            { id: 'limit', label: 'å•æ¬¡äº‹æ•…èµ”ä»˜é™é¢', value: 1000000, unit: 'USD', desc: 'Amazon è¦æ±‚ä¸ä½äº $1M' },
            { id: 'deductible', label: 'å…èµ”é¢ä¸Šé™', value: 10000, unit: 'USD', desc: 'Amazon è¦æ±‚ä¸è¶…è¿‡ $10K' },
            { id: 'holder', label: 'é™„åŠ è¢«ä¿é™©äººæè¿°', value: 'Amazon.com Services LLC. its affiliates and assignees', unit: 'Text', desc: 'å®˜æ–¹æŒ‡å®šæ–‡æœ¬' }
        ];


        // --- æ–°å¢ï¼šçŸ¥è¯†åº“å¯¼å…¥ç»„ä»¶ (Knowledge Base Importer) ---
        const KnowledgeImporter = ({ onImportSuccess }) => {
            const [uploading, setUploading] = React.useState(false);
            const [logs, setLogs] = React.useState([]);

            const handleZipUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                setUploading(true);
                setLogs(['ğŸš€ å¼€å§‹å¤„ç†çŸ¥è¯†åº“å‹ç¼©åŒ…...']);
                const newEntries = []; // Fix: Declare outside try/catch scope

                try {
                    const zip = new JSZip();
                    const zipContent = await zip.loadAsync(file);

                    // Debug Information
                    const allFiles = Object.keys(zipContent.files);
                    const docFiles = allFiles.filter(name => name.endsWith('.doc'));
                    const docxFiles = allFiles.filter(name => !name.startsWith('__MACOSX') && name.endsWith('.docx'));

                    if (docxFiles.length === 0) {
                        if (docFiles.length > 0) {
                            setLogs(prev => [...prev, `âš ï¸ å‘ç° ${docFiles.length} ä¸ª .doc æ ¼å¼æ–‡æ¡£ï¼Œä½†æœ¬ç³»ç»Ÿä»…æ”¯æŒ .docx æ ¼å¼ã€‚å»ºè®®æ‚¨å°†æ–‡æ¡£å¦å­˜ä¸º .docx åé‡æ–°æ‰“åŒ…ä¸Šä¼ ã€‚`]);
                        } else {
                            setLogs(prev => [...prev, `âš ï¸ å‹ç¼©åŒ…ä¸­æœªæ‰¾åˆ° .docx æ–‡æ¡£ã€‚å…±æ‰«æäº† ${allFiles.length} ä¸ªæ–‡ä»¶ã€‚è¯·ç¡®è®¤æ–‡ä»¶æ ¼å¼æ­£ç¡®ã€‚`]);
                        }
                        setUploading(false);
                        return;
                    }

                    setLogs(prev => [...prev, `ğŸ“‚ å‘ç° ${docxFiles.length} ä¸ªæœ‰æ•ˆ Word æ–‡æ¡£ (.docx)ï¼Œå¼€å§‹è§£æ...`]);

                    for (let filename of docxFiles) {
                        try {
                            const fileData = await zipContent.files[filename].async("arraybuffer");

                            // ä½¿ç”¨ Mammoth è§£æ Word
                            const result = await mammoth.convertToHtml({ arrayBuffer: fileData });
                            const htmlContent = result.value;

                            // æ™ºèƒ½æå–é€»è¾‘ (Smart Extraction)
                            // å‡è®¾æ–‡ä»¶åå³ä¸ºå“ç±»å (e.g., "Camping Stoves.docx")
                            const categoryName = filename.replace('.docx', '').split('/').pop();

                            // ç®€å•çš„å…³é”®è¯æå– (å¦‚æœæ–‡æ¡£ä¸­æœ‰æ˜ç¡®çš„ Risk/Mitigation æ ‡é¢˜)
                            // è¿™é‡Œåšä¸€ä¸ªç®€å•çš„ HTML åŒ…è£…ä½œä¸º deep_analysis
                            // ä¼˜åŒ–ï¼šLocalStorage å®¹é‡æœ‰é™ï¼ˆé€šå¸¸ä»… 5MBï¼‰ï¼Œæ— æ³•å­˜å‡ ç™¾ä¸ªå®Œæ•´ Word çš„ HTML
                            // è§£å†³æ–¹æ¡ˆï¼šä»…æå–çº¯æ–‡æœ¬çš„å‰ 800 ä¸ªå­—ç¬¦ä½œä¸ºæ‘˜è¦
                            const rawText = result.value.replace(/<[^>]*>?/gm, ' '); // å‰¥ç¦» HTML æ ‡ç­¾
                            const truncatedText = rawText.substring(0, 800) + (rawText.length > 800 ? '...' : '');

                            const deepAnalysis = {
                                focus: `åŸºäºä¸“å®¶æ–‡æ¡£ [${filename}] çš„åˆ†æ`,
                                cases: `<div class="kb-summary">${truncatedText}</div><br/><small style="color:gray">*ç”±äºæµè§ˆå™¨å­˜å‚¨é™åˆ¶ï¼Œä»…å±•ç¤ºæ–‡æ¡£æ‘˜è¦ã€‚è¯·æŸ¥é˜…åŸä»¶ã€‚</small>`,
                                mitigation: "è¯·å‚è€ƒä¸Šè¿°ä¸“å®¶æ–‡æ¡£ä¸­çš„è¯¦ç»†åˆè§„å»ºè®®ã€‚"
                            };

                            // æ„é€ ä¸€ä¸ªæ–°çš„ DB Entry
                            // ç”Ÿæˆä¸€ä¸ªåŸºäºæ–‡ä»¶åçš„å”¯ä¸€ ID Hash
                            const idHash = categoryName.split('').reduce((a, b) => a + b.charCodeAt(0), 0).toString().slice(0, 5);

                            const newEntry = {
                                id: `IMP-${idHash}`,
                                cat: categoryName, // ä½¿ç”¨æ–‡ä»¶åä½œä¸ºåˆ†ç±»
                                cls: 'Referral', // é»˜è®¤ä¸ºå¾…äººå·¥æ ¸ä¿ï¼Œå› ä¸ºæˆ‘ä»¬ä¸çŸ¥é“è´¹ç‡
                                rate: 0,
                                min: 0,
                                keywords: categoryName.toLowerCase().replace(/_/g, ','), // å°†æ–‡ä»¶åè½¬ä¸ºå…³é”®è¯
                                deep_analysis: deepAnalysis,
                                isImported: true
                            };

                            newEntries.push(newEntry);
                            setLogs(prev => [...prev, `âœ… è§£ææˆåŠŸ: ${categoryName}`]);

                        } catch (err) {
                            console.error(err);
                            setLogs(prev => [...prev, `âŒ è§£æå¤±è´¥: ${filename} - ${err.message}`]);
                        }
                    }

                    // åˆå¹¶åˆ°ç°æœ‰æ•°æ®åº“
                    if (newEntries.length > 0) {
                        const currentDB = safeGetItem('cgl_db_v3', []);
                        // ç®€å•çš„å»é‡åˆå¹¶ç­–ç•¥ï¼šå¦‚æœåŒååˆ™è¦†ç›–ï¼Œå¦åˆ™è¿½åŠ 
                        const updatedDB = [...currentDB];

                        newEntries.forEach(ENTRY => {
                            const idx = updatedDB.findIndex(d => d.cat === ENTRY.cat);
                            if (idx > -1) {
                                // ä»…æ›´æ–° deep_analysis
                                updatedDB[idx].deep_analysis = ENTRY.deep_analysis;
                            } else {
                                updatedDB.push(ENTRY);
                            }
                        });

                        safeSetItem('cgl_db_v3', updatedDB);
                        setLogs(prev => [...prev, `ğŸ‰ æˆåŠŸå¯¼å…¥ ${newEntries.length} æ¡ä¸“å®¶çŸ¥è¯†ï¼æ•°æ®åº“å·²æ›´æ–°ã€‚`]);

                        if (onImportSuccess) onImportSuccess();

                        setTimeout(() => {
                            alert(`æˆåŠŸä»æ–‡æ¡£åº“ä¸­å¯¼å…¥ ${newEntries.length} ä¸ªæ–°çš„é£é™©å“ç±»ï¼\n\næ–°å¯¼å…¥çš„å“ç±»å°†è‡ªåŠ¨ç”¨äºåç»­çš„é£é™©åˆ†æã€‚`);
                        }, 500);
                    }

                } catch (error) {
                    setLogs(prev => [...prev, `ğŸ”¥ ä¸¥é‡é”™è¯¯: ${error.message}`]);
                } finally {
                    setUploading(false);
                }
            };

            return (
                <div style={{ marginTop: '20px', padding: '20px', background: '#fff', borderRadius: '16px', border: '2px dashed #cbd5e0' }}>
                    <h3 style={{ fontSize: '16px', fontWeight: 'bold', marginBottom: '10px', display: 'flex', alignItems: 'center' }}>
                        ğŸ“š å¯¼å…¥ä¸“å®¶çŸ¥è¯†åº“ (ZIP/Word)
                        <span style={{ fontSize: '10px', background: '#edf2f7', padding: '2px 6px', borderRadius: '4px', marginLeft: '8px', color: '#718096' }}>
                            Beta
                        </span>
                    </h3>
                    <p style={{ fontSize: '12px', color: '#718096', marginBottom: '16px' }}>
                        æ”¯æŒæ‰¹é‡å¯¼å…¥ .zip æ ¼å¼çš„å‹ç¼©åŒ…ã€‚ç³»ç»Ÿå°†è‡ªåŠ¨è§£æå‹ç¼©åŒ…å†…çš„ Word æ–‡æ¡£ (.docx)ï¼Œå¹¶å°†æ–‡ä»¶åä½œä¸º"å“ç±»åç§°"ï¼Œæ–‡æ¡£å†…å®¹ä½œä¸º"æ·±åº¦é£é™©è¯„ä¼°"å­˜å…¥æ•°æ®åº“ã€‚
                    </p>

                    <div style={{ display: 'flex', gap: '10px', alignItems: 'center' }}>
                        <div style={{ position: 'relative', overflow: 'hidden', display: 'inline-block' }}>
                            <button className="btn" style={{ background: '#4a5568', color: 'white', padding: '8px 16px', borderRadius: '8px', fontWeight: 'bold', fontSize: '12px' }}>
                                {uploading ? 'â³ æ­£åœ¨è§£æ...' : 'ğŸ“‚ é€‰æ‹© ZIP æ–‡ä»¶'}
                            </button>
                            <input type="file" accept=".zip" onChange={handleZipUpload} disabled={uploading}
                                style={{ position: 'absolute', left: 0, top: 0, opacity: 0, width: '100%', height: '100%', cursor: 'pointer' }} />
                        </div>
                    </div>

                    {logs.length > 0 && (
                        <div style={{ marginTop: '16px', background: '#1a202c', color: '#48bb78', padding: '12px', borderRadius: '8px', fontSize: '10px', maxHeight: '120px', overflowY: 'auto' }}>
                            {logs.map((log, i) => <div key={i}>{log}</div>)}
                        </div>
                    )}
                </div>
            );
        };




        // --- æ–°å¢ï¼šé£é™©åˆ†æå¡ç‰‡ç»„ä»¶ ---
        const RiskAnalysisCard = ({ analysis, isHighRisk }) => {
            const [expanded, setExpanded] = useState(false);

            // Construct full content
            let contentHTML = "";
            if (analysis) {
                // Determine if fields are present
                const focus = analysis.focus ? `<div class="mb-3"><div class="font-bold text-gray-800 mb-1">ğŸ¯ æ ¸å¿ƒé£é™© (Risk Focus)</div><div class="pl-2 border-l-2 border-red-400 bg-red-50/50 p-2 rounded text-gray-700">${analysis.focus}</div></div>` : "";
                const cases = analysis.cases ? `<div class="mb-3"><div class="font-bold text-gray-800 mb-1">âš–ï¸ çœŸå®æ¡ˆä¾‹ (Real Cases)</div><div class="pl-2 border-l-2 border-amber-400 bg-amber-50/50 p-2 rounded text-gray-700">${analysis.cases}</div></div>` : "";
                const mitigation = analysis.mitigation ? `<div class="mb-1"><div class="font-bold text-gray-800 mb-1">ğŸ›¡ï¸ åˆè§„å»ºè®® (Mitigation)</div><div class="pl-2 border-l-2 border-green-400 bg-green-50/50 p-2 rounded text-gray-700">${analysis.mitigation}</div></div>` : "";

                // Fallback for simple string format if legacy data exists
                if (!focus && !cases && !mitigation && typeof analysis === 'string') {
                    contentHTML = analysis;
                } else {
                    contentHTML = focus + cases + mitigation;
                }
            } else {
                contentHTML = isHighRisk ?
                    "<div class='p-2 bg-red-50 text-red-600 rounded'>âš ï¸ é«˜é£é™©ç±»åˆ«ï¼šå»ºè®®ä¸¥æ ¼å®¡æŸ¥äº§å“è­¦ç¤ºè¯­åŠæµ‹è¯•æŠ¥å‘Šã€‚</div>" :
                    "<div class='p-2 bg-gray-50 text-gray-500 rounded'>âœ… æ ‡å‡†é£é™©ç±»åˆ«ï¼šç¬¦åˆä¸€èˆ¬è´¸æ˜“å“æ‰¿ä¿é€»è¾‘ã€‚</div>";
            }

            // Simple heuristic for "long content"
            const isLong = contentHTML.length > 200;

            return (
                <div className="w-full">
                    <div className={`text-xs leading-relaxed font-medium bg-white p-5 rounded-xl border border-gray-100 shadow-sm relative transition-all duration-500 ${!expanded && isLong ? 'max-h-40 overflow-hidden mask-bottom' : ''}`}>
                        <div dangerouslySetInnerHTML={{ __html: contentHTML }} className="space-y-2" />

                        {!expanded && isLong && (
                            <div className="absolute bottom-0 left-0 w-full h-16 bg-gradient-to-t from-white via-white/80 to-transparent pointer-events-none"></div>
                        )}
                    </div>
                    {isLong && (
                        <button
                            onClick={() => setExpanded(!expanded)}
                            className="mt-2 text-[10px] uppercase font-bold text-blue-600 hover:text-blue-800 flex items-center gap-1 ml-1"
                        >
                            {expanded ? "æ”¶èµ·åˆ†æ (Collapse)" : "é˜…è¯»å®Œæ•´ä¸“å®¶åˆ†æ (Read More)"} {expanded ? "â–²" : "â–¼"}
                        </button>
                    )}
                </div>
            );
        };

        function App() {
            const [view, setView] = useState('home');
            // Migration: v4 forces a fresh start with the new rich knowledge base
            const [db, setDb] = useState(() => safeGetItem('cgl_db_v4', DEFAULT_DB));
            const [logs, setLogs] = useState(() => safeGetItem('cgl_audit_logs', []));
            const [exRate, setExRate] = useState(() => safeGetItem('cgl_ex_rate', 7.2));
            const [customDict, setCustomDict] = useState(() => safeGetItem('cgl_custom_dict', {}));

            const [isCustomerMode] = useState(() => new URLSearchParams(window.location.search).get('mode') === 'customer');

            const [revenueRaw, setRevenueRaw] = useState("1,000,000"); // ç”¨æˆ·è¾“å…¥çš„æ€»é¢„ä¼°é”€å”®é¢
            const [merchantResults, setMerchantResults] = useState([]); // åŸå§‹åŒ¹é…åˆ—è¡¨
            const [groupedResults, setGroupedResults] = useState([]); // æŒ‰å“ç±»æ±‡æ€»åçš„ç»“æœ
            const [totalFinalPrem, setTotalFinalPrem] = useState(0);
            const [storeInfo, setStoreInfo] = useState({ name: 'Amazon Store', url: '' }); // æ–°å¢ï¼šåº—é“ºä¿¡æ¯çŠ¶æ€

            // Manual Sync Trigger
            const requestSync = () => {
                console.log("Manually requesting data sync...");
                window.parent.postMessage({ action: 'appReady' }, '*');
                addLog('System', 'å°è¯•æ‰‹åŠ¨è¯·æ±‚æ•°æ®åŒæ­¥...');
            };

            const [deductibleType, setDeductibleType] = useState('10000');
            const [modalFile, setModalFile] = useState(null);
            const [lastUploadStats, setLastUploadStats] = useState(null);
            const [coiStep, setCoiStep] = useState('idle');
            const [coiRules, setCoiRules] = useState(() => safeGetItem('cgl_coi_rules', DEFAULT_COI_RULES));
            const [showImporter, setShowImporter] = React.useState(false);

            // DB Refresh Helper
            const refreshDB = () => {
                const storedDB = safeGetItem('cgl_db_v4', null);
                if (storedDB) setDb(storedDB);
            };

            // ä¼˜åŒ–è¾“å…¥ä½“éªŒï¼šæœ¬åœ°ç¼–è¾‘çŠ¶æ€ (è§£å†³å°æ•°ç‚¹è¾“å…¥å’Œæ ¼å¼åŒ–å†²çª)
            const [editState, setEditState] = useState({ id: null, val: '' });

            const addLog = (type, detail, snapshot = null) => {
                const entry = { id: Date.now(), time: new Date().toLocaleString(), type, detail, snapshot };
                setLogs(prev => [entry, ...prev].slice(0, 50));
            };

            const getRevenueNum = () => parseFloat(revenueRaw.replace(/,/g, '')) || 0;

            useEffect(() => {
                safeSetItem('cgl_db_v4', db);
                safeSetItem('cgl_audit_logs', logs);
                safeSetItem('cgl_ex_rate', exRate);
                safeSetItem('cgl_coi_rules', coiRules);
            }, [db, logs, exRate, coiRules]);

            useEffect(() => {
                // Version Check for v4
                const storedV4 = safeGetItem('cgl_db_v4', null);
                if (!storedV4) {
                    // First time v4 user or migration
                    console.warn("Storage upgraded to v4. Hydrating with new Rich Expert Knowledge Base.");
                    setDb(DEFAULT_DB);
                    safeSetItem('cgl_db_v4', DEFAULT_DB);
                } else {
                    // Check if it has specific new fields (e.g. welding deep analysis is an object)
                    const sample = storedV4.find(i => i.id === '11213');
                    if (!sample || typeof sample.deep_analysis !== 'object') {
                        console.warn("Detected v4 DB but with old structure. Force updating...");
                        setDb(DEFAULT_DB);
                        safeSetItem('cgl_db_v4', DEFAULT_DB);
                    }
                }
            }, []);

            // ğŸ†• æ’ä»¶è”åŠ¨é€»è¾‘ï¼šæ£€æŸ¥æ˜¯å¦æœ‰æ¥è‡ª Popup çš„å¾…å¤„ç†æ–‡ä»¶
            // ğŸ†• æ’ä»¶è”åŠ¨é€»è¾‘ï¼šé€šè¿‡ postMessage æ¥æ”¶æ•°æ® (Sandboxæ¨¡å¼)
            useEffect(() => {
                const handleMessage = (event) => {
                    const message = event.data;
                    if (!message) return;

                    // 0. æ•°æ®æ¢å¤ (Hydration)
                    if (message.type === 'hydrateState') {
                        // Support migrating v2/v3 to v4 if needed, but here we prioritize v4 or default
                        const { cgl_db_v4, cgl_db_v2, cgl_audit_logs, cgl_ex_rate, cgl_coi_rules } = message.payload;

                        // Prefer v4 if available from hydration, otherwise fallback to local DEFAULT_DB
                        if (cgl_db_v4) {
                            setDb(cgl_db_v4);
                        } else if (cgl_db_v2) {
                            // Optional: Migrate v2 to v4 logic here if we wanted to keep user edits
                            // But for now, we want to force the new KB, so we might IGNORE v2 if it's old
                            console.log("Ignoring legacy v2 DB from hydration to enforce v4 update.");
                        }

                        if (cgl_audit_logs) setLogs(cgl_audit_logs);
                        if (cgl_ex_rate) setExRate(cgl_ex_rate);
                        if (cgl_coi_rules) setCoiRules(cgl_coi_rules);
                        console.log("State hydrated.");
                    }

                    // 1. å¤„ç†æ–‡ä»¶ä¸Šä¼ 
                    if (message.type === 'pendingUpload') {
                        const { name, type, data } = message.payload;
                        console.log("Received file via postMessage:", name);
                        addLog('EXT_SYNC', `æ¥æ”¶åˆ°æ’ä»¶åŒæ­¥æ–‡ä»¶: ${name}`);

                        try {
                            if (type === 'xlsx' || type === 'xls') {
                                // Excel å¤„ç†
                                const wb = XLSX.read(data.split(',')[1], { type: 'base64' });
                                const sheetName = wb.SheetNames[0];
                                const jsonData = XLSX.utils.sheet_to_json(wb.Sheets[sheetName]);
                                processMerchantReport(jsonData);
                            } else if (type === 'txt' || type === 'csv') {
                                // æ–‡æœ¬å¤„ç†
                                const textContent = atob(data.split(',')[1]);
                                const parsedData = parseTextToData(textContent);
                                processMerchantReport(parsedData);
                            }
                            setView('merchant');

                            // é€šçŸ¥çˆ¶çª—å£æ¸…é™¤ Storage (å› ä¸ºsandboxä¸èƒ½è®¿é—®chrome.storage)
                            window.parent.postMessage({ action: 'clearStorage', key: 'pendingUpload' }, '*');

                        } catch (err) {
                            console.error("File load error:", err);
                            alert("æ–‡ä»¶åŠ è½½å¤±è´¥: " + err.message);
                        }
                    }
                    // 2. å¤„ç†é¡µé¢æŠ“å–æ•°æ®
                    else if (message.type === 'extractedData') {
                        const { items, extractedAt, storeName, url } = message.payload;

                        if (storeName) setStoreInfo({ name: storeName, url: url || '' });

                        // Check if data is fresh (within 5 minutes)
                        const timeDiff = new Date() - new Date(extractedAt);
                        if (timeDiff < 300000) { // 5 minutes
                            console.log("Received scraped data:", items.length);
                            addLog('EXT_XYNC', `æ¥æ”¶åˆ°é¡µé¢æŠ“å–æ•°æ® ${items.length} æ¡`);
                            processMerchantReport(items);
                            setView('merchant');
                        } else {
                            console.warn("Ignored stale extracted data from:", extractedAt);
                        }
                    }
                };

                window.addEventListener('message', handleMessage);

                // å‘é€ "ready" ä¿¡å·ç»™çˆ¶çª—å£ï¼Œè¯·æ±‚æ•°æ®
                window.parent.postMessage({ action: 'appReady' }, '*');

                return () => window.removeEventListener('message', handleMessage);
            }, []);



            // æ ¸å¿ƒå¤„ç†å‡½æ•°ï¼šå¤„ç†ä¸Šä¼ çš„é”€å”®æŠ¥å‘Š
            const processMerchantReport = (data) => {
                const globalRev = getRevenueNum();
                console.group("SKU Matching Debug Log");

                // 1. è¯†åˆ« SKU é£é™©å¹¶å°è¯•æå–é”€å”®æ•°æ®
                const rawMatches = data.map((row, idx) => {
                    const keys = Object.keys(row);
                    const kLow = keys.map(k => k.toLowerCase());

                    // ä¼˜åŒ–ï¼šä¼˜å…ˆåŒ¹é…æ˜ç¡®çš„æè¿°/åç§°åˆ—ï¼Œæ”¯æŒä¸­æ–‡
                    let titleKey = keys.find(k => {
                        const low = k.toLowerCase();
                        return (low.includes('description') || low.includes('name') || low.includes('title') || low.includes('product') ||
                            low.includes('æè¿°') || low.includes('åç§°') || low.includes('å“å') || low.includes('å•†å“'));
                    });

                    // å¦‚æœæ²¡æ‰¾åˆ°æè¿°åˆ—ï¼Œæ‰å°è¯•ç”¨ SKU æˆ–ç¬¬ä¸€åˆ—å…œåº•
                    if (!titleKey) {
                        titleKey = keys.find(k => k.toLowerCase().includes('sku')) || keys[0];
                    }

                    // ä¼˜åŒ–ï¼šæ”¯æŒä¸­æ–‡é”€å”®é¢åˆ—å
                    const salesKey = keys.find(k => {
                        const low = k.toLowerCase();
                        return (low.includes('sales') || low.includes('revenue') || low.includes('amount') || low.includes('total') ||
                            low.includes('price') || low.includes('é”€å”®') || low.includes('é‡‘é¢') || low.includes('ä»·æ ¼'));
                    });

                    // æ–°å¢ï¼šè¯†åˆ« BSR æ’ååˆ—
                    const rankKey = keys.find(k => {
                        const low = k.toLowerCase();
                        return (low.includes('rank') || low.includes('bsr') || low.includes('æ’å') || low.includes('best seller'));
                    });

                    const title = row[titleKey] || "æœªçŸ¥å•†å“";
                    let salesValue = parseFloat(String(row[salesKey] || "0").replace(/[^0-9.]/g, '')) || 0;

                    // Sales Estimation Logic
                    const rankValue = rankKey ? parseInt(String(row[rankKey]).replace(/[^0-9]/g, '')) : 0;
                    let estAnnualSales = 0;
                    let isEstimated = false;

                    if (rankValue > 0) {
                        estAnnualSales = estimateAnnualSalesFromBSR(rankValue);
                        // å¦‚æœæ²¡æœ‰æä¾›çœŸå®é”€å”®é¢ï¼Œåˆ™ä½¿ç”¨é¢„ä¼°å€¼
                        if (salesValue === 0) {
                            salesValue = 0; // è¿™é‡Œçš„ salesValue æ˜¯ "Excelæä¾›çš„çœŸå®å€¼"ï¼Œæˆ‘ä»¬ä¸æ··æ·†å®ƒï¼Œè€Œæ˜¯åœ¨åé¢å¯¹æ¯”ä½¿ç”¨
                            isEstimated = true;
                        }
                    }

                    // Debug: æ‰“å°å‰5ä¸ªè¯¦æƒ…
                    if (idx < 5) console.log(`Processing Item [${idx}]:`, title);

                    // --- 1. æ ¸å¿ƒåŠŸèƒ½åˆ†ç±» (Primary Functional Categorization) ---
                    // é€»è¾‘ï¼šå…ˆè¯†åˆ«å®ƒ"æ˜¯ä»€ä¹ˆ" (Functional Identification)
                    // æˆ‘ä»¬éå†æ•°æ®åº“ï¼Œå¯»æ‰¾åŒ¹é…çš„åŠŸèƒ½æè¿°ã€‚æ­¤æ—¶ä¸åº”è¿‡åˆ†çº ç»“ç”±äºåŒ…å«â€œç”µæ± â€è€Œç›´æ¥åˆ¤å®šä¸ºâ€œç”µæ± ç±»åˆ«â€ã€‚
                    // å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿æ•°æ®åº“çš„é¡ºåºï¼šå…·ä½“åŠŸèƒ½ -> é€šç”¨åŠŸèƒ½ -> å…œåº•
                    let primaryMatch = db.find(d => {
                        // æ’é™¤çº¯é£é™©æè¿°ç±»ï¼ˆå¦‚ Batteryï¼‰ï¼Œé™¤éå®ƒæœ¬èº«å°±æ˜¯äº§å“ä¸»ä½“
                        const isPureRiskCategory = d.id === '10203'; // Battery ID
                        if (isPureRiskCategory) return false;

                        const keywords = String(d.keywords || '');
                        return keywords.split(/[,ï¼Œ]/).find(k => {
                            const cleanK = k.trim().toLowerCase();
                            return cleanK && String(title).toLowerCase().includes(cleanK);
                        });
                    });

                    // --- 2. é£é™©ç‰¹å¾æ‰«æ (Risk Characteristic Scanning) ---
                    // é€»è¾‘ï¼šæ‰«æâ€œå«æœ‰ä»€ä¹ˆé£é™©â€ (Risk Component Identification)
                    // æ— è®ºå®ƒæ˜¯ä»€ä¹ˆäº§å“ï¼Œåªè¦åŒ…å«é«˜å±ç»„ä»¶ï¼ˆå¦‚ç”µæ± ã€ç‡ƒæ²¹ã€é«˜å‹ï¼‰ï¼Œå°±å¿…é¡»åœ¨é£é™©ä¸ŠåŠ ç 
                    const riskKeywords = [
                        { key: 'battery', tag: 'High Risk: Battery Source', upgradeTo: 'C', minRate: 0.012, riskId: '10203' },
                        { key: 'lithium', tag: 'High Risk: Lithium Battery', upgradeTo: 'C', minRate: 0.012, riskId: '10203' },
                        { key: 'welder', tag: 'High Risk: Welding Arc', upgradeTo: 'Excluded', minRate: 0.05, riskId: '11213' },
                        { key: 'heater', tag: 'High Risk: Heating Element', upgradeTo: 'A', minRate: 0.0035, riskId: '11113' }
                    ];

                    let riskFactor = null;
                    const titleLower = String(title).toLowerCase();

                    // æ‰«ææ ‡é¢˜ä¸­æ˜¯å¦åŒ…å«é£é™©è¯
                    for (const rf of riskKeywords) {
                        if (titleLower.includes(rf.key)) {
                            riskFactor = rf;
                            break; // æ‰¾åˆ°æœ€é«˜ä¼˜å…ˆçº§çš„é£é™©å³å¯
                        }
                    }

                    // --- 3. æœ€ç»ˆåˆ¤å®š (Final Determination) ---
                    let finalMatch = { ... (primaryMatch || {}) };

                    // å…œåº•é€»è¾‘ï¼šå¦‚æœè¿åŠŸèƒ½éƒ½æ²¡åŒ¹é…ä¸Š (Result is Unidentified)
                    if (!primaryMatch) {
                        // å¦‚æœåŒ…å«é£é™©è¯ï¼ˆå¦‚æ˜¯ä¸€ä¸ªçº¯"Lithium Battery Pack"ï¼‰ï¼Œä¸”æ²¡åŒ¹é…åˆ°å…¶ä»–åŠŸèƒ½ï¼Œé‚£å®ƒå°±æ˜¯é£é™©äº§å“æœ¬èº«
                        if (riskFactor) {
                            const riskDbItem = db.find(d => d.id === riskFactor.riskId);
                            primaryMatch = riskDbItem;
                            finalMatch = { ...riskDbItem };
                        } else {
                            // çœŸæ­£çš„å…œåº•ï¼šä¸å†é»˜è®¤å½’ä¸ºâ€œæ™®é€šç™¾è´§â€ï¼Œè€Œæ˜¯å½’ä¸ºâ€œå¾…äººå·¥æ ¸ä¿â€
                            primaryMatch = {
                                id: 'REFERRAL',
                                cat: 'å¾…äººå·¥æ ¸ä¿/Refer to Underwriter',
                                cls: 'Referral',
                                rate: 0.00, // è´¹ç‡ç½®0ï¼Œå¼ºåˆ¶äººå·¥å®šä»·
                                min: 0,
                                isReferral: true
                            };
                            finalMatch = { ...primaryMatch };
                            riskAnalysisText = "â“ ç³»ç»Ÿæ— æ³•è¯†åˆ«è¯¥å•†å“ï¼Œè¯·äººå·¥ç¡®è®¤äº§å“åŠŸèƒ½å¹¶æŒ‡å®šè´¹ç‡ã€‚";
                        }
                    } else if (primaryMatch.id === '10000') {
                        // å¦‚æœåŒ¹é…åˆ°äº†æ™®é€šç™¾è´§ (General MDSE)ï¼Œå†æ¬¡ç¡®è®¤æ˜¯å¦çœŸçš„çœ‹èµ·æ¥åƒæ™®é€šç™¾è´§
                        // é˜²æ­¢ "Nuclear Reactor" è¢«å…œåº•è§„åˆ™åŒ¹é…æˆ General
                        // è¿™é‡Œæˆ‘ä»¬ä¿¡ä»»æ•°æ®åº“çš„å…³é”®è¯åŒ¹é…ï¼Œä½†ç”±äº General çš„å…³é”®è¯é€šå¸¸å¾ˆå®½æ³›ï¼Œæ‰€ä»¥ä¿æŒåŸçŠ¶å³å¯
                    }

                    // é£é™©å‡çº§é€»è¾‘ï¼š
                    // å¦‚æœæ‰«æåˆ°äº†é£é™©å› å­ï¼Œä¸”é£é™©å› å­çš„è´¹ç‡/ç­‰çº§ é«˜äº äº§å“åŸæœ¬çš„ç­‰çº§ï¼Œåˆ™è¿›è¡Œå¼ºåˆ¶å‡çº§
                    // åŸåˆ™ï¼šä»¥é«˜é£é™©ä¸ºå‡† (Highest Risk Prevails)
                    let riskAnalysisText = "âœ… æ ‡å‡†æ‰¿ä¿é£é™©";
                    let deepAnalysisData = finalMatch.deep_analysis || null;

                    if (riskFactor) {
                        // æ¯”è¾ƒå½“å‰äº§å“è´¹ç‡ä¸é£é™©å› å­æœ€ä½è´¹ç‡
                        const currentRate = finalMatch.rate || 0;
                        if (riskFactor.minRate > currentRate) {
                            // è§¦å‘å‡çº§
                            finalMatch.cls = riskFactor.upgradeTo;
                            finalMatch.rate = riskFactor.minRate; // ä½¿ç”¨é«˜é£é™©è´¹ç‡
                            // ç”Ÿæˆå¤åˆåˆ†ç±»å
                            finalMatch.cat = `${finalMatch.cat} (with ${riskFactor.tag.split(':')[1].trim()})`;

                            riskAnalysisText = `âš ï¸ <strong>æ£€æµ‹åˆ°é«˜å±ç»„ä»¶ [${riskFactor.key}]</strong><br>é£é™©ç­‰çº§å¼ºåˆ¶ä¸Šè°ƒè‡³ [Class ${riskFactor.upgradeTo}]`;

                            // Log
                            if (idx < 5) console.log(`   â€¼ï¸ Risk Upgrade: ${title} -> Detected ${riskFactor.key}, Upgrading to ${riskFactor.upgradeTo}`);

                            // å°è¯•è·å–è¯¥é£é™©å› å­çš„æ·±åº¦åˆ†ææ•°æ®ï¼ˆå¦‚æœæœ‰ï¼Œæ¯”å¦‚ Batteryï¼‰
                            const riskDbItem = db.find(d => d.id === riskFactor.riskId);
                            if (riskDbItem && riskDbItem.deep_analysis) {
                                deepAnalysisData = riskDbItem.deep_analysis;
                            }
                        }
                    } else if (deepAnalysisData) {
                        // å¦‚æœæ²¡æœ‰å¤–éƒ¨é£é™©å› å­å‡çº§ï¼Œä½†æ˜¯æœ¬ç±»ç›®è‡ªå¸¦æ·±åº¦åˆ†æ (å¦‚æœ¬èº«å°±æ˜¯ Welding)
                        riskAnalysisText = `â„¹ï¸ <strong>è¡Œä¸šé£é™©æç¤º</strong>`;
                    }

                    if (idx < 5 && !riskFactor) console.log(`   âœ… Matched Standard Rule [${finalMatch.cat}]`);

                    // æ„é€ è¿”å›å¯¹è±¡ï¼Œé¢å¤–å¸¦ä¸Š riskAnalysis å­—æ®µä¾› UI å±•ç¤º
                    return {
                        title,
                        salesValue, // çœŸå®ï¼ˆæˆ–Excelæä¾›çš„ï¼‰é”€å”®é¢
                        estAnnualSales, // BSR é¢„ä¼°é”€å”®é¢
                        rankValue,
                        isEstimated, // æ ‡è®°æ˜¯å¦æœ‰é¢„ä¼°æ•°æ®å¯ç”¨
                        ...finalMatch,
                        // å¦‚æœå› ä¸ºé£é™©å‡çº§å¯¼è‡´ id æ²¡å˜ï¼ˆæ¯”å¦‚åªæ˜¯æ”¹äº† rateï¼‰ï¼Œå¯èƒ½ä¼šå¯¼è‡´ä¸åŒé£é™©çš„äº§å“æ··åœ¨ä¸€ä¸ªç»„
                        // ä¸ºäº†åŒºåˆ†ï¼Œæˆ‘ä»¬éœ€è¦è®© composite ID å”¯ä¸€
                        id: riskFactor ? `${finalMatch.id}-RISK-${riskFactor.key}` : finalMatch.id,
                        originalCat: primaryMatch ? primaryMatch.cat : 'Uncategorized',
                        riskAnalysis: riskAnalysisText,
                        deepAnalysis: deepAnalysisData
                    };
                });
                console.groupEnd();

                // 2. æŒ‰å“ç±»(ID)è¿›è¡Œå½’é›†æ±‡æ€»
                const groupsMap = {};
                rawMatches.forEach(item => {
                    // ä½¿ç”¨æ–°çš„ Composite ID è¿›è¡Œåˆ†ç»„
                    const groupId = item.id;

                    if (!groupsMap[groupId]) {
                        groupsMap[groupId] = {
                            id: groupId,
                            cat: item.cat, // è¿™é‡Œçš„ cat å¯èƒ½æ˜¯å¤åˆåç§° "Doorbell (w/ Battery)"
                            cls: item.cls,
                            rate: item.rate,
                            min: item.min,
                            itemsCount: 0,
                            excelTotalSales: 0,
                            riskAnalysis: item.riskAnalysis, // å–ç¬¬ä¸€ä¸ªæ ·æœ¬çš„åˆ†ææ–‡æ¡ˆ
                            deepAnalysis: item.deepAnalysis, // å–ç¬¬ä¸€ä¸ªæ ·æœ¬çš„æ·±åº¦æ´å¯Ÿ
                            items: []
                        };
                    }
                    groupsMap[groupId].itemsCount += 1;
                    groupsMap[groupId].excelTotalSales += item.salesValue;
                    groupsMap[groupId].items.push(item);
                });

                // 3. è®¡ç®—æƒé‡å¹¶åˆå§‹åŒ–ç”³æŠ¥é”€å”®é¢
                const totalExcelSales = rawMatches.reduce((sum, item) => sum + item.salesValue, 0);

                const groupsArray = Object.values(groupsMap).map(group => {
                    // å¦‚æœ Excel æ²¡é‡‘é¢ï¼Œåˆ™æŒ‰äº§å“æ•°é‡å¹³å‡åˆ†é…ï¼›å¦‚æœæœ‰é‡‘é¢ï¼ŒæŒ‰æ¯”ä¾‹åˆ†é…
                    const weight = totalExcelSales > 0 ? group.excelTotalSales / totalExcelSales : 1 / Object.keys(groupsMap).length;

                    // é»˜è®¤é€»è¾‘ï¼šå°†ç”¨æˆ·è¾“å…¥çš„æ€»é”€å”®é¢æŒ‰æƒé‡åˆ†é…ç»™å„ç»„
                    // å¦‚æœç”¨æˆ·è¿˜æ²¡æœ‰è¾“å…¥æ€»é”€å”®é¢ï¼Œåˆ™ä½¿ç”¨ Excel æŠ“å–æ€»é¢ä½œä¸ºé»˜è®¤å€¼
                    const allocatedSales = globalRev > 0 ? globalRev * weight : group.excelTotalSales;

                    // åˆå§‹åŒ– declaredSales (å¯ç¼–è¾‘å­—æ®µ)
                    // æ ¸å¿ƒé€»è¾‘å‡çº§: å¦‚æœæœ‰ BSR é¢„ä¼°é”€å”®é¢ä¸”åŸé”€å”®é¢ä¸º 0ï¼Œåˆ™ä¼˜å…ˆä½¿ç”¨ BSR é¢„ä¼°å€¼
                    const hasEstSales = group.items.some(i => i.isEstimated);
                    const declaredSales = (group.excelTotalSales === 0 && hasEstSales) ?
                        group.items.reduce((sum, i) => sum + (i.estAnnualSales || 0), 0) :
                        allocatedSales;

                    const effectiveRate = deductibleType === '0' ? group.rate * 1.2 : group.rate;
                    const effectiveMin = deductibleType === '0' ? group.min * 1.2 : group.min;

                    // é«˜é£é™©/æ‹’ä¿ç±»ç‰¹æ®Šå¤„ç†
                    const isHighRisk = group.cls === 'C' || group.cls === 'Excluded';

                    // å¦‚æœæ˜¯ Excludedï¼Œè´¹ç‡å¯èƒ½æé«˜æˆ–å»ºè®®äººå·¥æ ¸ä¿
                    // è¿™é‡Œä¸ºäº†æ¼”ç¤ºï¼ŒExcluded æŒ‰ rate è®¡ç®—ä½†ä¸å‚ä¸æœ€ä½ä¿è´¹å¯¹å†²ï¼ˆç›¸å¯¹ç‹¬ç«‹ï¼‰
                    let elasticPrem = declaredSales * effectiveRate * exRate;

                    // Excluded ç±»ç›®çš„æœ€ä½ä¿è´¹é€šå¸¸æ˜¯å¼ºåˆ¶çš„ï¼Œä¸”ä¸äº«å—æŠ˜æ‰£
                    const finalGroupPrem = Math.max(elasticPrem, effectiveMin);

                    return {
                        ...group,
                        weight,
                        allocatedSales,
                        declaredSales,
                        effectiveRate,
                        effectiveMin,
                        elasticPrem,
                        finalGroupPrem,
                        isMinApplied: effectiveMin > elasticPrem,
                        isHighRisk, // æ ‡è®°ä¸ºé«˜é£é™©
                        sales: group.excelTotalSales,
                        hasEstSales // æ ‡è®°è¯¥ç»„æ˜¯å¦åŒ…å«é¢„ä¼°æ•°æ®
                    };
                });

                setMerchantResults(rawMatches);
                setGroupedResults(groupsArray);
                setTotalFinalPrem(groupsArray.reduce((sum, g) => sum + g.finalGroupPrem, 0));

                // å¦‚æœå‘ç°ä½¿ç”¨äº† BSR é¢„ä¼°æ•°æ®ï¼Œç»™å‡ºæç¤º
                const totalEst = groupsArray.reduce((sum, g) => sum + (g.hasEstSales ? g.declaredSales : 0), 0);
                if (totalExcelSales === 0 && totalEst > 0) {
                    setRevenueRaw(fComm(totalEst)); // è‡ªåŠ¨å¡«å…¥æ€»é¢
                    addLog('System', `å·²åŸºäº BSR æ’åè‡ªåŠ¨é¢„ä¼°å¹´åº¦é”€å”®é¢: $${fComm(totalEst)}`);
                }
            };
            // ä¼˜åŒ–: å¤„ç†ç»„é”€å”®é¢ä¿®æ”¹ (åå‘è”åŠ¨æ€»é”€å”®é¢)
            const handleGroupSalesChange = (groupId, newVal) => {
                const val = parseFloat(newVal) || 0;

                // 1. å…ˆè®¡ç®—æ–°çš„åˆ†ç»„çŠ¶æ€
                const newGroups = groupedResults.map(g => {
                    if (g.id === groupId) {
                        const newG = { ...g, declaredSales: val };
                        // é‡æ–°è®¡ç®—è¯¥ç»„ä¿è´¹
                        const effectiveRate = deductibleType === '0' ? newG.rate * 1.2 : newG.rate;
                        const effectiveMin = deductibleType === '0' ? newG.min * 1.2 : newG.min;
                        let prem = val * effectiveRate * exRate;
                        newG.finalGroupPrem = Math.max(prem, effectiveMin);
                        newG.isMinApplied = effectiveMin > prem;
                        return newG;
                    }
                    return g;
                });

                // 2. å®æ—¶è®¡ç®—æ–°çš„æ€»é”€å”®é¢
                const newTotal = newGroups.reduce((sum, g) => sum + g.declaredSales, 0);

                setGroupedResults(newGroups);
                setTotalFinalPrem(newGroups.reduce((sum, g) => sum + g.finalGroupPrem, 0));

                // 3. æ›´æ–°é¡¶éƒ¨æ€»é¢æ˜¾ç¤º (ä»…æ›´æ–°æ•°å€¼ï¼Œä¸è§¦å‘é‡åˆ†é…)
                setRevenueRaw(fComm(newTotal));
            };

            // ä¼˜åŒ–: å¤„ç†é¡¶éƒ¨æ€»é”€å”®é¢ä¿®æ”¹ (æ­£å‘è”åŠ¨: æŒ‰æƒé‡åˆ†é…ç»™æ‰€æœ‰ç»„)
            const handleTotalRevenueChange = (newTotalRaw) => {
                const newTotal = parseFloat(newTotalRaw.replace(/[^0-9.]/g, '')) || 0;
                setRevenueRaw(newTotalRaw); // ä¿æŒç”¨æˆ·è¾“å…¥ä½“éªŒ (å…è®¸è¾“å…¥é€—å·ç­‰)

                if (groupedResults.length > 0) {
                    const newGroups = groupedResults.map(g => {
                        const newAllocated = newTotal * g.weight;
                        const effectiveRate = deductibleType === '0' ? g.rate * 1.2 : g.rate;
                        const effectiveMin = deductibleType === '0' ? g.min * 1.2 : g.min;
                        let prem = newAllocated * effectiveRate * exRate;

                        return {
                            ...g,
                            declaredSales: newAllocated, // åŒæ­¥æ›´æ–°ç”³æŠ¥é¢
                            allocatedSales: newAllocated,
                            finalGroupPrem: Math.max(prem, effectiveMin),
                            isMinApplied: effectiveMin > prem
                        };
                    });
                    setGroupedResults(newGroups);
                    setTotalFinalPrem(newGroups.reduce((sum, g) => sum + g.finalGroupPrem, 0));
                }
            };


            const handleMerchantUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const fileName = file.name;
                const fileExt = fileName.split('.').pop().toLowerCase();

                try {
                    if (fileExt === 'xlsx' || fileExt === 'xls' || fileExt === 'csv') {
                        // Excel/CSV å¤„ç†
                        const reader = new FileReader();
                        reader.onload = (evt) => {
                            try {
                                const wb = XLSX.read(evt.target.result, { type: 'binary' });
                                const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                                processMerchantReport(data);
                            } catch (err) { alert("Excel è§£æå¤±è´¥"); }
                        };
                        reader.readAsBinaryString(file);

                    } else if (fileExt === 'txt') {
                        // TXT æ–‡æœ¬å¤„ç†
                        const text = await file.text();
                        const parsedData = parseTextToData(text);
                        processMerchantReport(parsedData);

                    } else if (fileExt === 'pdf') {
                        // PDF å¤„ç†
                        const loadingTask = pdfjsLib.getDocument(URL.createObjectURL(file));
                        const pdf = await loadingTask.promise;
                        let fullText = '';
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const content = await page.getTextContent();
                            fullText += content.items.map(item => item.str).join(' ') + '\n';
                        }
                        const parsedData = parseTextToData(fullText);
                        processMerchantReport(parsedData);

                    } else if (fileExt === 'json') {
                        // JSON å¤„ç† (æ”¯æŒæ’ä»¶ä¸‹è½½çš„æŠ“å–æ•°æ®)
                        const text = await file.text();
                        const json = JSON.parse(text);
                        // é€‚é…ä¸¤ç§æ ¼å¼ï¼šæ’ä»¶å¸¦æœ‰çš„å…ƒæ•°æ®æ ¼å¼ {items: []} æˆ– çº¯æ•°ç»„
                        const items = Array.isArray(json) ? json : (json.items || []);
                        processMerchantReport(items);

                    } else if (fileExt === 'docx' || fileExt === 'doc') {
                        // Word æ–‡æ¡£å¤„ç†
                        const arrayBuffer = await file.arrayBuffer();
                        const result = await mammoth.extractRawText({ arrayBuffer });
                        const parsedData = parseTextToData(result.value);
                        processMerchantReport(parsedData);

                    } else {
                        alert("ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼\n\nè¯·ä¸Šä¼ ï¼šExcel (.xlsx/.xls)ã€CSVã€TXTã€PDF æˆ– Word (.docx)");
                    }
                } catch (err) {
                    console.error('æ–‡ä»¶è§£æé”™è¯¯:', err);
                    alert("æ–‡ä»¶è§£æå¤±è´¥: " + err.message);
                }
            };

            // æ–°å¢ï¼šä»æ–‡æœ¬ä¸­è§£ææ•°æ®çš„è¾…åŠ©å‡½æ•° (å‡çº§ä¸ºæ­£åˆ™æ™ºèƒ½åŒ¹é…æ¨¡å¼ + BSRæå–)
            const parseTextToData = (text) => {
                const lines = text.split('\n').filter(line => line.trim());
                const parsedData = [];
                let matchCount = 0;

                lines.forEach(line => {
                    // é¢„å¤„ç†ï¼šå»æ‰ä¸¤ç«¯ç©ºæ ¼
                    const content = line.trim();
                    if (!content) return;

                    let description = '';
                    let sales = 0;
                    let rank = 0;

                    // ç­–ç•¥ 0: å°è¯•æå– BSR æ’å (æ”¯æŒæ ¼å¼: #12,345 æˆ– BSR: 12345)
                    const rankMatch = content.match(/(?:#|BSR:?|Rank:?)\s?([0-9,]+)/i);
                    if (rankMatch) {
                        // æå–åç§»é™¤æ‰æ’åéƒ¨åˆ†ï¼Œé¿å…å¹²æ‰°æè¿°
                        rank = parseInt(rankMatch[1].replace(/,/g, '')) || 0;
                    }

                    // ç­–ç•¥ 1: Tab åˆ†éš”ç¬¦ (Excel copy-paste æˆ– TSV æ ¼å¼)
                    if (content.includes('\t')) {
                        const parts = content.split('\t');
                        // æ‰¾æœ€é•¿çš„ä¸€æ®µæ–‡æœ¬ï¼Œå¤§æ¦‚ç‡æ˜¯äº§å“æè¿°
                        description = parts.reduce((a, b) => a.length > b.length ? a : b, '');

                        // æ‰¾çœ‹èµ·æ¥åƒé‡‘é¢çš„åˆ—
                        const moneyPart = parts.find(p => /[\$Â¥ï¿¥]?\s?[0-9,]+\.\d{2}/.test(p) || (p.match(/[0-9]/) && p.length < 10 && !p.includes('#')));
                        if (moneyPart) {
                            sales = parseFloat(moneyPart.replace(/[^0-9.]/g, '')) || 0;
                        }

                        // å¦‚æœTabåˆ†å‰²é‡Œæœ‰æ˜ç¡®çš„æ’ååˆ— (æ•°å­—ä¸”ä¸åŒ…å«.)
                        if (!rank) {
                            const rankPart = parts.find(p => /^[0-9,]+$/.test(p.trim()) && p.trim().length < 8 && !p.includes('.'));
                            if (rankPart) rank = parseInt(rankPart.replace(/,/g, ''));
                        }
                    }
                    // ç­–ç•¥ 2: å•çº¯çš„é•¿æ–‡æœ¬è¡Œ
                    else {
                        // ç§»é™¤æ’åéƒ¨åˆ†å‰©ä¸‹çš„æ–‡æœ¬
                        let cleanHasRank = content;
                        if (rankMatch) {
                            cleanHasRank = content.replace(rankMatch[0], '').trim();
                        }

                        // å¦‚æœè¿™ä¸€è¡ŒåŒ…å«é‡‘é¢æ ¼å¼ï¼Œå°è¯•åˆ†å‰²
                        const salesMatch = cleanHasRank.match(/[\t\s]+[\$Â¥ï¿¥]?([0-9,]+\.?\d*)$/);

                        if (salesMatch) {
                            sales = parseFloat(salesMatch[1].replace(/,/g, '')) || 0;
                            description = cleanHasRank.replace(salesMatch[0], '').trim();
                        } else {
                            description = cleanHasRank;
                        }
                    }

                    // è¿‡æ»¤æ‰å¤ªçŸ­çš„æ— æ„ä¹‰è¡Œ
                    if (description.length > 3 && !['description', 'product', 'sales', 'sku', 'rank'].includes(description.toLowerCase())) {
                        parsedData.push({
                            'Product Description': description,
                            'Sales': sales,
                            'Rank': rank // ä¼ é€’ Rank å­—æ®µ
                        });
                        matchCount++;
                    }
                });

                if (parsedData.length === 0) {
                    alert("âš ï¸ æœªèƒ½ä»æ–‡ä»¶ä¸­è¯†åˆ«å‡ºæœ‰æ•ˆæ•°æ®\n\nè¯·ç¡®ä¿æ–‡ä»¶ä¸­åŒ…å« SKU (å¦‚ B08N5WRWNW) æˆ– å•†å“å+é‡‘é¢");
                } else {
                    console.log(`âœ… æ™ºèƒ½æ–‡æœ¬è§£ææˆåŠŸ: æå–åˆ° ${parsedData.length} æ¡æ•°æ®`);
                }

                return parsedData;
            };


            const handleAdminUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const wb = XLSX.read(evt.target.result, { type: 'binary' });
                        // 1. è¯»å–ä¸º JSON å¯¹è±¡æ•°ç»„ï¼Œä¸å†ä¾èµ–å›ºå®šè¡Œå·
                        const rawData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

                        if (!rawData || rawData.length === 0) {
                            alert("æœªåœ¨ Excel ä¸­æ‰¾åˆ°æœ‰æ•ˆæ•°æ®");
                            return;
                        }

                        // 2. æ™ºèƒ½è¯†åˆ«åˆ—åï¼ˆå–ç¬¬ä¸€è¡Œæ•°æ®çš„ key åšæ¢æµ‹ï¼‰
                        const sampleRow = rawData[0];
                        const keys = Object.keys(sampleRow);
                        const kLow = keys.map(k => k.toLowerCase());

                        // è¾…åŠ©å‡½æ•°ï¼šæŸ¥æ‰¾åŒ¹é…çš„ Keyï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰
                        const findKey = (patterns) => keys.find(k => patterns.some(p => k.toLowerCase().includes(p)));

                        const keyMap = {
                            id: findKey(['code', 'sku', 'id', 'ä»£ç ', 'ç¼–ç ', 'åºå·']),
                            cat: findKey(['cat', 'name', 'desc', 'type', 'åˆ†ç±»', 'åç§°', 'å“ç±»', 'description']),
                            cls: findKey(['class', 'level', 'risk', 'çº§åˆ«', 'é£é™©', 'ç­‰çº§']),
                            rate: findKey(['rate', 'prem', 'è´¹ç‡', 'ä»·æ ¼', 'ç‚¹ä½']),
                            min: findKey(['min', 'floor', 'æœ€ä½', 'èµ·æ­¥']),
                            // å…³é”®ï¼šå°è¯•æ‰¾ä¸“é—¨çš„å…³é”®è¯åˆ—ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåç»­ä¼šç”¨ cat å¡«å……
                            keywords: findKey(['keyword', 'tag', 'match', 'å…³é”®è¯', 'åŒ¹é…', 'description'])
                        };

                        console.log("è¯†åˆ«åˆ°çš„åˆ—æ˜ å°„:", keyMap);

                        // 3. æ„å»ºæ ‡å‡†æ•°æ®åº“ç»“æ„
                        const newDb = rawData.map(r => {
                            const catName = r[keyMap.cat] || 'æœªå‘½ååˆ†ç±»';
                            let keywords = r[keyMap.keywords];

                            // å¦‚æœæ²¡æœ‰ä¸“é—¨çš„ keywords åˆ—ï¼Œæˆ–è€… keywords ä¸ºç©ºï¼Œå°±ä½¿ç”¨åˆ†ç±»åç§°ä½œä¸ºå…³é”®è¯
                            // å¹¶è¿›è¡Œç®€å•çš„åˆ†è¯å¤„ç†ï¼Œå¢åŠ åŒ¹é…æ¦‚ç‡
                            if (!keywords) {
                                // ç§»é™¤æ‹¬å·å†…å®¹ï¼Œå¦‚ "Hand Tools (æ‰‹åŠ¨å·¥å…·)" -> "Hand Tools æ‰‹åŠ¨å·¥å…·"
                                keywords = String(catName).replace(/[()ï¼ˆï¼‰]/g, ' ').replace(/\//g, ' ');
                            } else {
                                keywords = String(keywords);
                            }

                            return {
                                id: String(r[keyMap.id] || Math.floor(Math.random() * 100000)),
                                cat: catName,
                                cls: r[keyMap.cls] || 'B', // é»˜è®¤ä¸º B ç±»
                                rate: parseFloat(String(r[keyMap.rate] || '0').replace(/%/, '')) / (String(r[keyMap.rate]).includes('%') ? 100 : 1) || 0.00065,
                                min: parseFloat(String(r[keyMap.min] || '0').replace(/[^0-9.]/g, '')) || 4500,
                                keywords: keywords
                            };
                        }).filter(item => item.id && item.cat); // è¿‡æ»¤æ— æ•ˆè¡Œ

                        if (newDb.length > 0) {
                            setDb(newDb);
                            setLastUploadStats({ count: newDb.length, fileName: file.name, time: new Date().toLocaleString() });
                            addLog('è´¹ç‡åº“æ›´æ–°', `ç®¡ç†å‘˜ä¸Šä¼ äº†æŠ¥ä»·è¡¨: ${file.name} (å…± ${newDb.length} æ¡)`, newDb.slice(0, 3));
                            alert(`âœ… è§„åˆ™å·²æ›´æ–° (${newDb.length} æ¡)\nç³»ç»Ÿå·²åŸºäºåˆ—åè‡ªåŠ¨è¯†åˆ«è§„åˆ™ï¼Œå¹¶æå–ç±»ç›®åç§°ä½œä¸ºåŒ¹é…å…³é”®è¯ã€‚`);
                        } else {
                            alert("æœªèƒ½è§£æå‡ºæœ‰æ•ˆè§„åˆ™ï¼Œè¯·æ£€æŸ¥è¡¨å¤´åã€‚");
                        }
                    } catch (err) {
                        console.error(err);
                        alert("Excel è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ã€‚");
                    }
                };
                reader.readAsBinaryString(file);
            };

            const extractRequirementsFromText = (text) => {
                const limitMatch = text.match(/(?:limit|occurrence)[^$0-9]*\$?\s?([\d,]{5,})/i);
                const dedMatch = text.match(/(?:deductible|retention)[^$0-9]*\$?\s?([\d,]{1,5})/i);
                const holderMatch = text.match(/Amazon\.com Services LLC/i);

                return [
                    { id: 'limit', label: 'å•æ¬¡äº‹æ•…èµ”ä»˜é™é¢', value: limitMatch ? parseInt(limitMatch[1].replace(/,/g, '')) : 1000000, unit: 'USD', desc: 'Auto-extracted from document' },
                    { id: 'deductible', label: 'å…èµ”é¢ä¸Šé™', value: dedMatch ? parseInt(dedMatch[1].replace(/,/g, '')) : 10000, unit: 'USD', desc: 'Auto-extracted from document' },
                    { id: 'holder', label: 'é™„åŠ è¢«ä¿é™©äººæè¿°', value: holderMatch ? "Amazon.com Services LLC. its affiliates and assignees" : 'æœªè¯†åˆ«åˆ°ç²¾ç¡®æŠ¬å¤´', unit: 'Text', desc: 'Auto-extracted from document' }
                ];
            };

            const handleCoiRulesUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const ext = file.name.split('.').pop().toLowerCase();
                let extractedText = "";

                try {
                    if (ext === 'xlsx' || ext === 'xls' || ext === 'csv') {
                        const reader = new FileReader();
                        reader.onload = (evt) => {
                            const wb = XLSX.read(evt.target.result, { type: 'binary' });
                            const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                            if (data.length > 0) {
                                setCoiRules(data);
                                addLog('COIè§„åˆ™æ›´æ–°', `ç®¡ç†å‘˜ä¸Šä¼  Excel æ ‡å‡†: ${file.name}`, data);
                                alert(`âœ… COI å®¡æ ¸æ ‡å‡†å·²é€šè¿‡ Excel æ›´æ–°`);
                            }
                        };
                        reader.readAsBinaryString(file);
                        return;
                    }

                    if (ext === 'pdf') {
                        const loadingTask = pdfjsLib.getDocument(URL.createObjectURL(file));
                        const pdf = await loadingTask.promise;
                        let fullText = "";
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const content = await page.getTextContent();
                            fullText += content.items.map(item => item.str).join(' ');
                        }
                        extractedText = fullText;
                    } else if (ext === 'docx') {
                        const arrayBuffer = await file.arrayBuffer();
                        const result = await mammoth.extractRawText({ arrayBuffer });
                        extractedText = result.value;
                    } else if (ext === 'txt') {
                        extractedText = await file.text();
                    } else {
                        alert("ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼");
                        return;
                    }

                    if (extractedText) {
                        const newRules = extractRequirementsFromText(extractedText);
                        setCoiRules(newRules);
                        addLog('COIè§„åˆ™æ›´æ–°', `åŸºäº AI/Regex ä» ${ext.toUpperCase()} æ–‡æ¡£æå–æ ‡å‡†: ${file.name}`, newRules);
                        alert(`âœ… å·²ä» ${ext.toUpperCase()} æ–‡æ¡£æˆåŠŸæå–åˆ¤å®šé€»è¾‘`);
                    }

                } catch (err) {
                    console.error(err);
                    alert("æ–‡æ¡£è§£æå¤±è´¥: " + err.message);
                }
            };

            const downloadDistributionFile = async () => {
                try {
                    const response = await fetch(window.location.href);
                    const sourceHtml = await response.text();

                    const frozenDb = JSON.stringify(db);
                    const frozenCoi = JSON.stringify(coiRules);
                    const frozenEx = exRate.toString();

                    let distHtml = sourceHtml
                        .replace(/const DEFAULT_DB = \[.*?\];/s, `const DEFAULT_DB = ${frozenDb};`)
                        .replace(/const DEFAULT_COI_RULES = \[.*?\];/s, `const DEFAULT_COI_RULES = ${frozenCoi};`)
                        .replace(/parseFloat\(localStorage\.getItem\('cgl_ex_rate'\)\) \|\| 7.2/, `${frozenEx}`)
                        .replace(/const \[isCustomerMode\] = useState\(.*?\);/, `const [isCustomerMode] = useState(true);`);

                    const blob = new Blob([distHtml], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `CGL_Compliance_Tool_${new Date().toISOString().split('T')[0]}.html`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    addLog('å¯¼å‡ºåˆ†å‘', 'æˆåŠŸç”Ÿæˆäº†ç¡¬ç¼–ç è´¹ç‡çš„å®¢æˆ·è„±æœºç‰ˆã€‚');
                } catch (err) {
                    alert("å¯¼å‡ºå¤±è´¥ï¼Œè¯·å°è¯•åœ¨æœåŠ¡å™¨ç¯å¢ƒä¸‹è¿è¡Œï¼ˆå¦‚ Netlify/Vercelï¼‰ï¼š" + err.message);
                }
            };

            // Generate PDF Report
            const generateRiskReport = async () => {
                const element = document.getElementById('risk-report-canvas');
                if (!element) return;

                try {
                    addLog('System', 'æ­£åœ¨ç”Ÿæˆé£é™©åˆ†ææŠ¥å‘Š PDF...');
                    const canvas = await html2canvas(element, {
                        scale: 2, // Retina quality
                        useCORS: true,
                        backgroundColor: '#fffbf0'
                    });

                    const imgData = canvas.toDataURL('image/png');

                    // A4 size logic or Mobile Size
                    // Let's us standard PDF logic
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: [100, 180] // Custom mobile-like ratio 
                    });

                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save(`CGL_Risk_Report_${storeInfo.name.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0, 10)}.pdf`);

                    addLog('System', 'âœ… PDF æŠ¥å‘Šç”ŸæˆæˆåŠŸ');
                } catch (err) {
                    console.error(err);
                    alert("ç”Ÿæˆ PDF å¤±è´¥: " + err.message);
                }
            };

            return (
                <div className="min-h-screen relative no-scrollbar">
                    <nav className="p-6 bg-white border-b sticky top-0 z-40 flex justify-between items-center px-12">
                        <div className="flex items-center gap-4 cursor-pointer" onClick={() => setView('home')}>
                            <h1 className="text-xl font-bold tracking-tight text-gray-900">
                                {isCustomerMode ? 'æŠ¥ä»·åˆè§„ä¸­å¿ƒ' : 'äºšé©¬é€Š CGL æ™ºèƒ½ä½“'}
                            </h1>
                        </div>
                        <div className="flex gap-6 items-center">
                            <button onClick={requestSync} className="text-[10px] font-bold text-gray-400 hover:text-blue-600 uppercase tracking-[0.2em]" title="å¼ºåˆ¶åŒæ­¥æ’ä»¶æ•°æ®">
                                Sync Data
                            </button>
                            {!isCustomerMode && <button onClick={() => setView('admin')} className="text-[10px] font-bold text-gray-400 hover:text-blue-600 uppercase tracking-[0.2em]">Admin Portal</button>}
                        </div>
                    </nav>

                    <main className="max-w-6xl mx-auto p-12">
                        {view === 'home' && (
                            <div className="py-20 space-y-24 animate-in fade-in duration-1000">
                                <div className="space-y-6 text-center">
                                    <h2 className="text-8xl font-black tracking-tighter leading-[0.8] mb-8">
                                        {isCustomerMode ? 'åˆè§„åˆ›é€ ä»·å€¼' : 'åˆ†å“ç±»è®¡è´¹'}<br />
                                        <span className="text-blue-600">{isCustomerMode ? 'ä¸“ä¸šçš„åˆè§„æŠ¥ä»·' : 'æ›´ä¸“ä¸šçš„å¯¹å†²'}</span>
                                    </h2>
                                    <p className="text-xl text-gray-400 max-w-2xl mx-auto font-medium">
                                        {isCustomerMode ? 'è¯·ä¸Šä¼ æ‚¨çš„é”€å”®æŠ¥å‘Šï¼Œæˆ‘ä»¬å°†ä¸ºæ‚¨æ ¸ç®—ç²¾å‡†çš„ä¿è´¹é¢„ä¼°å¹¶æ ¸å¯¹ä¿å•åˆè§„æ€§ã€‚' : 'æ”¯æŒæŒ‰é£é™©å“ç±»è‡ªåŠ¨æ±‡æ€»é”€å”®é¢ï¼Œç‹¬ç«‹è®¡ç®—æœ€ä½ä¿è´¹ä¸å¼¹æ€§è´¹ç‡ã€‚'}
                                    </p>
                                </div>
                                <div className="grid md:grid-cols-2 gap-10">
                                    <div onClick={() => setView('merchant')} className="apple-card p-16 cursor-pointer group hover:bg-white/80">
                                        <div className="text-5xl mb-10 group-hover:scale-110 transition-transform">ğŸ“Š</div>
                                        <h3 className="text-3xl font-black mb-4 tracking-tight">æ™ºèƒ½æŠ¥ä»·åˆ†æ</h3>
                                        <p className="text-gray-400 leading-relaxed font-medium">ä¸Šä¼ é”€å”®æŠ¥å‘Šï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æ ¸ç®—æœ€ä¼˜ä¿è´¹æ–¹æ¡ˆã€‚</p>
                                    </div>
                                    <div onClick={() => setView('coi')} className="apple-card p-16 cursor-pointer group">
                                        <div className="text-5xl mb-10 group-hover:scale-110 transition-transform">ğŸ›¡ï¸</div>
                                        <h3 className="text-3xl font-black mb-4 tracking-tight">COI å‡­è¯é¢„å®¡</h3>
                                        <p className="text-gray-400 leading-relaxed font-medium">AI æ‰«æä¿å•ï¼Œæ ¸å¯¹äºšé©¬é€Š $1,000,000 å¼ºåˆ¶é™é¢è¦æ±‚ã€‚</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === 'merchant' && (
                            <div className="space-y-10 animate-in fade-in duration-700">
                                <button onClick={() => setView('home')} className="text-blue-600 font-bold text-sm">â† è¿”å›ä¸»é¡µå¯¼èˆª</button>

                                <div className="apple-card p-12 space-y-12">
                                    <div className="grid md:grid-cols-3 gap-8">
                                        <div className="md:col-span-2 space-y-2">
                                            <label className="text-xs font-black text-gray-400 uppercase tracking-widest ml-1">å…¨è´¦æˆ·é¢„è®¡å¹´åº¦æ€»é”€å”®é¢ (Annual USD Revenue)</label>
                                            <div className="relative">
                                                <span className="absolute left-6 top-1/2 -translate-y-1/2 text-gray-300 font-bold text-2xl">$</span>
                                                <input type="text" className="w-full pl-12 pr-6 py-4 rounded-[24px] bg-gray-50 border-none font-black text-3xl text-gray-900 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all" value={revenueRaw} onChange={e => handleTotalRevenueChange(e.target.value)} />
                                            </div>
                                        </div>
                                        <div className="space-y-4">
                                            <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-1">å…èµ”é¢æ§åˆ¶ (Deductible)</label>
                                            <select className="w-full p-6 h-[88px] rounded-[28px] bg-gray-50 border-none font-black text-xl text-gray-900 focus:bg-white appearance-none cursor-pointer outline-none transition-all" value={deductibleType} onChange={e => setDeductibleType(e.target.value)}>
                                                <option value="10000">10,000 ç¾é‡‘ (æ ‡å‡†)</option>
                                                <option value="0">æ— å…èµ” (Nil)</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div className="border-2 border-dashed border-gray-100 rounded-[40px] p-20 text-center hover:bg-blue-50/20 hover:border-blue-400 transition-all relative group bg-gray-50/30">
                                        <input type="file" accept=".xlsx,.xls,.csv,.txt,.pdf,.docx,.doc" className="absolute inset-0 opacity-0 cursor-pointer z-10" onChange={handleMerchantUpload} />
                                        <div className="space-y-4">
                                            <div className="text-5xl group-hover:scale-110 transition-transform">ğŸ“„</div>
                                            <h4 className="text-xl font-black">ä¸Šä¼  SKU è¯¦æƒ…æŠ¥å‘Š</h4>
                                            <p className="text-gray-400 font-medium italic">æ”¯æŒ Excelã€CSVã€TXTã€PDFã€Word ç­‰æ ¼å¼</p>
                                        </div>
                                    </div>

                                    {groupedResults.length > 0 && (
                                        <div className="space-y-12 animate-in slide-in-from-bottom-6 duration-700">
                                            <div className="relative group">
                                                <div className="absolute -inset-1 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-[48px] blur-2xl opacity-20"></div>
                                                <div className="relative bg-[#1d1d1f] p-12 rounded-[48px] text-white flex flex-col md:flex-row justify-between items-center gap-12 border border-white/5">
                                                    <div className="space-y-4 flex-1">
                                                        <div className="inline-block px-3 py-1 bg-blue-500/20 text-blue-400 text-[10px] font-black rounded-full uppercase tracking-widest">Aggregate Annual Premium (RMB)</div>
                                                        <div className="flex items-baseline gap-3">
                                                            <span className="text-4xl font-bold text-white/40">Â¥</span>
                                                            <span className="text-[100px] font-black leading-none tracking-tighter tabular-nums">{fComm(totalFinalPrem)}</span>
                                                        </div>
                                                        <div className="text-white/40 font-bold text-sm bg-white/5 p-4 rounded-2xl flex items-center gap-3">
                                                            <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                                                            è®¡è´¹é€»è¾‘ï¼šå·²å®Œæˆ {groupedResults.length} ä¸ªé£é™©ç¾¤ç»„çš„ç‹¬ç«‹é˜ˆå€¼è®¡ç®—å¹¶å®Œæˆæ€»å’Œç´¯åŠ ã€‚
                                                        </div>
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-4 min-w-[340px]">
                                                        <div className="bg-white/5 p-6 rounded-[32px] border border-white/5 text-center">
                                                            <p className="text-[9px] text-white/40 font-bold uppercase mb-2">ç»“ç®—æ±‡ç‡</p>
                                                            <p className="text-2xl font-black">{exRate}</p>
                                                        </div>
                                                        <div className="bg-white/5 p-6 rounded-[32px] border border-white/5 text-center">
                                                            <p className="text-[9px] text-white/40 font-bold uppercase mb-2">ç±»ç›®æ€»æ•°</p>
                                                            <p className="text-2xl font-black">{groupedResults.length}</p>
                                                        </div>
                                                        <div className="col-span-2 bg-blue-600/10 p-6 rounded-[32px] border border-blue-500/20 text-center">
                                                            <p className="text-[9px] text-blue-400 font-bold uppercase mb-2">å…èµ”è®¾ç½®</p>
                                                            <p className="text-lg font-black uppercase text-blue-100">{deductibleType === '0' ? 'Nil (1.2x Uplift)' : 'USD 10K (Standard)'}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>



                                            {/* æ–°å¢: é£é™©åˆ†ç±»æ±‡æ€»ä¸ç”³æŠ¥å¡ç‰‡åŒº */}
                                            <div className="space-y-6 pt-12 border-t border-gray-100">
                                                <div className="flex items-center justify-between pb-4">
                                                    <div>
                                                        <h4 className="text-xl font-black text-gray-900 tracking-tight">é£é™©åˆ†ç±»è¯¦æƒ…ä¸ç”³æŠ¥ (Submission Details)</h4>
                                                        <p className="text-xs text-gray-400 font-medium mt-1">è¯·æ ¸å¯¹å„å¤§ç±»ç”³æŠ¥é”€å”®é¢ï¼Œç³»ç»Ÿå°†åŸºäºç”³æŠ¥é¢é‡æ–°è®¡ç®—ä¿è´¹</p>
                                                    </div>
                                                    <span className="text-xs font-bold text-gray-400 uppercase tracking-widest bg-gray-50 px-3 py-1 rounded-full">Automated Analysis</span>
                                                </div>

                                                {/* PDF Export Button & Hidden Template */}
                                                <div className="flex justify-end mb-4">
                                                    <button
                                                        onClick={() => generateRiskReport()}
                                                        className="flex items-center gap-2 bg-gradient-to-r from-red-500 to-pink-600 text-white px-4 py-2 rounded-full font-bold text-xs shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5"
                                                    >
                                                        <span>ğŸ“¸</span> ç”Ÿæˆå°çº¢ä¹¦é£é£é™©æŠ¥å‘Š (Export PDF)
                                                    </button>
                                                </div>

                                                {/* Hidden Report Container for Capture */}
                                                <div style={{ position: 'absolute', left: '-9999px', top: 0 }}>
                                                    <div id="risk-report-canvas" className="w-[375px] bg-[#fffbf0] p-6 text-gray-900 font-sans relative overflow-hidden">
                                                        {/* Decorative Background Elements */}
                                                        <div className="absolute top-0 right-0 w-32 h-32 bg-yellow-200 rounded-full blur-3xl opacity-50 -mr-10 -mt-10"></div>
                                                        <div className="absolute bottom-0 left-0 w-40 h-40 bg-pink-200 rounded-full blur-3xl opacity-50 -ml-10 -mb-10"></div>

                                                        {/* Header */}
                                                        <div className="relative z-10 mb-6">
                                                            <div className="text-[10px] font-black tracking-[0.3em] text-gray-400 uppercase mb-2">RISK ASSESSMENT</div>
                                                            <h1 className="text-2xl font-black leading-tight mb-2 text-gray-900 border-l-4 border-black pl-3">
                                                                {storeInfo.name}<br />
                                                                <span className="text-red-500">äº§å“åˆè§„é£æ§æŠ¥å‘Š</span>
                                                            </h1>
                                                            <div className="flex gap-2 text-[9px] font-bold text-gray-500 mt-3">
                                                                <span className="bg-white px-2 py-1 rounded border border-gray-200 shadow-sm">ğŸ—“ï¸ {new Date().toLocaleDateString()}</span>
                                                                <span className="bg-white px-2 py-1 rounded border border-gray-200 shadow-sm">ğŸ“¦ {groupedResults.reduce((acc, g) => acc + g.itemsCount, 0)} Items Scanned</span>
                                                            </div>
                                                        </div>

                                                        {/* Core Risk Metrics */}
                                                        <div className="grid grid-cols-2 gap-3 mb-6 relative z-10">
                                                            <div className="bg-white p-3 rounded-xl shadow-sm border border-gray-100">
                                                                <div className="text-2xl mb-1">ğŸš¨</div>
                                                                <div className="text-xs text-gray-400 font-bold uppercase">High Risk Groups</div>
                                                                <div className="text-xl font-black text-red-500">
                                                                    {groupedResults.filter(g => g.cls === 'C' || g.cls === 'Excluded').length}
                                                                </div>
                                                            </div>
                                                            <div className="bg-white p-3 rounded-xl shadow-sm border border-gray-100">
                                                                <div className="text-2xl mb-1">ğŸ›¡ï¸</div>
                                                                <div className="text-xs text-gray-400 font-bold uppercase">Avg. Premium Rate</div>
                                                                <div className="text-xl font-black text-blue-600">
                                                                    {(groupedResults.reduce((acc, g) => acc + g.rate, 0) / (groupedResults.length || 1)).toFixed(3)}%
                                                                </div>
                                                            </div>
                                                        </div>

                                                        {/* Category Breakdown (No detailed SKUs) */}
                                                        <div className="space-y-3 mb-6 relative z-10">
                                                            <h3 className="text-sm font-black border-b pb-2 flex justify-between items-center">
                                                                <span>ğŸ“Š é£é™©åˆ†å¸ƒ (Risk Distribution)</span>
                                                            </h3>
                                                            {groupedResults.slice(0, 6).map((group, i) => (
                                                                <div key={i} className="flex items-center justify-between bg-white p-3 rounded-lg shadow-sm border border-gray-50">
                                                                    <div className="flex items-center gap-3">
                                                                        <span className={`w-8 h-8 flex items-center justify-center rounded-lg font-black text-xs ${group.cls === 'C' || group.cls === 'Excluded' ? 'bg-red-100 text-red-600' : 'bg-gray-100 text-gray-600'}`}>
                                                                            {group.cls}
                                                                        </span>
                                                                        <div>
                                                                            <div className="font-bold text-xs text-gray-800 line-clamp-1 w-32">{group.cat}</div>
                                                                            <div className="text-[9px] text-gray-400 font-medium">{group.itemsCount} SKU Â· {group.rate}% Rate</div>
                                                                        </div>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        {group.cls === 'C' || group.cls === 'Excluded' ?
                                                                            <span className="text-[9px] bg-red-500 text-white px-2 py-0.5 rounded font-bold">HIGH RISK</span>
                                                                            : <span className="text-[9px] bg-green-100 text-green-600 px-2 py-0.5 rounded font-bold">PASS</span>
                                                                        }
                                                                    </div>
                                                                </div>
                                                            ))}
                                                            {groupedResults.length > 6 && (
                                                                <div className="text-center text-[10px] text-gray-400 font-medium italic">...ä»¥åŠå…¶ä»– {groupedResults.length - 6} ä¸ªé£é™©ç»„åˆ«</div>
                                                            )}
                                                        </div>

                                                        {/* Expert Insights (Top 1) */}
                                                        <div className="bg-gray-900 text-white p-4 rounded-xl shadow-lg relative z-10">
                                                            <div className="flex items-center gap-2 mb-2">
                                                                <span className="text-xl">ğŸ’¡</span>
                                                                <span className="text-xs font-black uppercase tracking-widest text-yellow-400">Expert Observation</span>
                                                            </div>
                                                            <div className="text-[10px] leading-relaxed opacity-90 font-medium">
                                                                {(() => {
                                                                    // Find the most critical insight
                                                                    const highRiskGroup = groupedResults.find(g => (g.cls === 'C' || g.cls === 'Excluded') && g.deepAnalysis?.focus);
                                                                    if (highRiskGroup && highRiskGroup.deepAnalysis) {
                                                                        // Strip HTML for PDF cleanliness
                                                                        const focusRaw = highRiskGroup.deepAnalysis.focus.replace(/<[^>]+>/g, '');
                                                                        return `[${highRiskGroup.cat}]: ${focusRaw.substring(0, 120)}...`;
                                                                    }
                                                                    return "æ ¹æ®CGLæ•°æ®æ¨¡å‹ï¼Œæ‚¨çš„äº§å“ç»„åˆæ•´ä½“é£é™©å¯æ§ï¼Œä½†ä»å»ºè®®å…³æ³¨é«˜é¢‘é€€è´§å“ç±»çš„æ½œåœ¨è´£ä»»é£é™©ã€‚";
                                                                })()}
                                                            </div>
                                                            <div className="mt-3 pt-3 border-t border-white/10 flex justify-between items-center">
                                                                <span className="text-[8px] text-white/40">GENERATED BY CGL AI AGENT</span>
                                                                <div className="flex gap-1">
                                                                    <div className="w-1.5 h-1.5 rounded-full bg-red-500"></div>
                                                                    <div className="w-1.5 h-1.5 rounded-full bg-yellow-500"></div>
                                                                    <div className="w-1.5 h-1.5 rounded-full bg-green-500"></div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div className="space-y-4">
                                                    {groupedResults.map((group) => {
                                                        const isHighRisk = group.cls === 'C' || group.cls === 'Excluded';

                                                        return (
                                                            <div key={group.id} className={`bg-white rounded-[24px] border ${isHighRisk ? 'border-red-200 bg-red-50/10' : 'border-gray-100'} overflow-hidden shadow-sm hover:shadow-md transition-all duration-300`}>
                                                                {/* å¡ç‰‡å¤´éƒ¨ */}
                                                                <div className="p-6 flex flex-col md:flex-row gap-6 md:items-center justify-between">
                                                                    {/* å·¦ä¾§ï¼šåˆ†ç±»ä¿¡æ¯ */}
                                                                    <div className="flex items-center gap-4 min-w-[300px]">
                                                                        <div className={`w-12 h-12 rounded-2xl flex items-center justify-center text-2xl font-black ${isHighRisk ? 'bg-red-100 text-red-600' : 'bg-blue-50 text-blue-600'}`}>
                                                                            {group.cls}
                                                                        </div>
                                                                        <div>
                                                                            <div className="flex items-center gap-2">
                                                                                <h5 className="font-bold text-gray-900">{group.cat}</h5>
                                                                                {isHighRisk && <span className="text-[10px] bg-red-600 text-white px-2 py-0.5 rounded-full font-bold">HIGH RISK</span>}
                                                                            </div>
                                                                            <p className="text-xs text-gray-400 font-medium mt-1">åŒ…å« {group.items?.length || 0} ä¸ª SKU Â· é£é™©è´¹ç‡ {group.rate}%</p>
                                                                        </div>
                                                                    </div>

                                                                    {/* ä¸­é—´ï¼šé”€å”®é¢ç”³æŠ¥ */}
                                                                    <div className="flex-1 min-w-[200px]">
                                                                        <label className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 flex justify-between items-center">
                                                                            <span>è¯¥ç±»ç›®ç”³æŠ¥é”€å”®é¢ (USD)</span>
                                                                            {group.hasEstSales && (
                                                                                <span className="text-[9px] bg-gradient-to-r from-orange-400 to-red-400 text-white px-2 py-0.5 rounded-full font-black tracking-widest flex items-center gap-1 shadow-sm animate-pulse">
                                                                                    <span>ğŸª„</span> AUTO-ESTIMATED
                                                                                </span>
                                                                            )}
                                                                        </label>
                                                                        <div className="relative group/input">
                                                                            <span className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold">$</span>

                                                                            {/* å®æ—¶æ ¼å¼åŒ–æç¤º (å½“ç”¨æˆ·è¾“å…¥æ—¶æ˜¾ç¤ºå¸¦é€—å·çš„æ•°å€¼) */}
                                                                            {editState.id === group.id && (
                                                                                <div className="absolute right-0 -top-6 text-[10px] bg-blue-600 text-white px-2 py-0.5 rounded shadow-sm font-bold animate-in fade-in zoom-in duration-200 z-10">
                                                                                    {fComm(parseFloat(editState.val) || 0)}
                                                                                </div>
                                                                            )}

                                                                            <input
                                                                                type="text"
                                                                                className={`w-full pl-8 pr-4 py-3 bg-gray-50 border-transparent rounded-xl text-gray-900 font-bold focus:bg-white focus:ring-2 focus:ring-blue-500 transition-all text-right ${editState.id === group.id ? 'ring-2 ring-blue-500 bg-white' : ''}`}
                                                                                value={editState.id === group.id ? editState.val : fComm(group.declaredSales)}
                                                                                onFocus={() => setEditState({ id: group.id, val: group.declaredSales === 0 ? '' : String(group.declaredSales) })}
                                                                                onBlur={() => setEditState({ id: null, val: '' })}
                                                                                onChange={(e) => {
                                                                                    const raw = e.target.value.replace(/[^0-9.]/g, '');
                                                                                    setEditState({ id: group.id, val: raw });
                                                                                    handleGroupSalesChange(group.id, raw);
                                                                                }}
                                                                            />
                                                                            <div className="absolute right-0 -bottom-5 text-[10px] text-gray-400 opacity-0 group-hover/input:opacity-100 transition-opacity">
                                                                                ExcelæŠ“å–æ€»é¢: ${fComm(group.sales)}
                                                                            </div>
                                                                        </div>
                                                                    </div>

                                                                    {/* å³ä¾§ï¼šè®¡ç®—ç»“æœ */}
                                                                    <div className="text-right min-w-[150px]">
                                                                        <label className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block">é¢„ä¼°ä¿è´¹ (CNY)</label>
                                                                        <div className="text-2xl font-black text-gray-900 flex items-center justify-end gap-1">
                                                                            <span className="text-sm text-gray-300">Â¥</span>
                                                                            {fComm(group.finalGroupPrem)}
                                                                        </div>
                                                                        {group.isMinApplied && <span className="text-[10px] text-orange-500 font-bold bg-orange-50 px-2 rounded-full">å·²åº”ç”¨æœ€ä½ä¿è´¹</span>}
                                                                    </div>
                                                                </div>

                                                                {/* æŠ˜å åŒºåŸŸï¼šSKU æ˜ç»† */}
                                                                <details className="border-t border-gray-50 group/details">
                                                                    <summary className="p-4 flex items-center justify-center cursor-pointer hover:bg-gray-50 transition-colors text-xs font-bold text-gray-400 uppercase tracking-widest select-none list-none">
                                                                        <span className="group-open/details:hidden">æŸ¥çœ‹é£é™©åˆ†æä¸ SKU æ˜ç»† ({group.items?.length}) â–¼</span>
                                                                        <span className="hidden group-open/details:block">æ”¶èµ·æ˜ç»† â–²</span>
                                                                    </summary>
                                                                    <div className="p-8 bg-gray-50/50 space-y-6">
                                                                        {/* Expert Risk Analysis Section */}
                                                                        <div className="flex gap-4">
                                                                            <div className="text-2xl mt-1">ğŸ§</div>
                                                                            <div className="space-y-2">
                                                                                <h6 className="text-[10px] font-black text-gray-900 uppercase tracking-widest">Risk Analysis (ä¸“å®¶é£é™©æ´å¯Ÿ)</h6>
                                                                                <RiskAnalysisCard
                                                                                    analysis={group.items?.[0]?.deep_analysis}
                                                                                    isHighRisk={isHighRisk}
                                                                                />
                                                                            </div>
                                                                        </div>

                                                                        {/* SKU List */}
                                                                        <div className="space-y-3 pl-10">
                                                                            <h6 className="text-[10px] font-black text-gray-400 uppercase tracking-widest">Included SKUs (è¯¥ç±»ç›®ä¸‹åŒ…å«çš„äº§å“)</h6>
                                                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                                                                {group.items?.map((item, idx) => {
                                                                                    // --- Translation Helper (Localized) ---
                                                                                    // 1. Built-in Basic Dictionary (Fallback)
                                                                                    const BASIC_DICT = {
                                                                                        // Tools & Hardware
                                                                                        'drill': 'é’»æœº', 'saw': 'é”¯', 'grinder': 'ç£¨å…‰æœº', 'sander': 'ç ‚å…‰æœº', 'polisher': 'æŠ›å…‰æœº',
                                                                                        'wrench': 'æ‰³æ‰‹', 'plier': 'é’³å­', 'screwdriver': 'èºä¸åˆ€', 'hammer': 'é”¤å­', 'mallet': 'æ§Œ',
                                                                                        'ratchet': 'æ£˜è½®', 'socket': 'å¥—ç­’', 'bit': 'æ‰¹å¤´', 'blade': 'åˆ€ç‰‡', 'disc': 'ç£¨ç›˜',
                                                                                        'clamp': 'å¤¹å…·', 'vise': 'è™é’³', 'tool': 'å·¥å…·', 'set': 'å¥—è£…', 'kit': 'å¥—ä»¶',
                                                                                        'screw': 'èºä¸', 'bolt': 'èºæ “', 'nut': 'èºæ¯', 'washer': 'å«åœˆ', 'nail': 'é’‰å­',
                                                                                        'hook': 'æŒ‚é’©', 'hinge': 'é“°é“¾', 'lock': 'é”', 'knob': 'æ—‹é’®', 'handle': 'æŠŠæ‰‹',
                                                                                        // Security & Smart Home
                                                                                        'alarm': 'æŠ¥è­¦å™¨', 'security': 'å®‰é˜²', 'camera': 'æ‘„åƒå¤´', 'system': 'ç³»ç»Ÿ', 'sensor': 'ä¼ æ„Ÿå™¨',
                                                                                        'detector': 'æ¢æµ‹å™¨', 'smart': 'æ™ºèƒ½', 'wifi': 'WiFi', 'remote': 'é¥æ§', 'doorbell': 'é—¨é“ƒ',
                                                                                        'siren': 'è­¦æŠ¥å™¨', 'keypad': 'é”®ç›˜', 'motion': 'ç§»åŠ¨ä¾¦æµ‹', 'home': 'å®¶å±…',
                                                                                        // Electronics & Accessories
                                                                                        'battery': 'ç”µæ± ', 'charger': 'å……ç”µå™¨', 'cable': 'çº¿ç¼†', 'cord': 'ç”µæºçº¿', 'adapter': 'é€‚é…å™¨',
                                                                                        'plug': 'æ’å¤´', 'switch': 'å¼€å…³', 'led': 'LEDç¯', 'light': 'ç¯', 'lamp': 'å°ç¯',
                                                                                        'holder': 'æ”¯æ¶', 'mount': 'åº•åº§', 'stand': 'ç«‹æ¶', 'case': 'ä¿æŠ¤å£³', 'cover': 'ä¿æŠ¤ç½©',
                                                                                        'screen': 'å±å¹•', 'display': 'æ˜¾ç¤ºå™¨', 'mouse': 'é¼ æ ‡', 'keyboard': 'é”®ç›˜', 'pad': 'å«',
                                                                                        // Automotive
                                                                                        'car': 'æ±½è½¦', 'auto': 'æ±½è½¦', 'motor': 'ç”µæœº', 'engine': 'å¼•æ“', 'tire': 'è½®èƒ', 'wheel': 'è½®æ¯‚',
                                                                                        'bumper': 'ä¿é™©æ ', 'wiper': 'é›¨åˆ®', 'mat': 'è„šå«', 'dash': 'ä»ªè¡¨ç›˜', 'seat': 'åº§æ¤…',
                                                                                        // Kitchen & Household
                                                                                        'kitchen': 'å¨æˆ¿', 'knife': 'åˆ€', 'spoon': 'å‹º', 'fork': 'å‰', 'pan': 'å¹³åº•é”…', 'pot': 'é”…',
                                                                                        'bottle': 'ç“¶å­', 'cup': 'æ¯å­', 'mug': 'é©¬å…‹æ¯', 'glass': 'ç»ç’ƒæ¯', 'plate': 'ç›˜å­',
                                                                                        'shelf': 'æ¶å­', 'rack': 'ç½®ç‰©æ¶', 'organizer': 'æ”¶çº³ç›’', 'box': 'ç›’å­', 'bag': 'è¢‹å­',
                                                                                        'towel': 'æ¯›å·¾', 'brush': 'åˆ·å­', 'mop': 'æ‹–æŠŠ', 'broom': 'æ‰«å¸š', 'soap': 'è‚¥çš‚',
                                                                                        'heater': 'åŠ çƒ­å™¨', 'fan': 'é£æ‰‡', 'air': 'ç©ºæ°”', 'fryer': 'ç‚¸é”…', 'oven': 'çƒ¤ç®±',
                                                                                        'table': 'æ¡Œå­', 'chair': 'æ¤…å­', 'cabinet': 'æŸœå­', 'bed': 'åºŠ', 'pillow': 'æ•å¤´',

                                                                                        // Mother & Baby (Expanded)
                                                                                        'baby': 'å©´å„¿', 'kid': 'å„¿ç«¥', 'child': 'å­©å­', 'toddler': 'å¹¼å„¿', 'infant': 'å©´å¹¼å„¿',
                                                                                        'diaper': 'å°¿å¸ƒ', 'wipe': 'æ¹¿å·¾', 'bottle': 'å¥¶ç“¶', 'nipple': 'å¥¶å˜´', 'pacifier': 'å®‰æŠšå¥¶å˜´',
                                                                                        'stroller': 'æ¨è½¦', 'crib': 'å©´å„¿åºŠ', 'carrier': 'èƒŒå¸¦', 'seat': 'åº§æ¤…', 'bib': 'å›´å…œ',
                                                                                        'toy': 'ç©å…·', 'doll': 'ç©å¶', 'game': 'æ¸¸æˆ', 'puzzle': 'æ‹¼å›¾', 'block': 'ç§¯æœ¨',
                                                                                        'monitor': 'ç›‘è§†å™¨', 'lock': 'é”', 'gate': 'é—¨æ ', 'corner': 'è§’', 'guard': 'æŠ¤è§’',

                                                                                        // Pets (Expanded)
                                                                                        'pet': 'å® ç‰©', 'dog': 'ç‹—', 'cat': 'çŒ«', 'fish': 'é±¼', 'bird': 'é¸Ÿ',
                                                                                        'leash': 'ç‰µå¼•ç»³', 'collar': 'é¡¹åœˆ', 'harness': 'èƒŒå¸¦', 'bowl': 'ç¢—', 'feeder': 'å–‚é£Ÿå™¨',
                                                                                        'food': 'é£Ÿå“', 'treat': 'é›¶é£Ÿ', 'toy': 'ç©å…·', 'bed': 'çª', 'cage': 'ç¬¼å­',
                                                                                        'litter': 'çŒ«ç ‚', 'box': 'ç ‚ç›†', 'brush': 'æ¢³å­', 'clipper': 'æ¨å‰ª', 'shampoo': 'é¦™æ³¢',

                                                                                        // Sports & Outdoors
                                                                                        'sport': 'è¿åŠ¨', 'gym': 'å¥èº«', 'fitness': 'å¥èº«', 'yoga': 'ç‘œä¼½', 'mat': 'å«å­',
                                                                                        'ball': 'çƒ', 'racket': 'çƒæ‹', 'bat': 'çƒæ£’', 'club': 'çƒæ†', 'net': 'ç½‘',
                                                                                        'tent': 'å¸ç¯·', 'camp': 'éœ²è¥', 'bag': 'ç¡è¢‹', 'backpack': 'èƒŒåŒ…', 'light': 'ç¯',
                                                                                        'bike': 'è‡ªè¡Œè½¦', 'cycle': 'éª‘è¡Œ', 'helmet': 'å¤´ç›”', 'lock': 'é”', 'pump': 'æ‰“æ°”ç­’',
                                                                                        'swim': 'æ¸¸æ³³', 'pool': 'æ³³æ± ', 'goggle': 'æ³³é•œ', 'fin': 'è„šè¹¼', 'suit': 'æ³³è¡£',

                                                                                        // Beauty & Personal Care
                                                                                        'beauty': 'ç¾å¦†', 'makeup': 'åŒ–å¦†', 'face': 'é¢éƒ¨', 'eye': 'çœ¼éƒ¨', 'lip': 'å”‡éƒ¨',
                                                                                        'hair': 'å¤´å‘', 'brush': 'åˆ·å­', 'comb': 'æ¢³å­', 'dryer': 'å¹é£æœº', 'iron': 'å·å‘æ£’',
                                                                                        'nail': 'æŒ‡ç”²', 'art': 'è‰ºæœ¯', 'care': 'æŠ¤ç†', 'skin': 'çš®è‚¤', 'cream': 'éœœ',
                                                                                        'shave': 'å‰ƒé¡»', 'razor': 'å‰ƒé¡»åˆ€', 'soap': 'è‚¥çš‚', 'bath': 'æ²æµ´', 'shower': 'æ·‹æµ´',
                                                                                        // Safety & Apparel
                                                                                        'glove': 'æ‰‹å¥—', 'vest': 'èƒŒå¿ƒ', 'jacket': 'å¤¹å…‹', 'coat': 'å¤–å¥—', 'boot': 'é´å­', 'shoe': 'é‹',
                                                                                        'hat': 'å¸½å­', 'cap': 'é¸­èˆŒå¸½', 'sock': 'è¢œå­', 'shirt': 'è¡¬è¡«', 'pant': 'è£¤å­',
                                                                                        'safety': 'å®‰å…¨', 'glass': 'çœ¼é•œ', 'goggle': 'æŠ¤ç›®é•œ', 'protector': 'æŠ¤å…·', 'guard': 'é˜²æŠ¤ç½©',
                                                                                        'face': 'é¢éƒ¨', 'ear': 'è€³éƒ¨', 'knee': 'è†ç›–', 'elbow': 'è‚˜éƒ¨',
                                                                                        // Materials & Adjectives
                                                                                        'steel': 'é’¢', 'metal': 'é‡‘å±', 'wood': 'æœ¨', 'plastic': 'å¡‘æ–™', 'leather': 'çš®é©',
                                                                                        'rubber': 'æ©¡èƒ¶', 'silicone': 'ç¡…èƒ¶', 'glass': 'ç»ç’ƒ', 'ceramic': 'é™¶ç“·',
                                                                                        'electric': 'ç”µåŠ¨', 'manual': 'æ‰‹åŠ¨', 'cordless': 'æ— ç»³', 'pneumatic': 'æ°”åŠ¨',
                                                                                        'portable': 'ä¾¿æº', 'mini': 'è¿·ä½ ', 'heavy': 'é‡å‹', 'duty': 'ä»»åŠ¡', 'pro': 'ä¸“ä¸š',
                                                                                        'waterproof': 'é˜²æ°´', 'resistant': 'è€å—', 'proof': 'é˜²æŠ¤',
                                                                                        'winter': 'å†¬å­£', 'summer': 'å¤å­£', 'thermal': 'ä¿æš–', 'cool': 'å‡‰çˆ½',
                                                                                        'black': 'é»‘', 'white': 'ç™½', 'red': 'çº¢', 'blue': 'è“'
                                                                                    };

                                                                                    // 2. Merge with User Custom Dictionary (from State/LocalStorage)
                                                                                    // To make this work inside map, we rely on the parent state 'customDict' passed down or accessed via closure if defined in App scope.
                                                                                    // Since this map is inside render, we can access 'customDict' if it is in scope.
                                                                                    // Assuming 'customDict' is essentially a JSON object like BASIC_DICT.

                                                                                    const FINAL_DICT = { ...BASIC_DICT, ...customDict };

                                                                                    // Simple Smart Translator
                                                                                    const translateTitle = (text) => {
                                                                                        if (!text) return "";
                                                                                        const words = text.toLowerCase().replace(/[^a-z0-9\s]/g, ' ').split(/\s+/);
                                                                                        const matches = words
                                                                                            .map(w => FINAL_DICT[w] || FINAL_DICT[w.replace(/s$/, '')]) // Handle simple plurals
                                                                                            .filter(Boolean);

                                                                                        if (matches.length === 0) return "";
                                                                                        // Deduplicate and join
                                                                                        return [...new Set(matches)].join(' ');
                                                                                    };

                                                                                    const cnGuess = translateTitle(item.title);

                                                                                    return (
                                                                                        <div key={idx} className="flex flex-col gap-1 text-xs p-2 rounded-lg hover:bg-white transition-colors border border-transparent hover:border-gray-100 group/item">
                                                                                            <div className="flex items-center gap-3">
                                                                                                <span className="font-mono text-gray-400 font-bold bg-white px-2 py-1 rounded border border-gray-100 min-w-[50px] text-center">{item.id}</span>
                                                                                                <span className="text-gray-600 font-medium truncate group-hover/item:text-blue-600 transition-colors" title={item.title}>
                                                                                                    {item.title}
                                                                                                </span>
                                                                                            </div>

                                                                                            {/* BSR & Sales Estimation Badge (Always visible if Rank exists, for comparison) */}
                                                                                            {item.rankValue > 0 && (
                                                                                                <div className="pl-[62px] flex items-center gap-2 mt-1">
                                                                                                    <div className="flex items-center bg-gray-900 text-white text-[9px] rounded-md overflow-hidden shadow-sm">
                                                                                                        <span className="px-1.5 py-0.5 font-bold bg-gray-800 text-gray-400">#</span>
                                                                                                        <span className="px-1.5 py-0.5 font-mono font-bold tracking-tight">{item.rankValue.toLocaleString()}</span>
                                                                                                    </div>
                                                                                                    <span className="text-[9px] font-bold text-orange-500 flex items-center gap-1">
                                                                                                        <span>ğŸª„</span> Est. ${fComm(item.estAnnualSales)}
                                                                                                    </span>
                                                                                                </div>
                                                                                            )}
                                                                                            {/* Chinese Translation Hint */}
                                                                                            {cnGuess && (
                                                                                                <div className="pl-[62px] text-[10px] text-blue-500 font-bold flex items-center gap-1 opacity-80">
                                                                                                    <span className="text-[8px] bg-blue-50 px-1 rounded uppercase">CN</span> {cnGuess}
                                                                                                </div>
                                                                                            )}
                                                                                        </div>
                                                                                    );
                                                                                })}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </details>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>

                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {view === 'coi' && (
                            <div className="max-w-3xl mx-auto space-y-10 animate-in fade-in slide-in-from-bottom-4 duration-700">
                                <button onClick={() => setView('home')} className="text-blue-600 font-bold text-sm flex items-center gap-2">
                                    <span className="text-lg">â†</span> è¿”å›ä¸»é¡µå¯¼èˆª
                                </button>

                                <div className="apple-card p-16 text-center space-y-12 relative overflow-hidden">
                                    <div className="space-y-4">
                                        <div className="w-20 h-20 bg-green-50 rounded-3xl flex items-center justify-center text-4xl mx-auto">ğŸ›¡ï¸</div>
                                        <h3 className="text-4xl font-black tracking-tight">AI ä¿å•åˆè§„é¢„å®¡</h3>
                                        <p className="text-gray-400 text-lg font-medium">æ·±åº¦æ‰«æä¿å•ï¼Œè‡ªåŠ¨æ ¸å¯¹ Amazon $1,000,000 é™é¢è¦æ±‚</p>
                                    </div>

                                    {coiStep === 'idle' ? (
                                        <div onClick={() => { setCoiStep('scanning'); setTimeout(() => setCoiStep('result'), 2500) }} className="group border-2 border-dashed border-gray-100 rounded-[44px] p-24 cursor-pointer hover:border-green-500 hover:bg-green-50/20 transition-all duration-500">
                                            <div className="text-6xl mb-6 grayscale group-hover:grayscale-0 transition-all duration-500">ğŸ“¤</div>
                                            <p className="text-gray-400 font-bold text-lg">ç‚¹å‡»ç‚¹å‡»æˆ–æ‹–æ‹½ COI æ‰«æä»¶ (PDF/JPG)</p>
                                            <p className="text-[10px] text-gray-300 font-black uppercase tracking-widest mt-6">Secure OCR Transmission</p>
                                        </div>
                                    ) : coiStep === 'scanning' ? (
                                        <div className="py-24 relative">
                                            <div className="h-1 bg-green-500 absolute top-0 left-0 w-full animate-pulse"></div>
                                            <p className="text-green-600 font-black text-xl animate-pulse mt-12 tracking-tight">æ­£åœ¨æ ¸å¯¹ Amazon.com Services LLC. åˆè§„æè¿°...</p>
                                            <div className="mt-8 flex justify-center gap-2">
                                                <div className="w-2 h-2 bg-green-200 rounded-full animate-bounce delay-75"></div>
                                                <div className="w-2 h-2 bg-green-300 rounded-full animate-bounce delay-150"></div>
                                                <div className="w-2 h-2 bg-green-400 rounded-full animate-bounce delay-300"></div>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="text-left space-y-8 animate-in fade-in zoom-in-95 duration-500">
                                            <div className="p-8 bg-red-50/50 border border-red-100 rounded-[40px] space-y-4">
                                                <div className="flex items-center gap-3 text-red-600">
                                                    <span className="text-2xl">ğŸš¨</span>
                                                    <h4 className="text-xl font-black tracking-tight">è‡´å‘½åˆè§„é¡¹ç¼ºå¤± (2)</h4>
                                                </div>
                                                <ul className="text-sm text-red-700/80 space-y-4 font-bold ml-9">
                                                    <li className="flex items-start gap-2 leading-relaxed">
                                                        <span className="mt-1.5 w-1.5 h-1.5 bg-red-500 rounded-full shrink-0"></span>
                                                        <span>ä¿é¢ä¸è¶³ï¼šå½“å‰æ ‡å‡†è¦æ±‚å•æ¬¡èµ”ä»˜é™é¢ä¸ä½äº ${fComm(coiRules.find(r => r.id === 'limit')?.value || 1000000)}ã€‚</span>
                                                    </li>
                                                    <li className="flex items-start gap-2 leading-relaxed">
                                                        <span className="mt-1.5 w-1.5 h-1.5 bg-red-500 rounded-full shrink-0"></span>
                                                        <span>é™„åŠ è¢«ä¿é™©äººæè¿°æœ‰è¯¯ï¼šå¿…é¡»åŒ…å« "{coiRules.find(r => r.id === 'holder')?.value || 'Amazon.com Services LLC'}" ç­‰æ³•å®šè¡¨è¿°ã€‚</span>
                                                    </li>
                                                </ul>
                                            </div>

                                            <div className="p-8 bg-green-50/50 border border-green-100 rounded-[40px] flex items-center gap-6">
                                                <div className="w-12 h-12 bg-green-100 rounded-2xl flex items-center justify-center text-xl">âœ…</div>
                                                <div>
                                                    <h4 className="font-black text-green-900 leading-none mb-2">å…èµ”é¢åˆè§„</h4>
                                                    <p className="text-sm text-green-700 font-medium">æ£€æµ‹ç»“æœç¬¦åˆä¸è¶…è¿‡ ${fComm(coiRules.find(r => r.id === 'deductible')?.value || 10000)} ç¾é‡‘çš„é™åº¦è¦æ±‚ã€‚</p>
                                                </div>
                                            </div>

                                            <button className="w-full py-6 bg-gray-900 text-white rounded-[28px] text-lg font-black hover:bg-black transition-all shadow-xl shadow-gray-200" onClick={() => alert('ä¿®æ”¹æ„è§å·²ç”Ÿæˆï¼Œè¯·å‘é€ç»™æ‚¨çš„ä¿é™©ç»çºªã€‚')}>
                                                è·å–ä¸“å®¶ä¿®æ”¹æ„è§
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {view === 'admin' && (
                            <div className="max-w-5xl mx-auto space-y-10 animate-in fade-in duration-700">
                                <button onClick={() => setView('home')} className="text-blue-600 font-bold text-sm">â† è¿”å›ä¸»é¡µå¯¼èˆª</button>
                                <div className="grid md:grid-cols-3 gap-8">
                                    <div className="md:col-span-2 apple-card p-12 space-y-8 border-2 border-blue-500/10">
                                        <h3 className="text-3xl font-black italic">å‚æ•°ç»´æŠ¤ä¸­å¿ƒ</h3>
                                        <div className="grid md:grid-cols-2 gap-8">
                                            <div className="space-y-4">
                                                <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest">æ ‡å‡†æŠ˜ç®—æ±‡ç‡ (USD/CNY)</label>
                                                <input type="number" step="0.01" className="w-full p-6 h-[80px] rounded-[24px] bg-gray-50 border-none font-black text-2xl text-blue-600 outline-none focus:bg-white" value={exRate} onChange={e => setExRate(e.target.value)} />
                                            </div>
                                            <div className="space-y-4">
                                                <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest">åŒæ­¥ MASTER è´¹ç‡åº“ (.xlsx)</label>
                                                <div className="h-[80px] border-2 border-dashed border-gray-100 rounded-[24px] flex items-center justify-center bg-gray-50 relative hover:border-blue-400 transition-all cursor-pointer">
                                                    <input type="file" onChange={handleAdminUpload} className="absolute inset-0 opacity-0 cursor-pointer" />
                                                    <span className="text-sm font-black text-gray-400">ç‚¹å‡»ä¸Šä¼ æŠ¥ä»·è§„åˆ™</span>
                                                </div>
                                            </div>
                                            <div className="space-y-4 md:col-span-2">
                                                <div className="flex justify-between items-center">
                                                    <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest">è‡ªå®šä¹‰ç¿»è¯‘è¯å…¸ (Custom Dictionary)</label>
                                                    <span className="text-[9px] bg-purple-100 text-purple-600 px-2 py-0.5 rounded font-bold">Auto-Learning Active</span>
                                                </div>

                                                <div className="border-2 border-dashed border-gray-200 rounded-[24px] p-6 bg-gray-50/50 group hover:border-purple-400 transition-all space-y-8">

                                                    {/* 1. Smart Discovery Tool (Top) */}
                                                    <div className="space-y-4">
                                                        <div className="flex items-center justify-between">
                                                            <div className="flex items-center gap-3">
                                                                <div className="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 animate-pulse">âœ¨</div>
                                                                <div>
                                                                    <h4 className="text-sm font-black text-gray-800">æœªæ”¶å½•é«˜é¢‘è¯å‘ç° (AI Discovery)</h4>
                                                                    <p className="text-[9px] text-gray-400 font-bold uppercase">ç³»ç»Ÿè‡ªåŠ¨æ‰«æå½“å‰å•†å“åº“ï¼Œæ‰¾å‡ºéœ€ç¿»è¯‘çš„ç”Ÿè¯</p>
                                                                </div>
                                                            </div>
                                                            <span className="text-[9px] text-gray-400 bg-white px-2 py-1 rounded border border-gray-100 shadow-sm">Real-time Analysis</span>
                                                        </div>

                                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                                                            {(() => {
                                                                // Dynamic analysis of unknown words
                                                                const wordCounts = {};
                                                                const ALL_DICT = {
                                                                    ...{
                                                                        // Basic Stop List for simple check
                                                                        ...customDict
                                                                    }
                                                                };

                                                                const KNOWN_ROOTS = new Set([
                                                                    'drill', 'saw', 'grinder', 'sander', 'polisher', 'wrench', 'plier', 'hammer', 'ratchet', 'socket', 'bit', 'blade', 'disc', 'clamp', 'vise', 'tool', 'kit', 'set',
                                                                    'screw', 'bolt', 'nut', 'washer', 'nail', 'hook', 'hinge', 'lock', 'knob', 'handle',
                                                                    'alarm', 'security', 'camera', 'system', 'sensor', 'detector', 'smart', 'wifi', 'battery', 'charger', 'cable', 'cord', 'plug', 'switch', 'led', 'light',
                                                                    'baby', 'diaper', 'wipe', 'bottle', 'stroller', 'crib', 'toy', 'kid', 'pet', 'dog', 'cat', 'leash', 'collar', 'food', 'bowl',
                                                                    'kitchen', 'knife', 'pan', 'pot', 'cup', 'mug', 'fork', 'spoon',
                                                                    'pcs', 'pack', 'pair', 'inch', 'cm', 'mm', 'black', 'white', 'red', 'blue', 'green', 'yellow', 'orange', 'purple', 'gray', 'grey',
                                                                    'and', 'for', 'with', 'the', 'pro', 'max', 'mini', 'plus', 'ultra', 'new', 'old', 'top', 'big', 'small', 'hot'
                                                                ]);

                                                                db.forEach(group => {
                                                                    group.items?.forEach(item => {
                                                                        const words = item.title.toLowerCase().replace(/[^a-z0-9\s]/g, ' ').split(/\s+/);
                                                                        words.forEach(w => {
                                                                            if (w.length > 2 && !KNOWN_ROOTS.has(w) && !KNOWN_ROOTS.has(w.replace(/s$/, '')) && !customDict[w] && isNaN(w)) {
                                                                                wordCounts[w] = (wordCounts[w] || 0) + 1;
                                                                            }
                                                                        });
                                                                    });
                                                                });

                                                                const sorted = Object.entries(wordCounts)
                                                                    .sort(([, a], [, b]) => b - a)
                                                                    .slice(0, 12);

                                                                if (sorted.length === 0) return (
                                                                    <div className="col-span-4 p-4 text-center border border-green-100 rounded-xl bg-green-50/50 flex flex-col items-center justify-center gap-2">
                                                                        <div className="text-xl text-green-500">âœ…</div>
                                                                        <p className="text-xs font-bold text-green-700">å®Œç¾çŠ¶æ€ï¼šæ‰€æœ‰é«˜é¢‘è¯å‡å·²æ”¶å½•</p>
                                                                    </div>
                                                                );

                                                                return sorted.map(([word, count]) => (
                                                                    <button
                                                                        key={word}
                                                                        onClick={() => {
                                                                            const input = prompt(`ã€å¿«é€Ÿå­¦ä¹ ã€‘\nè¯·è¾“å…¥å•è¯ "${word}" çš„ä¸­æ–‡æ„æ€:`, "");
                                                                            if (input) {
                                                                                const newDict = { ...customDict, [word]: input };
                                                                                setCustomDict(newDict);
                                                                                safeSetItem('cgl_custom_dict', newDict);
                                                                            }
                                                                        }}
                                                                        className="flex items-center justify-between bg-white hover:bg-purple-500 hover:text-white group px-3 py-2 rounded-xl border border-gray-200 hover:border-purple-500 transition-all shadow-sm text-left"
                                                                    >
                                                                        <div>
                                                                            <div className="font-bold text-xs">{word}</div>
                                                                            <div className="text-[8px] text-gray-400 group-hover:text-purple-100">Freq: {count}</div>
                                                                        </div>
                                                                        <div className="w-5 h-5 rounded-full bg-gray-50 group-hover:bg-white/20 flex items-center justify-center text-gray-400 group-hover:text-white font-bold text-xs">+</div>
                                                                    </button>
                                                                ));
                                                            })()}
                                                        </div>
                                                    </div>

                                                    <div className="w-full h-[1px] bg-gray-200"></div>

                                                    {/* 2. Manual Edit Area (Bottom) */}
                                                    <div className="space-y-4">
                                                        <div className="flex gap-3 items-start">
                                                            <div className="text-xl">ğŸ“–</div>
                                                            <div>
                                                                <p className="text-xs font-black text-gray-900">æ ¸å¿ƒè¯åº“ç®¡ç† (Manual Dictionary)</p>
                                                                <p className="text-[9px] text-gray-400 font-bold uppercase">æ”¯æŒæ‰¹é‡ç²˜è´´ / æŸ¥çœ‹æ‰€æœ‰è¯æ±‡ (æ ¼å¼: è‹±æ–‡=ä¸­æ–‡)</p>
                                                            </div>
                                                        </div>
                                                        <textarea
                                                            className="w-full h-32 p-4 rounded-xl bg-white border border-gray-200 text-xs font-mono text-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none"
                                                            placeholder="drone=æ— äººæœº&#10;scooter=æ»‘æ¿è½¦"
                                                            value={Object.entries(customDict || {}).map(([k, v]) => `${k}=${v}`).join('\n')}
                                                            onChange={(e) => {
                                                                const text = e.target.value;
                                                                const newDict = {};
                                                                text.split('\n').forEach(line => {
                                                                    const [key, val] = line.split('=');
                                                                    if (key && val) newDict[key.trim().toLowerCase()] = val.trim();
                                                                });
                                                                setCustomDict(newDict);
                                                                safeSetItem('cgl_custom_dict', newDict);
                                                            }}
                                                        />
                                                    </div>

                                                </div>
                                            </div>

                                            <div className="space-y-4 md:col-span-2">
                                                <div className="flex justify-between items-center">
                                                    <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest">ä¸“å®¶çŸ¥è¯†åº“ç®¡ç† (Knowledge Base)</label>
                                                    <button onClick={() => setShowImporter(!showImporter)} className="text-[10px] font-bold text-blue-500 hover:text-blue-700 transition-colors">
                                                        {showImporter ? 'æ”¶èµ·å¯¼å…¥å™¨' : 'å±•å¼€å¯¼å…¥å™¨'}
                                                    </button>
                                                </div>

                                                {/* KB Importer Zone */}
                                                {!showImporter ? (
                                                    <div onClick={() => setShowImporter(true)} className="border-2 border-dashed border-gray-100 rounded-[24px] p-6 bg-gray-50 flex items-center justify-between group hover:border-indigo-400 transition-all cursor-pointer relative">
                                                        <div className="flex gap-6 items-center">
                                                            <div className="text-2xl">ğŸ“š</div>
                                                            <div className="text-left">
                                                                <p className="text-xs font-black text-gray-900">å¯¼å…¥ä¸“å®¶æ ¸ä¿çŸ¥è¯† (.zip)</p>
                                                                <p className="text-[9px] text-gray-400 font-bold uppercase tracking-widest">ä¸€é”®è§£æ Word æ–‡æ¡£ï¼Œæ›´æ–°é£é™©æ´å¯Ÿåº“</p>
                                                            </div>
                                                        </div>
                                                        <span className="px-4 py-2 bg-white border rounded-xl text-[10px] font-black group-hover:bg-indigo-500 group-hover:text-white transition-all shadow-sm">IMPORT</span>
                                                    </div>
                                                ) : (
                                                    <KnowledgeImporter onImportSuccess={() => { refreshDB(); addLog('KB Import', 'æˆåŠŸæ›´æ–°äº†ä¸“å®¶çŸ¥è¯†åº“'); }} />
                                                )}
                                            </div>



                                            <div className="space-y-4 md:col-span-2">
                                                <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest">å®¢æˆ·åˆ†å‘ç®¡ç† (Distribution Settings)</label>
                                                <div className="p-8 bg-blue-600 rounded-[32px] text-white flex justify-between items-center shadow-xl shadow-blue-100">
                                                    <div className="space-y-2">
                                                        <h4 className="text-xl font-bold">å¯¼å‡ºåˆ†å‘ç‰ˆ HTML</h4>
                                                        <p className="text-blue-100 text-xs font-medium">å¯¼å‡ºåï¼Œæ–‡ä»¶å°†å†…ç½®æ‚¨å½“å‰çš„è´¹ç‡åº“é€»è¾‘ã€‚å‘é€ç»™å®¢æˆ·å³å¯ç›´æ¥ä½¿ç”¨ã€‚</p>
                                                    </div>
                                                    <button onClick={downloadDistributionFile} className="px-8 py-4 bg-white text-blue-600 rounded-2xl font-black text-sm hover:bg-blue-50 transition-all">ä¸€é”®å¯¼å‡º</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="apple-card p-10 bg-gray-900 text-white flex flex-col justify-center gap-6">
                                        <div><p className="text-[9px] opacity-40 uppercase font-black">Database Rows</p><p className="text-4xl font-black">{db.length}</p></div>
                                        <div className="h-[1px] bg-white/10 w-full"></div>
                                        <div><p className="text-[9px] opacity-40 uppercase font-black">Audit Entries</p><p className="text-4xl font-black">{logs.length}</p></div>
                                    </div>
                                </div>

                                <div className="log-window no-scrollbar max-h-[400px] overflow-y-auto">
                                    <p className="text-[10px] text-gray-500 mb-8 font-black uppercase text-center border-b border-white/5 pb-4">System Event Log</p>
                                    {logs.map(log => (
                                        <div key={log.id} className="flex justify-between items-center py-4 border-b border-white/5">
                                            <div>
                                                <span className="text-blue-500 font-black text-[9px] tracking-widest uppercase mr-3">{log.type}</span>
                                                <span className="text-white/80 font-medium text-sm">{log.detail}</span>
                                            </div>
                                            <span className="text-white/20 text-[9px] font-mono">{log.time}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>

</html>